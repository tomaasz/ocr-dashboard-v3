<!doctype html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OCR Farm Dashboard v2</title>
    <link rel="icon" type="image/png" href="/static/favicon.png" />
    <link rel="stylesheet" href="/static/dashboard_v2.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Force text selection globally */
      * {
        user-select: text !important;
        -webkit-user-select: text !important;
        -moz-user-select: text !important;
        -ms-user-select: text !important;
      }

      /* Breadcrumb Styles */
      .breadcrumb-container {
        padding: 4px var(--spacing-lg);
        background-color: var(--color-bg-card);
        border-bottom: 1px solid var(--color-border);
        display: flex;
        align-items: center;
        font-size: 0.8rem;
        color: var(--color-text-secondary);
        animation: fadeIn 0.3s ease-in-out;
      }

      .breadcrumb-item {
        display: flex;
        align-items: center;
      }

      .breadcrumb-item:not(:last-child)::after {
        content: ">>";
        margin: 0 var(--spacing-sm);
        color: var(--color-text-tertiary);
        font-size: 0.8em;
      }

      .breadcrumb-item.active {
        color: var(--color-text-primary);
        font-weight: 500;
      }

      /* Make hero not overlap breadcrumb */
      .stats-hero {
        margin-top: 0;
        border-top: none;
      }

      /* Dropdown Styles */
      .dropdown {
        position: relative;
        display: inline-block;
      }

      .dropdown-toggle {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .dropdown-menu {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 4px;
        min-width: 200px;
        background: var(--color-bg-card);
        border: 1px solid var(--color-border);
        border-radius: var(--radius);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-8px);
        transition: opacity 0.15s ease, transform 0.15s ease, visibility 0.15s;
      }

      .dropdown-menu.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .dropdown-item {
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%;
        padding: 10px 14px;
        border: none;
        background: none;
        color: var(--color-text-secondary);
        font-size: 13px;
        text-align: left;
        cursor: pointer;
        transition: background 0.15s ease, color 0.15s ease;
      }

      .dropdown-item:first-child {
        border-radius: var(--radius) var(--radius) 0 0;
      }

      .dropdown-item:last-child {
        border-radius: 0 0 var(--radius) var(--radius);
      }

      .dropdown-item:hover {
        background: var(--color-bg-hover);
        color: var(--color-text-primary);
      }

      .dropdown-item svg {
        flex-shrink: 0;
        opacity: 0.7;
      }

      .dropdown-item:hover svg {
        opacity: 1;
      }

      /* Split Button Dropdown Styles */
      .split-button-dropdown {
        position: relative;
        display: inline-flex;
      }

      .split-button-dropdown .dropdown-menu {
        right: 0;
        left: auto;
      }

      .split-button-main {
        border-top-right-radius: 0 !important;
        border-bottom-right-radius: 0 !important;
        border-right: 1px solid rgba(0, 0, 0, 0.15) !important;
      }

      .split-button-toggle {
        border-top-left-radius: 0 !important;
        border-bottom-left-radius: 0 !important;
        padding-left: 8px !important;
        padding-right: 8px !important;
        min-width: auto !important;
      }

      .split-button-toggle svg {
        transition: transform 0.2s ease;
      }

      .split-button-dropdown .dropdown-menu.show + .split-button-toggle svg,
      .split-button-dropdown:has(.dropdown-menu.show) .split-button-toggle svg {
        transform: rotate(180deg);
      }

      .dropdown-item.selected {
        background: var(--color-bg-hover);
        color: var(--color-primary);
      }

      .dropdown-item.selected svg {
        color: var(--color-primary);
        opacity: 1;
      }

      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }

      /* Hard refresh overlay to avoid unstyled flash */
      body.hard-refreshing {
        overflow: hidden;
      }
      .hard-refresh-overlay {
        position: fixed;
        inset: 0;
        background: #0f172a;
        color: #e2e8f0;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 20000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.15s ease;
      }
      .hard-refresh-overlay.show {
        display: flex;
        opacity: 1;
        pointer-events: auto;
      }
      .hard-refresh-box {
        text-align: center;
      }
      .hard-refresh-spinner {
        width: 56px;
        height: 56px;
        border: 4px solid rgba(148, 163, 184, 0.4);
        border-top-color: #38bdf8;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 18px;
      }
      
      /* Input Group Styles */
      .input-group {
        display: flex;
        gap: 4px;
        align-items: stretch;
      }
      
      .input-group .compact-form-input {
        flex: 1;
        min-width: 0;
      }
      
      .input-group .btn {
        flex-shrink: 0;
        padding: 6px 10px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .input-group .btn svg {
        display: block;
      }

      /* Table sorting + filtering */
      .table thead th.table-sortable {
        cursor: pointer;
        position: relative;
        padding-right: 20px;
        user-select: none;
      }

      .table thead th.table-sortable::after {
        content: "↕";
        position: absolute;
        right: 6px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 10px;
        opacity: 0.45;
      }

      .table thead th.table-sortable.sorted-asc::after {
        content: "↑";
        opacity: 0.9;
      }

      .table thead th.table-sortable.sorted-desc::after {
        content: "↓";
        opacity: 0.9;
      }

      .table thead tr.table-filter-row th {
        padding: 6px 8px;
      }

      .table-filter-input,
      .table-filter-select {
        width: 100%;
        min-width: 0;
        font-size: 11px;
        padding: 4px 6px;
        border-radius: 6px;
        border: 1px solid var(--color-border);
        background: var(--color-bg-secondary);
        color: var(--color-text-primary);
      }
    </style>
    <script>
      // XSS Protection Helper
      function escapeHtml(text) {
        if (text == null) return "";
        return String(text)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function formatDateTimeCell(value) {
        if (!value || value === "-") {
          return "<span>-</span>";
        }
        const rawText = String(value);
        const parts = rawText.split(" ");
        if (parts.length >= 2) {
          const datePart = escapeHtml(parts[0]);
          const timePart = escapeHtml(parts.slice(1).join(" "));
          return `
            <div style="display: flex; flex-direction: column; gap: 2px; font-size: 0.85em; line-height: 1.3;">
              <span style="font-weight: 500;">${datePart}</span>
              <span style="color: var(--color-text-tertiary);">${timePart}</span>
            </div>
          `;
        }
        return `<span>${escapeHtml(rawText)}</span>`;
      }

      const LIMIT_WORKER_URL = JSON.parse('{{ limit_worker_url | tojson | safe }}') || "http://100.102.158.100:8001";
    </script>
  </head>

  <body>
    <div class="hard-refresh-overlay" id="hardRefreshOverlay" aria-live="polite">
      <div class="hard-refresh-box">
        <div class="hard-refresh-spinner"></div>
        <div>Odświeżanie strony…</div>
      </div>
    </div>
    <div class="app-layout" id="appLayout">
      <!-- Sidebar -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-logo">OCR</div>
          <span class="sidebar-title">Farm Dashboard</span>
        </div>

        <nav class="sidebar-nav">
          <div class="nav-section">
            <div class="nav-section-title" data-i18n="nav.menu">Menu</div>
            <button
              class="nav-item active"
              data-tab="overview"
              onclick="switchTab('overview')"
            >
              <span class="nav-item-icon">
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <rect x="3" y="3" width="7" height="7" rx="1" />
                  <rect x="14" y="3" width="7" height="7" rx="1" />
                  <rect x="3" y="14" width="7" height="7" rx="1" />
                  <rect x="14" y="14" width="7" height="7" rx="1" />
                </svg>
              </span>
              <span class="nav-item-text" data-i18n="nav.overview"
                >Przegląd</span
              >
            </button>
            <button
              class="nav-item"
              data-tab="profiles"
              onclick="switchTab('profiles')"
            >
              <span class="nav-item-icon">
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                  <circle cx="9" cy="7" r="4" />
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                  <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                </svg>
              </span>
              <span class="nav-item-text" data-i18n="nav.profiles"
                >Profile</span
              >
              <span class="nav-item-badge" id="profileCount"
                >{{ profiles|length }}</span
              >
            </button>
            <button
              class="nav-item"
              data-tab="preview"
              onclick="switchTab('preview')"
            >
              <span class="nav-item-icon">
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                  <circle cx="8.5" cy="8.5" r="1.5" />
                  <polyline points="21 15 16 10 5 21" />
                </svg>
              </span>
              <span class="nav-item-text" data-i18n="nav.preview">Podgląd</span>
            </button>
            <button class="nav-item" data-tab="logs" onclick="switchTab('logs')">
              <span class="nav-item-icon">
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                  />
                  <polyline points="14 2 14 8 20 8" />
                  <line x1="16" y1="13" x2="8" y2="13" />
                  <line x1="16" y1="17" x2="8" y2="17" />
                </svg>
              </span>
              <span class="nav-item-text" data-i18n="nav.logs">Logi</span>
            </button>
            <button
              class="nav-item"
              data-tab="services"
              onclick="switchTab('services')"
            >
              <span class="nav-item-icon">
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M3 12h18" />
                  <path d="M7 6h10" />
                  <path d="M7 18h10" />
                </svg>
              </span>
              <span class="nav-item-text">Serwisy</span>
            </button>
            <button class="nav-item" data-tab="limits" onclick="switchTab('limits')">
              <span class="nav-item-icon">
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"
                  />
                </svg>
              </span>
              <span class="nav-item-text" data-i18n="nav.limits">Limity</span>
            </button>
            <button
              class="nav-item"
              data-tab="postprocess"
              onclick="switchTab('postprocess')"
            >
              <span class="nav-item-icon">
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"
                  />
                </svg>
              </span>
              <span class="nav-item-text" data-i18n="nav.postprocess"
                >Post-Process</span
              >
            </button>

            <button
              class="nav-item"
              data-tab="jobconfig"
              onclick="switchTab('jobconfig')"
            >
              <span class="nav-item-icon">
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <polygon points="5 3 19 12 5 21 5 3" />
                </svg>
              </span>
              <span class="nav-item-text" data-i18n="nav.jobconfig"
                >Start Job</span
              >
            </button>
            <button
              class="nav-item"
              data-tab="settings"
              onclick="switchTab('settings')"
            >
              <span class="nav-item-icon">
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <circle cx="12" cy="12" r="3" />
                  <path
                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
                  />
                </svg>
              </span>
              <span class="nav-item-text" data-i18n="nav.settings"
                >Ustawienia</span
              >
            </button>
          </div>

          <div class="nav-section">
            <div class="nav-section-title" data-i18n="nav.quickStatus">
              Szybki status
            </div>
            <div class="quick-status">
              <div class="quick-status-row mb-sm">
                <span
                  class="quick-status-icon quick-status-icon-success"
                  aria-hidden="true"
                ></span>
                <span
                  class="quick-status-label text-secondary"
                  data-i18n="nav.active"
                  >Aktywne</span
                >
                <span
                  class="quick-status-count font-bold text-success"
                  id="sidebarActiveCount"
                  >0</span
                >
              </div>
              <div class="quick-status-row mb-sm">
                <span
                  class="quick-status-icon quick-status-icon-warning"
                  aria-hidden="true"
                ></span>
                <span
                  class="quick-status-label text-secondary"
                  data-i18n="nav.paused"
                  >Wstrzymane</span
                >
                <span
                  class="quick-status-count font-bold text-warning"
                  id="sidebarPausedCount"
                  >0</span
                >
              </div>
              <div class="quick-status-row mb-sm">
                <span
                  class="quick-status-icon quick-status-icon-error"
                  aria-hidden="true"
                ></span>
                <span
                  class="quick-status-label text-secondary"
                  data-i18n="nav.limit"
                  >Limit</span
                >
                <span
                  class="quick-status-count font-bold text-error"
                  id="sidebarLimitCount"
                  >0</span
                >
              </div>
              <div class="quick-status-row">
                <span
                  class="quick-status-icon quick-status-icon-info"
                  aria-hidden="true"
                ></span>
                <span
                  class="quick-status-label text-secondary"
                  data-i18n="nav.todayScans"
                  >Dzisiejsze skany</span
                >
                <span
                  class="quick-status-count font-bold text-info"
                  id="sidebarTodayScans"
                  >0</span
                >
              </div>
            </div>
          </div>
        </nav>

        <div class="sidebar-footer">
          <button class="sidebar-toggle" onclick="toggleSidebar()">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polyline points="11 17 6 12 11 7" />
              <polyline points="18 17 13 12 18 7" />
            </svg>
            <span class="nav-item-text" data-i18n="nav.collapse">Zwiń</span>
          </button>
        </div>
      </aside>

      <!-- Header -->
      <header class="header">
        <button
          class="btn btn-ghost btn-icon mobile-menu-btn"
          onclick="toggleSidebar()"
          style="display: none"
        >
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <line x1="3" y1="12" x2="21" y2="12" />
            <line x1="3" y1="6" x2="21" y2="6" />
            <line x1="3" y1="18" x2="21" y2="18" />
          </svg>
        </button>

        <!-- Connection Status Indicator -->
        <div
          class="connection-status"
          id="connectionStatus"
          title="Połączenie z serwerem"
        >
          <span class="connection-dot connected"></span>
        </div>

        <!-- Stats removed from header -->

        <div class="header-actions">
          <!-- Auto-restart Toggle -->
          <label
            class="checkbox-label"
            style="
              font-size: 13px;
              margin-right: var(--spacing-md);
              cursor: pointer;
              user-select: none;
            "
            title="Automatycznie restartuj workery po wystąpieniu błędów"
          >
            <input
              type="checkbox"
              id="autoRestartToggle"
              onchange="toggleAutoRestart(this.checked)"
              checked
            />
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              style="vertical-align: middle; margin-right: 4px"
            >
              <path d="M21 2v6h-6" />
              <path d="M3 12a9 9 0 0 1 15-6.7L21 8" />
              <path d="M3 22v-6h6" />
              <path d="M21 12a9 9 0 0 1-15 6.7L3 16" />
            </svg>
            <span style="vertical-align: middle">Auto-restart</span>
          </label>
          <div class="header-actions-divider"></div>

          <button
            class="btn btn-primary btn-sm"
            id="startStopBtn"
            onclick="switchTab('jobconfig')"
            title="Konfiguracja i Start"
            type="button"
          >
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polygon points="5 3 19 12 5 21 5 3" />
            </svg>
            <span>Start Job</span>
          </button>
          <button
            class="btn btn-secondary btn-sm"
            onclick="hardRefreshNoCache()"
            title="Odśwież stronę (bez cache)"
            id="refreshDataBtn"
          >
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              id="refreshIcon"
            >
              <polyline points="23 4 23 10 17 10" />
              <polyline points="1 20 1 14 7 14" />
              <path
                d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"
              />
            </svg>
            Odśwież stronę
          </button>
          <div class="header-actions-divider"></div>
          <div class="split-button-dropdown" id="restartDropdown">
            <button
              class="btn btn-warning btn-sm split-button-main"
              onclick="restartAppConfirm()"
              title="Zrestartuj (ostatnia opcja)"
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M21 2v6h-6" />
                <path d="M3 12a9 9 0 0 1 15-6.7L21 8" />
                <path d="M3 22v-6h6" />
                <path d="M21 12a9 9 0 0 1-15 6.7L3 16" />
              </svg>
              <span id="restartButtonLabel">Restart</span>
            </button>
            <button
              class="btn btn-warning btn-sm split-button-toggle"
              onclick="toggleRestartDropdown(event)"
              title="Wybierz zakres restartu"
            >
              <svg
                width="12"
                height="12"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <polyline points="6 9 12 15 18 9" />
              </svg>
            </button>
            <div class="dropdown-menu" id="restartDropdownMenu">
              <button class="dropdown-item" onclick="setRestartOption('all')" title="Zatrzymaj i uruchom ponownie całą aplikację (Web i Workery)">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10" />
                  <path d="M12 6v6l4 2" />
                </svg>
                <span>Wszystko</span>
              </button>
              <button class="dropdown-item" onclick="setRestartOption('web')" title="Restartuje tylko interfejs webowy (nie przerywa zadań)">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="2" y="3" width="20" height="14" rx="2" ry="2" />
                  <line x1="8" y1="21" x2="16" y2="21" />
                  <line x1="12" y1="17" x2="12" y2="21" />
                </svg>
                <span>Serwer Web</span>
              </button>
              <button class="dropdown-item" onclick="setRestartOption('workers')" title="Restartuje procesy przetwarzania w tle">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                  <circle cx="9" cy="7" r="4" />
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                  <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                </svg>
                <span>Workery</span>
              </button>
              <div style="height: 1px; background: var(--color-border); margin: 4px 0;"></div>
              <button class="dropdown-item" onclick="setRestartOption('cleanup')" title="Tylko usuń pliki tymczasowe (logs, jobs) bez restartu">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                   <polyline points="3 6 5 6 21 6" />
                   <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                </svg>
                <span>Cleanup</span>
              </button>
              <button class="dropdown-item" onclick="setRestartOption('all_clean')" title="Wyczyść pliki tymczasowe i zrestartuj całą aplikację">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6" />
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87" transform="scale(0.8) translate(10, 10)" />
                  <path d="M16 3.13a4 4 0 0 1 0 7.75" transform="scale(0.8) translate(10, 10)" />
                </svg>
                <span>Full Reset (Clean)</span>
              </button>
            </div>
          </div>
          <button
            class="btn btn-secondary btn-sm"
            onclick="openCleanupModal()"
            title="Wyczyść foldery"
          >
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polyline points="3 6 5 6 21 6" />
              <path
                d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
              />
            </svg>
            Cleanup
          </button>
          <div class="header-actions-divider"></div>
          <div class="lang-switcher">
            <button
              class="lang-btn active"
              data-lang="pl"
              onclick="setLanguage('pl')"
              title="Polski"
            >
              PL
            </button>
            <button
              class="lang-btn"
              data-lang="en"
              onclick="setLanguage('en')"
              title="English"
            >
              EN
            </button>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Breadcrumb Navigation -->
        <div id="breadcrumb" class="breadcrumb-container">
          <span class="breadcrumb-item">Menu</span>
          <span class="breadcrumb-item active" id="breadcrumbCurrent"
            >Przegląd</span
          >
        </div>
        <!-- Command Center Hero -->
        <div class="stats-hero">
          <div class="stats-hero-container">
            <!-- Status Group -->
            <div class="hero-group">
              <div class="hero-card hero-card-success">
                <div class="hero-label" data-i18n="header.active">
                  AKTYWNYCH
                </div>
                <div class="hero-value" id="headerActiveProfiles">0</div>
              </div>
              <div class="hero-card hero-card-warning">
                <div class="hero-label" data-i18n="header.paused">
                  WSTRZYMANYCH
                </div>
                <div class="hero-value" id="headerPausedProfiles">0</div>
              </div>
              <div class="hero-card hero-card-error">
                <div class="hero-label" data-i18n="header.limit">LIMIT</div>
                <div class="hero-value" id="headerLimitProfiles">0</div>
              </div>
            </div>

            <!-- Primary Metric (Center) -->
            <div class="hero-group hero-group-main">
              <div class="hero-card hero-card-primary">
                <div class="hero-icon-wrapper">
                  <svg
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <rect
                      x="3"
                      y="4"
                      width="18"
                      height="18"
                      rx="2"
                      ry="2"
                    ></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                  </svg>
                </div>
                <div class="hero-main-content">
                  <div class="hero-label" data-i18n="header.today">
                    DZISIEJSKE SKANY
                  </div>
                  <div class="hero-value hero-value-lg" id="headerTodayScans">
                    0
                  </div>
                  <div style="font-size: 0.75rem; color: var(--color-text-secondary); margin-top: 4px;">
                    Od reset: <span id="headerSinceResetScans">0</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Info Group -->
            <div class="hero-group">
              <div class="hero-card hero-card-neutral">
                <div class="hero-label" data-i18n="header.proEst">
                  EST. CZAS
                </div>
                <div class="hero-value" id="headerProRemaining">-</div>
              </div>
              <div class="hero-card hero-card-neutral">
                <div class="hero-label" data-i18n="header.batch">BATCH</div>
                <div class="hero-value code-font" id="headerBatchId">-</div>
              </div>
            </div>
          </div>
        </div>
        <!-- Overview Tab -->
        <div class="tab-panel active" id="tab-overview">
          <div class="page-header">
            <div>
              <h1 class="page-title">Overview</h1>
              <p class="page-subtitle">Podsumowanie stanu farmy OCR</p>
            </div>
            <div class="flex gap-sm">
              <span class="text-secondary" style="font-size: 12px">
                Ostatnia aktualizacja: <span id="lastUpdate">-</span>
              </span>
            </div>
          </div>

          <!-- Stats Grid -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon blue">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                  <circle cx="9" cy="7" r="4" />
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                  <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                </svg>
              </div>
              <div class="stat-content">
                <div class="stat-value" id="statTotalProfiles">
                  {{ profiles|length }}
                </div>
                <div class="stat-label">Wszystkich profili</div>
              </div>
            </div>

            <div class="stat-card">
              <div class="stat-icon green">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
                </svg>
              </div>
              <div class="stat-content">
                <div class="stat-value" id="statActiveWorkers">0</div>
                <div class="stat-label">Aktywnych workerów</div>
              </div>
            </div>

            <div class="stat-card">
              <div class="stat-icon cyan">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                  <circle cx="8.5" cy="8.5" r="1.5" />
                  <polyline points="21 15 16 10 5 21" />
                </svg>
              </div>
              <div class="stat-content">
                <div class="stat-value" id="statTodayProcessed">0</div>
                <div class="stat-label">Przetworzonych dziś</div>
              </div>
            </div>

            <div class="stat-card">
              <div class="stat-icon yellow">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <circle cx="12" cy="12" r="10" />
                  <polyline points="12 6 12 12 16 14" />
                </svg>
              </div>
              <div class="stat-content">
                <div class="stat-value" id="statAvgTime">-</div>
                <div class="stat-label">Śr. czas/skan</div>
              </div>
            </div>

            <div class="stat-card">
              <div class="stat-icon red">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"
                  />
                  <line x1="12" y1="9" x2="12" y2="13" />
                  <line x1="12" y1="17" x2="12.01" y2="17" />
                </svg>
              </div>
              <div class="stat-content">
                <div class="stat-value" id="statErrors">0</div>
                <div class="stat-label">Błędów</div>
              </div>
            </div>
          </div>

          <!-- Quick Overview Cards -->
          <div class="overview-grid">
            <!-- Recent Activity -->
            <div class="card host-load-card">
              <div class="card-header">
                <h3 class="card-title">Ostatnia aktywność</h3>
                <button
                  class="btn btn-ghost btn-sm"
                  onclick="switchTab('preview')"
                >
                  Zobacz wszystko
                </button>
              </div>
              <div
                class="card-body"
                style="max-height: 300px; overflow-y: auto"
              >
                <div id="recentActivityList">
                  <div class="empty-state">
                    <div class="empty-icon">...</div>
                    <p class="empty-message">Brak ostatniej aktywności</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Profile Status Summary -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Status profili</h3>
                <button
                  class="btn btn-ghost btn-sm"
                  onclick="switchTab('profiles')"
                >
                  Zarządzaj
                </button>
              </div>
              <div class="card-body">
                <div id="profileStatusSummary">
                  <div style="margin-bottom: var(--spacing-md)">
                    <div class="flex justify-between mb-sm">
                      <span class="text-secondary">Aktywne</span>
                      <span class="font-bold" id="summaryActive">0</span>
                    </div>
                    <div class="progress">
                      <div
                        class="progress-bar success"
                        id="progressActive"
                        style="width: 0%"
                      ></div>
                    </div>
                  </div>
                  <div style="margin-bottom: var(--spacing-md)">
                    <div class="flex justify-between mb-sm">
                      <span class="text-secondary">Wstrzymane</span>
                      <span class="font-bold" id="summaryPaused">0</span>
                    </div>
                    <div class="progress">
                      <div
                        class="progress-bar warning"
                        id="progressPaused"
                        style="width: 0%"
                      ></div>
                    </div>
                  </div>
                  <div style="margin-bottom: var(--spacing-md)">
                    <div class="flex justify-between mb-sm">
                      <span class="text-secondary">Limit osiągnięty</span>
                      <span class="font-bold" id="summaryLimit">0</span>
                    </div>
                    <div class="progress">
                      <div
                        class="progress-bar error"
                        id="progressLimit"
                        style="width: 0%"
                      ></div>
                    </div>
                  </div>
                  <div>
                    <div class="flex justify-between mb-sm">
                      <span class="text-secondary">Idle</span>
                      <span class="font-bold" id="summaryIdle">0</span>
                    </div>
                    <div class="progress">
                      <div
                        class="progress-bar"
                        id="progressIdle"
                        style="width: 0%; background: var(--color-idle)"
                      ></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Remote Host Load -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Obciążenie Hostów</h3>
                <button
                  class="btn btn-ghost btn-sm"
                  onclick="switchTab('settings')"
                >
                  Konfiguruj
                </button>
              </div>
              <div class="card-body">
                <div id="hostLoadSummary">
                  <div class="empty-state">
                    <div class="empty-icon">...</div>
                    <p class="empty-message">Ładowanie informacji o hostach...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Profiles Tab -->
        <div class="tab-panel" id="tab-profiles">
          <div class="page-header">
            <div>
              <h1 class="page-title">Profile</h1>
              <p class="page-subtitle">
                Zarządzaj profilami OCR (<span id="profilesVisibleCount"
                  >0</span
                >
                z {{ profiles|length }})
                <span class="profiles-worker-summary">
                  • Workery: <span id="profilesWorkersInit">0</span> init,
                  <span id="profilesWorkersPrompt">0</span> prompt
                </span>
              </p>
            </div>
          </div>

          {% set ns = namespace(has_default=false) %}
          {% for profile in profiles %}
            {% if profile.name == "default" %}
              {% set ns.has_default = true %}
            {% endif %}
          {% endfor %}

          <!-- Toolbar -->
          <div class="profiles-toolbar">
            <div class="search-box">
              <svg
                class="search-icon"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <circle cx="11" cy="11" r="8" />
                <line x1="21" y1="21" x2="16.65" y2="16.65" />
              </svg>
              <input
                type="text"
                class="search-input"
                id="profileSearch"
                placeholder="Szukaj profilu..."
                oninput="filterProfiles()"
              />
            </div>

            <div class="filter-group">
              <button
                class="filter-btn active"
                data-filter="all"
                onclick="setFilter('all')"
              >
                Wszystkie <span class="count" id="filterAllCount">0</span>
              </button>
              <button
                class="filter-btn"
                data-filter="active"
                onclick="setFilter('active')"
              >
                Aktywne <span class="count" id="filterActiveCount">0</span>
              </button>
              <button
                class="filter-btn"
                data-filter="paused"
                onclick="setFilter('paused')"
              >
                Wstrzymane <span class="count" id="filterPausedCount">0</span>
              </button>
              <button
                class="filter-btn"
                data-filter="limit"
                onclick="setFilter('limit')"
              >
                Limit <span class="count" id="filterLimitCount">0</span>
              </button>
              <button
                class="filter-btn"
                data-filter="idle"
                onclick="setFilter('idle')"
              >
                Idle <span class="count" id="filterIdleCount">0</span>
              </button>
            </div>

            <div
              style="margin-left: auto; display: flex; gap: var(--spacing-sm); align-items: center;"
            >
              <!-- Manual Headed Mode Toggle -->
              <label class="checkbox-label" data-i18n-title="profiles.headedModeTooltip" style="margin-bottom: 0;">
                  <input type="checkbox" id="manualHeadedMode">
                  <span style="font-size: 13px;" data-i18n="profiles.headedMode">Headed (dla nowych)</span>
              </label>

              <!-- View Toggle -->
              <div class="view-toggle">
                <button
                  class="view-toggle-btn"
                  data-view="grid"
                  onclick="setViewMode('grid')"
                  title="Widok siatki"
                >
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <rect x="3" y="3" width="7" height="7" />
                    <rect x="14" y="3" width="7" height="7" />
                    <rect x="3" y="14" width="7" height="7" />
                    <rect x="14" y="14" width="7" height="7" />
                  </svg>
                </button>
                <button
                  class="view-toggle-btn active"
                  data-view="table"
                  onclick="setViewMode('table')"
                  title="Widok tabeli"
                >
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <line x1="8" y1="6" x2="21" y2="6" />
                    <line x1="8" y1="12" x2="21" y2="12" />
                    <line x1="8" y1="18" x2="21" y2="18" />
                    <line x1="3" y1="6" x2="3.01" y2="6" />
                    <line x1="3" y1="12" x2="3.01" y2="12" />
                    <line x1="3" y1="18" x2="3.01" y2="18" />
                  </svg>
                </button>
              </div>

              {% if ns.has_default %}
              <button
                class="btn btn-secondary btn-sm"
                id="hideDefaultProfileBtn"
                onclick="hideDefaultProfile()"
              >
                Ukryj default
              </button>
              {% endif %}
            </div>
          </div>

          <!-- Profiles Grid -->
          <div class="profiles-grid hidden" id="profilesGrid">
            {% for profile in profiles %}
            <div
              class="profile-card status-{{ profile.status or 'idle' }}"
              data-profile="{{ profile.name }}"
              data-status="{{ profile.status or 'idle' }}"
            >
              <div class="profile-card-header">
                <input
                  type="checkbox"
                  class="profile-checkbox hidden"
                  data-profile="{{ profile.name }}"
                />
                <div class="profile-info">
                  <h4 class="profile-name" title="{{ profile.name }}">
                    {{ profile.name }}
                  </h4>
                  <div class="profile-status-row">
                    <span
                      class="profile-status {{ profile.status or 'idle' }}"
                      title="{{ profile.critical_message or '' }}"
                    >
                      {% if profile.status == 'active' %}
                      <span
                        style="
                          width: 6px;
                          height: 6px;
                          background: currentColor;
                          border-radius: 50%;
                          animation: pulse 2s infinite;
                        "
                      ></span>
                      {% endif %} {{ profile.status_label or profile.status or
                      'IDLE' }}
                    </span>
                    <span
                      class="profile-headed-badge{% if profile.headed %} visible{% endif %}"
                    >
                      Headed
                    </span>
                    <span
                      class="badge badge-warning profile-alert-badge{% if profile.critical_requires_action %} visible{% endif %}"
                      title="{{ profile.critical_message or '' }}"
                    >
                      Popup
                    </span>
                    <span
                      class="badge badge-warning profile-prompt-badge{% if profile.prompt_blocked %} visible{% endif %}"
                      title="{{ profile.last_error or '' }}"
                    >
                      Prompt?
                    </span>
                    {% if profile.current_worker %}
                    <span class="profile-worker"
                      >Worker {{ profile.current_worker }}</span
                    >
                    {% endif %}
                  </div>
                </div>
              </div>
              <div class="profile-card-body">
                <div class="profile-stats">
                  <div class="profile-stat">
                    <div class="profile-stat-value">
                      {{ profile.processed or 0 }}
                    </div>
                    <div class="profile-stat-label">Przetw.</div>
                  </div>
                  <div class="profile-stat">
                    <div class="profile-stat-value">
                      {{ profile.tokens_k or 0 }}k
                    </div>
                    <div class="profile-stat-label">Tokeny</div>
                  </div>
                  <div class="profile-stat">
                    <div class="profile-stat-value">
                      {{ profile.errors or 0 }}
                    </div>
                    <div class="profile-stat-label">Błędy</div>
                  </div>
                </div>
                {% if profile.last_activity %}
                <div class="profile-activity">
                  {% if profile.status == 'active' %}
                  <span class="profile-activity-dot"></span>
                  {% endif %}
                  <span>{{ profile.last_activity }}</span>
                </div>
                {% endif %}
              </div>
              <div class="profile-card-mode">
                <select
                  class="execution-mode-select"
                  data-profile="{{ profile.name }}"
                  onchange="updateExecutionMode('{{ profile.name }}', this.value)"
                >
                  <option value="local">Local</option>
                  <!-- Options populated dynamically -->
                </select>
              </div>
              <div class="profile-card-actions">
                {% if profile.status == 'active' %}
                <button
                  class="profile-action-btn danger"
                  onclick="stopProfile('{{ profile.name }}')"
                  title="Zatrzymaj"
                >
                  Stop
                </button>
                {% else %}
                <button
                  class="profile-action-btn primary"
                  onclick="startProfile('{{ profile.name }}')"
                  title="Uruchom"
                >
                  Start
                </button>
                {% endif %}
                <button
                  class="profile-action-btn"
                  onclick="toggleHeaded('{{ profile.name }}')"
                  title="{% if profile.headed %}Przełącz na headless{% else %}Przełącz na headed{% endif %}"
                >
                  {% if profile.headed %}Headed{% else %}Headless{% endif %}
                </button>
                <button
                  class="profile-action-btn"
                  onclick="loginProfile('{{ profile.name }}')"
                  title="Zaloguj"
                >
                  Login
                </button>
                <button
                  class="profile-action-btn"
                  onclick="showProfileDetails('{{ profile.name }}')"
                  title="Szczegóły"
                >
                  Info
                </button>
                <button
                  class="profile-action-btn"
                  onclick="resetProfileConfirm('{{ profile.name }}')"
                  title="Reset profilu"
                >
                  Reset
                </button>
                {% if profile.name == "default" %}
                <button class="profile-action-btn danger" disabled title="Nie można usunąć profilu domyślnego">
                  Del
                </button>
                {% else %}
                <button
                  class="profile-action-btn danger"
                  onclick="deleteProfileConfirm('{{ profile.name }}')"
                  title="Usuń"
                >
                  Del
                </button>
                {% endif %}
              </div>
            </div>
            {% endfor %}
          </div>

          <!-- Profiles Table View -->
          <div class="table-container" id="profilesTable">
            <table class="table">
              <thead>
                <tr>
                  <th style="width: 40px" title="Zaznacz wszystkie">
                    <input
                      type="checkbox"
                      id="selectAllTable"
                      onchange="toggleSelectAll()"
                    />
                  </th>
                  <th class="table-sortable" data-sort-col="1" title="Nazwa profilu">Prof</th>
                  <th class="table-sortable" data-sort-col="2" style="width: 70px" title="Status profilu">St</th>
                  <th class="table-sortable" data-sort-col="3" style="width: 190px" title="Tryb wykonania">Mode</th>
                  <th class="table-sortable" data-sort-col="4" style="width: 70px" title="Okienka / Workery">Wk</th>
                  <th class="table-sortable" data-sort-col="5" style="width: 55px; padding-left: 12px" title="Przetworzone">Done</th>
                  <th class="table-sortable" data-sort-col="6" style="width: 55px" title="Tokeny (k)">Tok</th>
                  <th class="table-sortable" data-sort-col="7" style="width: 50px" title="Liczba błędów">Err</th>
                  <th class="table-sortable" data-sort-col="8" title="Data i godzina ostatniego błędu">Err@</th>
                  <th class="table-sortable" data-sort-col="9" title="Data i godzina ostatniej aktywności">Act@</th>
                  <th class="table-sortable" data-sort-col="10" title="Czas resetu limitu (jeśli dostępny)">LmtRst</th>
                  <th class="table-sortable" data-sort-col="11" title="Godzina ostatniego startu">Start</th>
                  <th style="width: 120px" title="Akcje profilu">Act</th>
                </tr>
                <tr class="table-filter-row">
                  <th></th>
                  <th>
                    <input class="table-filter-input" data-col="1" placeholder="Filtr..." />
                  </th>
                  <th>
                    <select class="table-filter-select" data-col="2">
                      <option value="">Wszystkie</option>
                      <option value="active">Aktywne</option>
                      <option value="paused">Wstrzymane</option>
                      <option value="limit">Limit</option>
                      <option value="idle">Idle</option>
                      <option value="starting">Startuje</option>
                      <option value="stopping">Zatrzymuje</option>
                      <option value="error">Błąd</option>
                      <option value="crashed">Awaria</option>
                      <option value="terminated">Zakończone</option>
                    </select>
                  </th>
                  <th>
                    <input class="table-filter-input" data-col="3" placeholder="Filtr..." />
                  </th>
                  <th>
                    <input class="table-filter-input" data-col="4" placeholder="np. 4/4" />
                  </th>
                  <th>
                    <input class="table-filter-input" data-col="5" placeholder="np. 10" />
                  </th>
                  <th>
                    <input class="table-filter-input" data-col="6" placeholder="np. 12k" />
                  </th>
                  <th>
                    <input class="table-filter-input" data-col="7" placeholder="np. 0" />
                  </th>
                  <th>
                    <input class="table-filter-input" data-col="8" placeholder="YYYY-MM-DD" />
                  </th>
                  <th>
                    <input class="table-filter-input" data-col="9" placeholder="YYYY-MM-DD" />
                  </th>
                  <th>
                    <input class="table-filter-input" data-col="10" placeholder="YYYY-MM-DD" />
                  </th>
                  <th>
                    <input class="table-filter-input" data-col="11" placeholder="HH:MM" />
                  </th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for profile in profiles %}
                <tr
                  class="profile-row"
                  data-profile="{{ profile.name }}"
                  data-status="{{ profile.status or 'idle' }}"
                  data-last-error="{{ profile.last_error or '-' }}"
                  data-last-activity="{{ profile.last_activity or '-' }}"
                  data-last-start="{{ profile.last_start or '' }}"
                  data-workers-init="{{ profile.workers_initialized or 0 }}"
                  data-workers-prompt="{{ profile.workers_prompt_sent or 0 }}"
                  data-processed="{{ profile.processed or 0 }}"
                  data-tokens-k="{{ profile.tokens_k or 0 }}"
                  data-errors="{{ profile.errors or 0 }}"
                  data-proxy="{{ profile.proxy or '-' }}"
                  data-limit-reset="{{ profile.limit_reset or '-' }}"
                >
                  <td>
                    <input
                      type="checkbox"
                      class="profile-checkbox-table"
                      data-profile="{{ profile.name }}"
                    />
                  </td>
                  <td>
                    <span class="font-medium">{{ profile.name }}</span>
                  </td>
                  <td>
                    <div class="status-cell">
                      <span
                        class="badge badge-{{ 'success' if profile.status == 'active' else 'warning' if profile.status == 'paused' else 'error' if profile.status == 'limit' else 'neutral' }}"
                        title="{{ profile.critical_message or '' }}"
                      >
                        {{ profile.status_label or profile.status or 'IDLE' }}
                      </span>
                      <span
                        class="badge badge-info profile-headed-badge{% if profile.headed %} visible{% endif %}"
                      >
                        Headed
                      </span>
                      <span
                        class="badge badge-warning profile-alert-badge{% if profile.critical_requires_action %} visible{% endif %}"
                        title="{{ profile.critical_message or '' }}"
                      >
                        Popup
                      </span>
                      <span
                        class="badge badge-warning profile-prompt-badge{% if profile.prompt_blocked %} visible{% endif %}"
                        title="{{ profile.last_error or '' }}"
                      >
                        Prompt?
                      </span>
                    </div>
                  </td>
                  <td>
                    <select
                      class="execution-mode-select"
                      data-profile="{{ profile.name }}"
                      onchange="updateExecutionMode('{{ profile.name }}', this.value)"
                    >
                      <option value="local">ubuntuovh</option>
                      <option value="wsl_browser">WSL remote browser</option>
                      <option value="wsl_worker">WSL remote worker</option>
                    </select>
                    <div class="mode-proxy text-secondary" title="{{ profile.proxy_server or '' }}">
                      {{ profile.proxy or '-' }}
                    </div>
                  </td>
                  <td>
                    {{ profile.workers_initialized or 0 }} / {{ profile.workers_prompt_sent or 0 }}
                  </td>
                  <td style="padding-left: 16px">{{ profile.processed or 0 }}</td>
                  <td>{{ profile.tokens_k or 0 }}k</td>
                  <td>{{ profile.errors or 0 }}</td>
                  <td class="text-secondary">
                    <div style="display: flex; flex-direction: column; gap: 2px; font-size: 0.85em; line-height: 1.3;">
                      {% if profile.last_error and profile.last_error != '-' %}
                        {% set parts = profile.last_error.split(' ') %}
                        {% if parts|length >= 2 %}
                          <span style="font-weight: 500;">{{ parts[0] }}</span>
                          <span style="color: var(--color-text-tertiary);">{{ parts[1] }}</span>
                        {% else %}
                          <span>{{ profile.last_error }}</span>
                        {% endif %}
                      {% else %}
                        <span>-</span>
                      {% endif %}
                    </div>
                  </td>
                  <td class="text-secondary">
                    <div style="display: flex; flex-direction: column; gap: 2px; font-size: 0.85em; line-height: 1.3;">
                      {% if profile.last_activity and profile.last_activity != '-' %}
                        {% set parts = profile.last_activity.split(' ') %}
                        {% if parts|length >= 2 %}
                          <span style="font-weight: 500;">{{ parts[0] }}</span>
                          <span style="color: var(--color-text-tertiary);">{{ parts[1] }}</span>
                        {% else %}
                          <span>{{ profile.last_activity }}</span>
                        {% endif %}
                      {% else %}
                        <span>-</span>
                      {% endif %}
                    </div>
                  </td>
                  <td class="text-secondary">
                    <div style="display: flex; flex-direction: column; gap: 2px; font-size: 0.85em; line-height: 1.3;">
                      {% if profile.limit_reset and profile.limit_reset != '-' %}
                        {% set parts = profile.limit_reset.split(' ') %}
                        {% if parts|length >= 2 %}
                          <span style="font-weight: 500;">{{ parts[0] }}</span>
                          <span style="color: var(--color-text-tertiary);">{{ parts[1] }}</span>
                        {% else %}
                          <span>{{ profile.limit_reset }}</span>
                        {% endif %}
                      {% else %}
                        <span>-</span>
                      {% endif %}
                    </div>
                  </td>
                  <td class="text-secondary">-</td>
                  <td>
                    <div class="flex gap-sm">
                      {% if profile.status == 'active' %}
                      <button
                        class="btn btn-danger btn-sm"
                        onclick="stopProfile('{{ profile.name }}')"
                      >
                        Stop
                      </button>
                      {% else %}
                      <button
                        class="btn btn-success btn-sm"
                        onclick="startProfile('{{ profile.name }}')"
                      >
                        Start
                      </button>
                      {% endif %}
                      <button
                        class="btn btn-secondary btn-sm"
                        onclick="toggleHeaded('{{ profile.name }}')"
                        title="{% if profile.headed %}Przełącz na headless{% else %}Przełącz na headed{% endif %}"
                      >
                        {% if profile.headed %}Headed{% else %}Headless{% endif %}
                      </button>
                      <button
                        class="btn btn-secondary btn-sm"
                        onclick="loginProfile('{{ profile.name }}')"
                        title="Zaloguj"
                      >
                        Login
                      </button>
                      <button
                        class="btn btn-ghost btn-sm"
                        onclick="showProfileDetails('{{ profile.name }}')"
                      >
                        Info
                      </button>
                      <button
                        class="btn btn-ghost btn-sm"
                        onclick="resetProfileConfirm('{{ profile.name }}')"
                        title="Reset profilu"
                      >
                        Reset
                      </button>
                      {% if profile.name == "default" %}
                      <button
                        class="btn btn-ghost btn-sm text-error"
                        disabled
                        title="Nie można usunąć profilu domyślnego"
                      >
                        Del
                      </button>
                      {% else %}
                      <button
                        class="btn btn-ghost btn-sm text-error"
                        onclick="deleteProfileConfirm('{{ profile.name }}')"
                        title="Usuń"
                      >
                        Del
                      </button>
                      {% endif %}
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          {% if not profiles %}
          <div class="empty-state">
            <div class="empty-icon">
              <svg
                width="48"
                height="48"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
              >
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                <circle cx="9" cy="7" r="4" />
                <line x1="17" y1="8" x2="23" y2="8" />
              </svg>
            </div>
            <h3 class="empty-title">Brak profili</h3>
            <p class="empty-message">
              Nie znaleziono żadnych profili OCR. Dodaj nowy profil aby
              rozpocząć.
            </p>
          </div>
          {% endif %}
        </div>

        <!-- Logs Tab -->
        <div class="tab-panel" id="tab-logs">
          <div class="page-header">
            <div>
              <h1 class="page-title">Logi</h1>
              <p class="page-subtitle">Logi systemowe i aktywność profili</p>
            </div>
            <div class="flex gap-sm">
              <select
                class="form-select"
                id="logProfileFilter"
                onchange="filterLogs()"
                style="width: 200px"
              >
                <option value="all">Wszystkie profile</option>
                {% for profile in profiles %}
                <option value="{{ profile.name }}">{{ profile.name }}</option>
                {% endfor %}
              </select>
              <select
                class="form-select"
                id="logLevelFilter"
                onchange="filterLogs()"
                style="width: 150px"
              >
                <option value="all">Wszystkie poziomy</option>
                <option value="info">INFO</option>
                <option value="warn">WARN</option>
                <option value="error">ERROR</option>
              </select>
              <button class="btn btn-secondary btn-sm" onclick="copyFromElement('logContainer', this)" title="Kopiuj logi">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                Kopiuj
              </button>
              <button class="btn btn-secondary btn-sm" onclick="clearLogs()" title="Wyczyść logi">
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <polyline points="3 6 5 6 21 6" />
                  <path
                    d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                  />
                </svg>
                Wyczyść
              </button>
            </div>
          </div>

          <div class="log-container" id="logContainer">
            <div class="empty-state" id="noLogsMessage">
              <div class="empty-icon">
                <svg
                  width="48"
                  height="48"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                >
                  <path
                    d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                  />
                  <polyline points="14 2 14 8 20 8" />
                </svg>
              </div>
              <h3 class="empty-title">Brak logów</h3>
              <p class="empty-message">
                Logi pojawią się tutaj po rozpoczęciu przetwarzania.
              </p>
            </div>
          </div>

        </div>

        <div class="tab-panel" id="tab-services">
          <div class="page-header">
            <div>
              <h1 class="page-title">Serwisy</h1>
              <p class="page-subtitle">Logi monitoringu i precheck limitów</p>
            </div>
            <div class="flex gap-sm">
              <button class="btn btn-secondary btn-sm" onclick="refreshServiceLog()">
                Odśwież
              </button>
              <button
                class="btn btn-secondary btn-sm"
                onclick="copyFromElement('serviceLogContainer', this)"
                title="Kopiuj log"
              >
                Kopiuj
              </button>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <div class="filters-row">
                <div class="filter-group">
                  <label class="compact-form-label" for="serviceLogSelect">Źródło</label>
                  <select class="form-select" id="serviceLogSelect">
                    <option value="monitor_farm_health" selected>
                      monitor_farm_health.service.log
                    </option>
                    <option value="precheck_limits">precheck_limits.service.log</option>
                    <option value="farm_health_nohup">monitor_farm_health.log (nohup)</option>
                    <option value="precheck_nohup">precheck_limits.log (nohup)</option>
                  </select>
                </div>
                <div class="filter-group">
                  <label class="compact-form-label" for="serviceLogTail">Tail</label>
                  <input
                    class="form-input"
                    id="serviceLogTail"
                    type="number"
                    value="400"
                    min="50"
                    max="2000"
                  />
                </div>
                <div class="filter-group">
                  <label class="compact-form-label" for="serviceLogAuto">
                    Auto
                  </label>
                  <select class="form-select" id="serviceLogAuto">
                    <option value="0">OFF</option>
                    <option value="5">5s</option>
                    <option value="10" selected>10s</option>
                    <option value="30">30s</option>
                  </select>
                </div>
              </div>
              <div class="log-container" id="serviceLogContainer">
                <div class="empty-state">
                  <h3 class="empty-title">Brak logów</h3>
                  <p class="empty-message">Wybierz źródło i odśwież.</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Live Preview Tab -->
        <div class="tab-panel" id="tab-preview">
          <div class="page-header">
            <div>
              <h1 class="page-title">Podgląd + Aktywność</h1>
              <p class="page-subtitle">Podgląd i aktywność aktywnych workerów</p>
            </div>
            <div class="flex gap-sm">
              <input
                type="text"
                class="form-input"
                id="previewSearch"
                placeholder="Filtruj po profilu..."
                style="width: 220px"
              />
              <label class="checkbox-label" style="font-size: 12px">
                <input type="checkbox" id="previewActiveOnly" />
                Tylko aktywne
              </label>
              <input
                type="number"
                class="form-input"
                id="previewActiveMinutes"
                min="1"
                value="10"
                style="width: 70px"
                title="Minuty świeżości"
              />
              <select class="form-select" id="previewSort" style="width: 160px">
                <option value="newest">Najnowsze</option>
                <option value="oldest">Najstarsze</option>
                <option value="name">Nazwa A→Z</option>
                <option value="fresh">Najświeższe (ostatnie N min)</option>
              </select>
              <div class="segmented" id="previewViewToggle">
                <button class="segmented-btn active" data-view="grid">Siatka</button>
                <button class="segmented-btn" data-view="list">Lista</button>
              </div>
              <span class="text-secondary" id="previewCount" style="align-self:center;font-size:12px;"></span>
              <button
                class="btn btn-secondary btn-sm"
                onclick="refreshLivePreviewAll()"
                id="previewRefreshBtn"
              >
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <polyline points="23 4 23 10 17 10" />
                  <polyline points="1 20 1 14 7 14" />
                  <path
                    d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"
                  />
                </svg>
                Odśwież wszystkie
              </button>
              <label class="checkbox-label" style="font-size: 12px">
                <input
                  type="checkbox"
                  id="previewAutoRefresh"
                  onchange="togglePreviewAutoRefresh()"
                />
                Auto-odświeżanie (10s)
              </label>
            </div>
          </div>

          <div class="preview-grid" id="livePreviewGrid">
            <div class="empty-state" id="previewEmptyState">
              <div class="empty-icon">
                <svg
                  width="48"
                  height="48"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                >
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                  <circle cx="8.5" cy="8.5" r="1.5" />
                  <polyline points="21 15 16 10 5 21" />
                </svg>
              </div>
              <h3 class="empty-title">Brak aktywnych workerów</h3>
              <p class="empty-message">
                Screenshoty pojawią się tutaj po uruchomieniu jobów.
              </p>
            </div>
          </div>
        </div>

        <!-- Limits Tab -->
        <div class="tab-panel" id="tab-limits">
          <div class="page-header">
            <div>
              <h1 class="page-title">Limits Checker</h1>
              <p class="page-subtitle">
                Sprawdzanie statusu limitów Pro dla profili
              </p>
            </div>
          </div>

          <!-- Limits Status Cards -->
          <div class="stats-grid" style="margin-bottom: var(--spacing-lg)">
            <div class="stat-card">
              <div class="stat-icon cyan">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <circle cx="12" cy="12" r="10" />
                  <polyline points="12 6 12 12 16 14" />
                </svg>
              </div>
              <div class="stat-content">
                <div class="stat-value" id="limitLastCheck">-</div>
                <div class="stat-label">Ostatnie sprawdzenie</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon blue">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
                </svg>
              </div>
              <div class="stat-content">
                <div class="stat-value" id="limitSessionRuns">0</div>
                <div class="stat-label">Sprawdzeń w sesji</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon green">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                  <polyline points="22 4 12 14.01 9 11.01" />
                </svg>
              </div>
              <div class="stat-content">
                <div class="stat-value" id="limitOkCount">0</div>
                <div class="stat-label">Profile OK</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon red">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <circle cx="12" cy="12" r="10" />
                  <line x1="15" y1="9" x2="9" y2="15" />
                  <line x1="9" y1="9" x2="15" y2="15" />
                </svg>
              </div>
              <div class="stat-content">
                <div class="stat-value" id="limitExceededCount">0</div>
                <div class="stat-label">Profile z limitem</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon yellow">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <circle cx="12" cy="12" r="10" />
                  <line x1="12" y1="8" x2="12" y2="12" />
                  <circle cx="12" cy="16" r="1" />
                </svg>
              </div>
              <div class="stat-content">
                <div class="stat-value" id="limitLoginCount">0</div>
                <div class="stat-label">Wymaga logowania</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon orange">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M12 2l10 18H2L12 2z" />
                  <line x1="12" y1="9" x2="12" y2="13" />
                  <circle cx="12" cy="17" r="1" />
                </svg>
              </div>
              <div class="stat-content">
                <div class="stat-value" id="limitErrorCount">0</div>
                <div class="stat-label">Błędy</div>
              </div>
            </div>
          </div>

          <div
            style="
              display: grid;
              grid-template-columns: 260px 1fr;
              gap: var(--spacing-lg);
            "
          >
            <!-- Limit Check Config -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Konfiguracja</h3>
              </div>
              <div class="card-body">
                <div class="form-group">
                  <label class="form-label" for="limitParallel">Równoległe sprawdzenia</label>
                  <input
                    type="number"
                    class="form-input"
                    id="limitParallel"
                    value="4"
                    min="1"
                    max="8"
                  />
                </div>
                <div class="form-group">
                  <label class="form-label" for="limitHost">Host</label>
                  <select class="form-select" id="limitHost">
                    <option value="local">Lokalny</option>
                  </select>
                </div>
                <div class="form-group">
                  <div class="form-label">Profile do sprawdzenia</div>
                  <div
                    class="flex gap-sm flex-wrap"
                    style="margin-bottom: var(--spacing-sm)"
                  >
                    <button
                      class="btn btn-secondary btn-sm"
                      onclick="selectAllLimitProfiles()"
                    >
                      Wszystkie
                    </button>
                    <button
                      class="btn btn-secondary btn-sm"
                      onclick="selectActiveLimitProfiles()"
                    >
                      Aktywne
                    </button>
                    <button
                      class="btn btn-secondary btn-sm"
                      onclick="selectPausedLimitProfiles()"
                    >
                      Wstrzymane
                    </button>
                    <button
                      class="btn btn-secondary btn-sm"
                      onclick="clearLimitProfiles()"
                    >
                      Wyczyść
                    </button>
                  </div>
                  <div
                    class="limit-profiles-list"
                    id="limitProfilesList"
                    style="
                      max-height: 200px;
                      overflow-y: auto;
                      border: 1px solid var(--color-border);
                      border-radius: var(--radius-md);
                      padding: var(--spacing-sm);
                    "
                  >
                    {% for profile in profiles %}
                    <label class="checkbox-label" style="margin-bottom: 4px">
                      <input
                        type="checkbox"
                        class="limit-profile-cb"
                        value="{{ profile.name }}"
                      />
                      {{ profile.name }}
                    </label>
                    {% endfor %}
                  </div>
                </div>
                <div class="flex gap-sm flex-wrap">
                  <button
                    class="btn btn-primary"
                    onclick="runLimitCheck('quick')"
                    id="limitRunBtn"
                    style="width: 100%"
                    title="Quick check: szybki snapshot bez wysyłania promptu"
                  >
                    <svg
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <polygon points="5 3 19 12 5 21 5 3" />
                    </svg>
                    Quick check
                  </button>
                  <button
                    class="btn btn-secondary"
                    onclick="runLimitCheck('full')"
                    id="limitRunBtnFull"
                    style="width: 100%"
                    title="Full check: wysyła prompt i czeka na odpowiedź"
                  >
                    Full check
                  </button>
                  <button
                    class="btn btn-ghost"
                    onclick="stopLimitCheck()"
                    id="limitStopBtn"
                    style="width: 100%"
                    title="Zatrzymaj trwające sprawdzenie (lokalny precheck)"
                    disabled
                  >
                    Stop
                  </button>
                  <button
                    class="btn btn-ghost"
                    onclick="clearLimitResults()"
                    id="limitClearBtn"
                    style="width: 100%"
                    title="Reset/wyczyść: czyści tabelę wyników i liczniki sesji"
                  >
                    Wyczyść
                  </button>
                </div>
                <div
                  id="limitProgress"
                  class="hidden"
                  style="margin-top: var(--spacing-md)"
                >
                  <div
                    class="progress"
                    style="margin-bottom: var(--spacing-sm)"
                  >
                    <div
                      class="progress-bar"
                      id="limitProgressBar"
                      style="width: 0%"
                    ></div>
                  </div>
                  <p
                    class="text-secondary"
                    style="font-size: 12px"
                    id="limitProgressText"
                  >
                    Sprawdzanie...
                  </p>
                </div>
              </div>
            </div>

            <!-- Limit Results Table -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Wyniki sprawdzenia</h3>
                <span
                  class="text-secondary"
                  style="font-size: 12px"
                  id="limitResultsTime"
                ></span>
              </div>
              <div class="card-body" style="padding: 0">
                <div class="filters-row" style="padding: var(--spacing-sm)">
                  <div class="filter-group">
                    <label class="compact-form-label">Filtr</label>
                    <div class="flex gap-sm">
                      <button class="btn btn-secondary btn-sm" onclick="setLimitStatusFilter('all')">Wszystkie</button>
                      <button class="btn btn-secondary btn-sm" onclick="setLimitStatusFilter('OK')">OK</button>
                      <button class="btn btn-secondary btn-sm" onclick="setLimitStatusFilter('LIMIT')">LIMIT</button>
                      <button class="btn btn-secondary btn-sm" onclick="setLimitStatusFilter('LOGIN')">LOGIN</button>
                      <button class="btn btn-secondary btn-sm" onclick="setLimitStatusFilter('ERROR')">ERROR</button>
                    </div>
                  </div>
                  <div class="filter-group">
                    <label class="compact-form-label" for="limitSearchInput">Szukaj</label>
                    <input
                      class="form-input"
                      id="limitSearchInput"
                      type="text"
                      placeholder="np. profile123"
                      oninput="setLimitSearch(this.value)"
                    />
                  </div>
                </div>
                <div
                  class="table-container"
                  style="border: none; border-radius: 0"
                >
                  <table class="table" style="font-size: 0.85em;">
                    <thead>
                      <tr>
                        <th title="Nazwa profilu">Profil</th>
                        <th title="Status profilu">Status</th>
                        <th title="Tryb sprawdzenia">Tryb</th>
                        <th title="Szczegóły (np. LOGIN/ERROR)">Szczegóły</th>
                        <th title="Pozostały limit Pro">Limit</th>
                        <th title="Czas resetu">Reset</th>
                        <th title="Czas sprawdzenia">Czas</th>
                      </tr>
                    </thead>
                    <tbody id="limitResultsBody">
                      <tr>
                        <td
                          colspan="7"
                          class="text-center text-secondary"
                          style="padding: var(--spacing-lg)"
                        >
                          Brak wyników. Uruchom sprawdzenie limitów.
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="card-body">
                <div class="info-banner">
                  <div class="info-banner-icon">
                    <svg
                      width="18"
                      height="18"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <circle cx="12" cy="12" r="10" />
                      <line x1="12" y1="16" x2="12" y2="12" />
                      <line x1="12" y1="8" x2="12" y2="8" />
                    </svg>
                  </div>
                  <div class="info-banner-content">
                    <div class="info-banner-title">Jak interpretować wyniki</div>
                    <div class="info-banner-text">
                      <span class="font-bold">OK</span> = brak wykrytego limitu
                      (tylko jeśli profil jest zalogowany).<br />
                      <span class="font-bold">LIMIT</span> = limit Pro aktywny,
                      reset o wskazanej godzinie.<br />
                      <span class="font-bold">SESSION_EXPIRED</span> = profil
                      niezalogowany, wynik niepewny.<br />
                      <span class="font-bold">Pewność</span>: <span class="font-bold">full</span>
                      wysyła prompt, <span class="font-bold">quick</span> bez promptu,
                      <span class="font-bold">snapshot</span> to szybki odczyt z DB.
                    </div>
                  </div>
                </div>
                <div class="info-banner" style="margin-top: var(--spacing-sm)">
                  <div class="info-banner-icon">
                    <svg
                      width="18"
                      height="18"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <circle cx="12" cy="12" r="10" />
                      <line x1="8" y1="16" x2="16" y2="16" />
                      <line x1="8" y1="12" x2="16" y2="12" />
                      <line x1="8" y1="8" x2="16" y2="8" />
                    </svg>
                  </div>
                  <div class="info-banner-content">
                    <div class="info-banner-title">Legenda statusów</div>
                    <div class="info-banner-text">
                      <span class="badge badge-success">OK</span>
                      <span class="badge badge-error">LIMIT</span>
                      <span class="badge badge-warning">LOGIN</span>
                      <span class="badge badge-error">ERROR</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Post-Process Tab -->
        <div class="tab-panel" id="tab-postprocess">
          <div class="page-header">
            <div>
              <h1 class="page-title">Post-Processing</h1>
              <p class="page-subtitle">Strukturyzacja danych OCR</p>
            </div>
          </div>

          <div
            style="
              display: grid;
              grid-template-columns: 400px 1fr;
              gap: var(--spacing-lg);
            "
          >
            <!-- Post-Process Config -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Konfiguracja</h3>
                <span class="badge" id="postProcStatusBadge">IDLE</span>
              </div>
              <div class="card-body">
                <div class="form-group">
                  <label class="form-label" for="postProcApiKey">OpenRouter API Key</label>
                  <input
                    type="password"
                    class="form-input"
                    id="postProcApiKey"
                    placeholder="sk-or-..."
                  />
                </div>

                <div
                  class="flex gap-sm"
                  style="margin-bottom: var(--spacing-md)"
                >
                  <button
                    class="btn btn-primary flex-1"
                    onclick="togglePostProcess()"
                    id="postProcToggleBtn"
                  >
                    <svg
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <polygon points="5 3 19 12 5 21 5 3" />
                    </svg>
                    Start
                  </button>
                  <button
                    class="btn btn-secondary"
                    onclick="migratePostProcess()"
                    title="Utwórz tabele w bazie"
                  >
                    <svg
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <ellipse cx="12" cy="5" rx="9" ry="3" />
                      <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3" />
                      <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" />
                    </svg>
                    Migrate
                  </button>
                </div>

                <!-- Stats -->
                <div
                  style="
                    background: var(--color-bg-tertiary);
                    padding: var(--spacing-md);
                    border-radius: var(--radius-md);
                  "
                >
                  <div class="flex justify-between mb-sm">
                    <span class="text-secondary">Nowych do przetworzenia</span>
                    <span class="font-bold" id="postProcNew">0</span>
                  </div>
                  <div class="flex justify-between mb-sm">
                    <span class="text-secondary">Przetworzonych</span>
                    <span class="font-bold text-success" id="postProcDone"
                      >0</span
                    >
                  </div>
                  <div class="progress" style="margin-top: var(--spacing-sm)">
                    <div
                      class="progress-bar success"
                      id="postProcProgressBar"
                      style="width: 0%"
                    ></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Post-Process Logs -->
            <div class="card">
              <div class="card-header">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <h3 class="card-title">Log</h3>
                    <button class="btn btn-ghost btn-sm" onclick="copyFromElement('postProcLogContainer', this)" title="Kopiuj logi">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    </button>
                </div>
              </div>
              <div class="card-body">
                <div
                  class="log-container"
                  id="postProcLogContainer"
                  style="max-height: 400px"
                >
                  <div class="empty-state">
                    <p class="empty-message">
                      Logi post-processingu pojawią się tutaj.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Job Config Tab -->
        <div class="tab-panel" id="tab-jobconfig">
            <div class="page-header">
                <div>
                    <h1 class="page-title" data-i18n="job.title">Konfiguracja Job</h1>
                    <p class="page-subtitle" data-i18n="job.subtitle">Ustawienia nowego zadania OCR</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="resetJobConfig()" title="Przywróć domyślne ustawienia" style="margin-right: 8px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                            <path d="M3 3v5h5"/>
                        </svg>
                        <span data-i18n="job.resetBtn">Reset</span>
                    </button>
                    <button class="btn btn-success" onclick="startJob()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="5 3 19 12 5 21 5 3" />
                        </svg>
                        <span data-i18n="job.startBtn">Uruchom Job</span>
                    </button>
                </div>
            </div>
            
            <div class="config-container">
                <!-- Job Config Tabs -->
                <div class="config-tabs">
                    <button class="config-tab active" data-config-tab="basic" onclick="switchConfigTab('basic')" data-i18n="job.tabs.basic">Basic</button>
                    <button class="config-tab" data-config-tab="performance" onclick="switchConfigTab('performance')" data-i18n="job.tabs.performance">Performance</button>
                    <button class="config-tab" data-config-tab="database" onclick="switchConfigTab('database')" data-i18n="job.tabs.database">Database</button>
                    <button class="config-tab" data-config-tab="preprocess" onclick="switchConfigTab('preprocess')" data-i18n="job.tabs.preprocess">Preprocess</button>
                    <button class="config-tab" data-config-tab="advanced" onclick="switchConfigTab('advanced')" data-i18n="job.tabs.advanced">Advanced</button>
                </div>

                <!-- Basic Tab -->
                <div class="config-panel active" id="config-basic">
                    <div class="form-group">
                        <label class="form-label" for="jobSourcePath" data-i18n="job.basic.sourcePath" data-i18n-title="job.tooltips.sourcePath">Source Path</label>
                        <div class="flex gap-sm" style="align-items: stretch;">
                            <span class="form-input" id="sourceRootBadge" style="flex: 0 0 auto; background: var(--color-bg-tertiary); color: var(--color-text-secondary); border-right: none; border-radius: var(--radius-md) 0 0 var(--radius-md); font-size: 13px; display: flex; align-items: center; padding: 0 10px; white-space: nowrap; cursor: default; user-select: none; max-width: 180px; overflow: hidden; text-overflow: ellipsis;" title="SOURCE_ROOT">/data/sources/</span>
                            <input type="text" class="form-input" id="jobSourcePath" placeholder="nas/Nurskie/1_43" style="border-radius: 0; border-left: none; flex: 1;">
                            <button class="btn btn-secondary" onclick="openFileBrowser('jobSourcePath')" title="Przeglądaj" style="border-radius: 0;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />
                                </svg>
                            </button>
                            <button class="btn btn-secondary" onclick="verifySourcePath()" id="sourceVerifyBtn" title="Weryfikuj ścieżkę" style="border-radius: 0 var(--radius-md) var(--radius-md) 0;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 11l3 3L22 4"/>
                                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                                </svg>
                            </button>
                        </div>
                        <div id="sourcePathStatus" style="margin-top: 4px; font-size: 12px; min-height: 18px;"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="jobBatchId" data-i18n="job.basic.batchId" data-i18n-title="job.tooltips.batchId">Batch ID</label>
                        <input type="text" class="form-input" id="jobBatchId" placeholder="auto-generated if empty">
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label" data-i18n-title="job.tooltips.headed">
                            <input type="checkbox" id="jobHeadedMode">
                            <span data-i18n="job.basic.headed">Headed Mode (pokazuj przeglądarkę)</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="jobEngine" data-i18n="job.basic.engine" data-i18n-title="job.tooltips.engine">Silnik OCR</label>
                        <select class="form-select" id="jobEngine">
                            <option value="auto">Auto (domyślnie)</option>
                            <option value="gemini">Gemini</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <div class="form-label" data-i18n="job.basic.profiles">Profile do uruchomienia</div>
                        <div class="flex gap-sm flex-wrap" style="margin-bottom: var(--spacing-sm);">
                            <button class="btn btn-secondary btn-sm" onclick="selectAllJobProfiles()" data-i18n="job.basic.all">Wszystkie</button>
                            <button class="btn btn-secondary btn-sm" onclick="selectOkLimitJobProfiles()" data-i18n="job.basic.okLimit">OK Limit</button>
                            <button class="btn btn-secondary btn-sm" onclick="clearJobProfiles()" data-i18n="job.basic.clear">Wyczyść</button>
                            <span style="border-left: 1px solid var(--color-border); margin: 0 var(--spacing-xs);"></span>
                            <button class="btn btn-secondary btn-sm" onclick="sortJobProfiles('asc')">A→Z</button>
                            <button class="btn btn-secondary btn-sm" onclick="sortJobProfiles('desc')">Z→A</button>
                            <span style="border-left: 1px solid var(--color-border); margin: 0 var(--spacing-xs);"></span>
                            <button class="btn btn-primary btn-sm" onclick="openAddProfileModal()" data-i18n="job.basic.add">+ Dodaj</button>
                        </div>
                        <div class="job-profiles-list" id="jobProfilesList" style="max-height: 150px; overflow-y: auto; border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--spacing-sm);">
                            {% for profile in profiles %}
                            <label class="checkbox-label" style="margin-bottom: 4px;">
                                <input type="checkbox" class="job-profile-cb" value="{{ profile.name }}" checked>
                                {{ profile.name }}
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Performance Tab -->
                <div class="config-panel" id="config-performance">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="jobWindows" data-i18n="job.perf.windows" data-i18n-title="job.tooltips.windows">Liczba okien</label>
                            <input type="number" class="form-input" id="jobWindows" value="2" min="1" max="10">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="jobTabsPerWindow" data-i18n="job.perf.tabsPerWindow" data-i18n-title="job.tooltips.tabsPerWindow">Karty na okno</label>
                            <input type="number" class="form-input" id="jobTabsPerWindow" value="2" min="1" max="6">
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: var(--spacing-md);">
                        <span class="text-secondary" style="font-size: 12px;">
                            <span data-i18n="job.perf.totalWorkers">Razem workerów</span>: 
                            <strong id="jobTotalWorkers" style="color: var(--color-success);">4</strong>
                            <span class="text-muted" style="font-size: 11px;">(okna × karty)</span>
                        </span>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="jobScansPerWorker" data-i18n="job.perf.scans" data-i18n-title="job.tooltips.scans">Skanów na worker</label>
                            <input type="number" class="form-input" id="jobScansPerWorker" value="2" min="1" max="100">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="jobCollectTimeout" data-i18n="job.perf.timeout" data-i18n-title="job.tooltips.timeout">Collect Timeout (sec)</label>
                        <input type="number" class="form-input" id="jobCollectTimeout" value="400" min="60" max="1200">
                    </div>
                    <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                    <p class="text-secondary" style="font-size: 11px; margin-bottom: var(--spacing-sm);" data-i18n="job.perf.tabsSection">Karty przeglądarki</p>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="checkbox-label" data-i18n-title="job.tooltips.closeIdle">
                                <input type="checkbox" id="jobCloseIdleTabs" checked>
                                <span data-i18n="job.perf.closeIdle">Auto zamykaj nieużywane karty</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="jobMaxTabsPerContext" data-i18n="job.perf.maxTabs" data-i18n-title="job.tooltips.maxTabs">Max kart / kontekst (0=bez)</label>
                            <input type="number" class="form-input" id="jobMaxTabsPerContext" value="0" min="0">
                        </div>
                    </div>
                    <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                    <p class="text-secondary" style="font-size: 11px; margin-bottom: var(--spacing-sm);" data-i18n="job.perf.ctxSection">Konteksty</p>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="checkbox-label" data-i18n-title="job.tooltips.isolated">
                                <input type="checkbox" id="jobIsolatedContexts">
                                <span data-i18n="job.perf.isolated">Izolowane konteksty</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="jobContextPoolSize" data-i18n="job.perf.pool" data-i18n-title="job.tooltips.pool">Pula kontekstów</label>
                            <input type="number" class="form-input" id="jobContextPoolSize" value="0" min="0">
                        </div>
                    </div>
                    <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                    <p class="text-secondary" style="font-size: 11px; margin-bottom: var(--spacing-sm);" data-i18n="job.perf.uiSection">Profil UI</p>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="jobViewportWidth" data-i18n="job.perf.viewportW">Viewport Width</label>
                            <input type="number" class="form-input" id="jobViewportWidth" value="1200">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="jobViewportHeight" data-i18n="job.perf.viewportH">Viewport Height</label>
                            <input type="number" class="form-input" id="jobViewportHeight" value="800">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label" data-i18n-title="job.tooltips.reducedMotion">
                            <input type="checkbox" id="jobReducedMotion" checked>
                            <span data-i18n="job.perf.reducedMotion">Ogranicz animacje</span>
                        </label>
                    </div>
                </div>

                <!-- Database Tab -->
                <div class="config-panel" id="config-database">
                    <div class="form-group">
                        <label class="checkbox-label" data-i18n-title="job.tooltips.pgEnabled">
                            <input type="checkbox" id="jobPgEnabled" checked>
                            <span data-i18n="job.db.enabled">PostgreSQL Enabled</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="jobPgDsn" data-i18n="job.db.dsn">PostgreSQL DSN</label>
                        <input type="text" class="form-input" id="jobPgDsn" value="postgresql://tomaasz:123Karinka!%40%23@127.0.0.1:5432/ocr" placeholder="postgresql://user:pass@host:5432/db">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="jobPgTable" data-i18n="job.db.table">Table</label>
                        <input type="text" class="form-input" id="jobPgTable" value="public.ocr_raw_texts">
                    </div>
                    <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                    <p class="text-secondary" style="font-size: 11px; margin-bottom: var(--spacing-sm); text-transform: uppercase;" data-i18n="job.db.syncSection">Synchronizacja</p>
                    <button class="btn btn-primary" onclick="syncProfiles()" style="width: 100%;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 2v6h-6" />
                            <path d="M3 12a9 9 0 0 1 15-6.7L21 8" />
                            <path d="M3 22v-6h6" />
                            <path d="M21 12a9 9 0 0 1-15 6.7L3 16" />
                        </svg>
                        <span data-i18n="job.db.syncBtn">Synchronizuj profile (Remote)</span>
                    </button>
                    <p class="text-secondary" style="font-size: 11px; margin-top: var(--spacing-xs); text-align: center;" data-i18n="job.db.syncDesc">Kopiuje lokalne profile (Gemini) na zdalnego workera</p>
                </div>

                <!-- Preprocess Tab -->
                <div class="config-panel" id="config-preprocess">
                    <p class="text-secondary" style="margin-bottom: var(--spacing-md); font-size: 12px;" data-i18n="job.prep.desc">
                        Parametry przetwarzania obrazu. Domyślne wartości są optymalne dla większości dokumentów.
                    </p>

                    <p class="text-secondary" style="font-size: 11px; margin-bottom: var(--spacing-xs); text-transform: uppercase;" data-i18n="job.prep.scaleSection">Skalowanie i szum</p>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="jobPreprocMaxDim" data-i18n="job.prep.maxDim" data-i18n-title="job.tooltips.maxDim">Max Dimension</label>
                            <input type="number" class="form-input" id="jobPreprocMaxDim" value="2500">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="jobPreprocMedianKernel" data-i18n="job.prep.median" data-i18n-title="job.tooltips.median">Median Kernel</label>
                            <input type="number" class="form-input" id="jobPreprocMedianKernel" value="3">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="jobPreprocDenoise" data-i18n="job.prep.denoise" data-i18n-title="job.tooltips.denoise">Denoise Strength</label>
                            <input type="number" class="form-input" id="jobPreprocDenoise" value="8">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="jobPreprocMorph" data-i18n="job.prep.morph" data-i18n-title="job.tooltips.morph">Morph Kernel</label>
                            <input type="number" class="form-input" id="jobPreprocMorph" value="2">
                        </div>
                    </div>

                    <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                    <p class="text-secondary" style="font-size: 11px; margin-bottom: var(--spacing-xs); text-transform: uppercase;" data-i18n="job.prep.contrastSection">Kontrast i kontury</p>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="jobPreprocClahe" data-i18n="job.prep.claheClip">CLAHE Clip Limit</label>
                            <input type="number" class="form-input" id="jobPreprocClahe" value="2.0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="jobPreprocClaheGrid" data-i18n="job.prep.claheGrid">CLAHE Grid Size</label>
                            <input type="text" class="form-input" id="jobPreprocClaheGrid" value="8,8" placeholder="8,8">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="jobPreprocLocalSigma" data-i18n="job.prep.localSigma">Local Contrast Sigma</label>
                            <input type="number" class="form-input" id="jobPreprocLocalSigma" value="12.0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="jobPreprocLocalAmount" data-i18n="job.prep.localAmount">Local Contrast Amount</label>
                            <input type="number" class="form-input" id="jobPreprocLocalAmount" value="0.35" step="0.05">
                        </div>
                    </div>
                </div>

                <!-- Advanced Tab -->
                <div class="config-panel" id="config-advanced">
                    <p class="text-secondary" style="font-size: 11px; margin-bottom: var(--spacing-sm); text-transform: uppercase;" data-i18n="job.adv.mode">Tryb pracy</p>
                    <div class="form-group">
                        <label class="checkbox-label" data-i18n-title="job.tooltips.continue">
                            <input type="checkbox" id="jobContinueMode" checked>
                            <span data-i18n="job.adv.continue">Tryb kontynuacji (Continue)</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label" data-i18n-title="job.tooltips.autoAdvance">
                            <input type="checkbox" id="jobAutoAdvance" checked>
                            <span data-i18n="job.adv.autoAdvance">Auto-advance folderów</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label" data-i18n-title="job.tooltips.proOnly">
                            <input type="checkbox" id="jobProOnly" checked>
                            <span data-i18n="job.adv.proOnly">Tylko model Pro (gwarantowana jakość)</span>
                        </label>
                    </div>
                    <div class="form-group">
                         <label class="checkbox-label" data-i18n-title="job.tooltips.clean">
                            <input type="checkbox" id="jobCleanTmp" checked>
                            <span data-i18n="job.adv.clean">Czyść pliki tymczasowe</span>
                         </label>
                    </div>

                    <hr style="border-color: var(--color-border); margin: var(--spacing-md) 0;">
                    <p class="text-secondary" style="font-size: 11px; margin-bottom: var(--spacing-sm); text-transform: uppercase;" data-i18n="job.adv.diagSection">Diagnostyka</p>
                    <div class="form-group">
                        <label class="checkbox-label" data-i18n-title="job.tooltips.debug">
                             <input type="checkbox" id="jobDebugArtifacts">
                             <span data-i18n="job.adv.debug">Zapisuj błędy (Debug Artifacts)</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label" data-i18n-title="job.tooltips.video">
                             <input type="checkbox" id="jobCaptureVideo">
                             <span data-i18n="job.adv.video">Nagrywaj wideo</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-panel" id="tab-settings">
          <div class="page-header">
            <div>
              <h1 class="page-title" data-i18n="settings.title">Ustawienia</h1>
              <p class="page-subtitle" data-i18n="settings.subtitle">Konfiguracja systemu</p>
            </div>
          </div>

          <div class="settings-grid">
            
            <!-- General + System Settings -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title" data-i18n="settings.generalSystem">Ogólne + System</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="settingAutoRestart" onchange="toggleAutoRestart(this.checked)">
                            <span data-i18n="settings.autoRestart">Auto-restart workerów po błędzie</span>
                        </label>
                    </div>
                     <div class="form-group settings-mt">
                        <label class="form-label" data-i18n="settings.language">Język</label>
                        <div class="flex gap-sm">
                            <button class="btn btn-secondary lang-btn" data-lang="pl" onclick="setLanguage('pl')">PL</button>
                            <button class="btn btn-secondary lang-btn" data-lang="en" onclick="setLanguage('en')">EN</button>
                        </div>
                    </div>
                    <hr class="settings-section-divider">
                    <div class="form-group">
                        <label class="form-label" data-i18n="settings.x11Display">X11 DISPLAY</label>
                        <input type="text" class="form-input" id="settingDisplay" value=":0" onchange="updateSetting('display', this.value)">
                    </div>
                    <hr class="settings-section-divider">
                    <div class="settings-section-divider text-sm font-medium text-secondary" style="margin-top: 6px;">
                        <span data-i18n="settings.advanced">Zaawansowane</span>
                    </div>
                    <div class="form-group settings-mt">
                        <label class="checkbox-label" data-i18n-title="settings.tooltips.updateCountsOnNewPaths">
                            <input type="checkbox" id="settingUpdateCountsOnNewPaths" onchange="saveUpdateCountsSettings()">
                            <span data-i18n="settings.updateCountsOnNewPaths">Aktualizuj liczniki przy nowych folderach</span>
                        </label>
                    </div>
                    <div class="form-group settings-mt">
                        <label class="form-label" data-i18n="settings.updateCountsPollSec" data-i18n-title="settings.tooltips.updateCountsPollSec">Interwał sprawdzania (sek.)</label>
                        <input type="number" class="form-input" id="settingUpdateCountsPollSec" min="0" step="1" onchange="saveUpdateCountsSettings()">
                    </div>
                     <hr class="settings-section-divider">
                    <div class="form-group">
                         <label class="form-label" data-i18n="settings.maintenance">Akcje</label>
                         <div class="flex gap-sm flex-wrap">
                            <button class="btn btn-secondary" onclick="openCleanupModal()">
                                 <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="icon-gap"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                 <span data-i18n="settings.cleanupFolders">Wyczyść</span>
                            </button>
                            <button class="btn btn-secondary" onclick="syncProfiles()">
                                 <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="icon-gap"><path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16"></path></svg>
                                 <span data-i18n="settings.syncProfiles">Sync Profile</span>
                            </button>
                         </div>
                    </div>
                </div>
            </div>

            <!-- Webshare Settings -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title" data-i18n="settings.webshare">Webshare Sync</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label" data-i18n="settings.webshareToken">API Token</label>
                        <input type="text" class="form-input" id="settingWebshareToken" onchange="saveWebshareSettings()">
                    </div>
                    <div class="form-group settings-mt">
                        <label class="form-label" data-i18n="settings.webshareMode">Proxy mode</label>
                        <input type="text" class="form-input" id="settingWebshareMode" placeholder="direct" onchange="saveWebshareSettings()">
                    </div>
                    <div class="form-group settings-mt">
                        <label class="form-label" data-i18n="settings.websharePlanId">Plan ID</label>
                        <input type="text" class="form-input" id="settingWebsharePlanId" onchange="saveWebshareSettings()">
                    </div>
                    <div class="form-group settings-mt">
                        <label class="form-label" data-i18n="settings.websharePageSize">Page size</label>
                        <input type="number" class="form-input" id="settingWebsharePageSize" min="1" step="1" onchange="saveWebshareSettings()">
                    </div>
                    <div class="form-group settings-mt">
                        <label class="form-label" data-i18n="settings.webshareCountries">Country codes</label>
                        <input type="text" class="form-input" id="settingWebshareCountries" placeholder="PL,DE" onchange="saveWebshareSettings()">
                    </div>
                    <div class="form-group settings-mt">
                        <label class="checkbox-label">
                            <input type="checkbox" id="settingWebshareMinValid" onchange="saveWebshareSettings()">
                            <span data-i18n="settings.webshareMinValid">Tylko valid</span>
                        </label>
                    </div>
                    <div class="form-group settings-mt">
                        <label class="checkbox-label">
                            <input type="checkbox" id="settingProxyDisabledGlobal" onchange="saveWebshareSettings()">
                            <span data-i18n="settings.proxyDisabledGlobal">Wyłącz proxy dla całej farmy</span>
                        </label>
                    </div>
                    <div class="form-group settings-mt">
                        <label class="form-label" data-i18n="settings.webshareSeed">Seed</label>
                        <input type="text" class="form-input" id="settingWebshareSeed" onchange="saveWebshareSettings()">
                    </div>
                    <div class="form-group settings-mt" style="display:flex; gap:8px; align-items:center;">
                        <button class="btn btn-secondary btn-sm" onclick="runWebshareSync()" data-i18n="settings.webshareSyncNow">Sync teraz</button>
                        <span class="text-secondary" id="webshareSyncStatus" style="font-size:12px;"></span>
                    </div>
                    <div class="form-group settings-mt">
                        <span class="text-secondary" id="webshareSyncLast" style="font-size:12px;"></span>
                    </div>
                </div>
            </div>

            <!-- Remote Configuration -->
            <div class="card settings-card-full">
                <div class="card-header">
                     <h3 class="card-title" data-i18n="settings.remoteConfig">Remote Configuration</h3>
                     <div class="flex gap-sm">
                         <div class="settings-toggle-wrapper" style="margin-right: 16px;">
                            <label class="switch">
                                <input type="checkbox" id="settingRemoteRunEnabled">
                                <span class="slider round"></span>
                            </label>
                            <span data-i18n="settings.enableRemote">Enable Remote Run</span>
                         </div>
                         <button class="btn btn-primary btn-sm" onclick="openAddHostModal()" data-remote-host-edit="true">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="icon-gap"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            Add Host
                         </button>
                         <button class="btn btn-secondary btn-sm" onclick="saveRemoteHosts()" data-remote-host-edit="true">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="icon-gap"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                            Save
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="checkRemoteRepos()">
                           <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="icon-gap"><path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16"></path></svg>
                           Sprawdź repo
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="updateRemoteRepos()">
                           <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="icon-gap"><path d="M12 3v3m0 12v3M4.2 4.2l2.1 2.1m11.4 11.4l2.1 2.1M3 12h3m12 0h3M4.2 19.8l2.1-2.1m11.4-11.4l2.1-2.1"></path></svg>
                           Aktualizuj
                        </button>
                    </div>
                </div>
                <div class="card-body">

                     <div id="remoteHostsContainer" class="host-grid">
                        <!-- Dynamic Content -->
                     </div>
                </div>
            </div>

            <!-- Remote Deployment (integrated into "+ Add Host" modal) -->
            <!-- The deployment functionality has been merged into the host configuration modal.
                 Use the "+ Add Host" button above and check "Auto-deploy" to provision new machines. -->

            <!-- Chrome Profile Sync -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                            <path d="M21 12a9 9 0 1 0-11.08 8.77"/>
                            <path d="M12 7v5l2 2"/>
                            <path d="M17 17l4-4-4-4"/>
                        </svg>
                        Synchronizacja profili Chrome
                    </h3>
                </div>
                <div class="card-body">
                    <p class="text-secondary text-sm mb-md">
                        Kopiuj profile Chrome między hostami (np. z lokalnego na zdalny serwer OCR).
                    </p>
                    
                    <form id="profileSyncForm" onsubmit="syncChromeProfile(event)">
                        <div class="settings-section-divider text-sm font-medium text-secondary">Źródło</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Host źródłowy</label>
                                <select id="syncSourceHost" class="form-control" onchange="loadSourceProfiles()">
                                    <option value="local" selected>Lokalny (ten komputer)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Profil do skopiowania</label>
                                <select id="syncProfileName" class="form-control">
                                    <option value="">Ładowanie profili...</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="settings-section-divider text-sm font-medium text-secondary">Cel</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Host docelowy</label>
                                <select id="syncTargetHost" class="form-control">
                                    <option value="">Wybierz host...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Użytkownik SSH</label>
                                <input type="text" id="syncTargetUser" class="form-control" placeholder="tomaasz">
                            </div>
                        </div>
                        
                        <div class="flex gap-sm" style="margin-top: 16px;">
                            <button type="submit" class="btn btn-primary" id="syncProfileBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 1l4 4-4 4"/>
                                    <path d="M3 11V9a4 4 0 0 1 4-4h14"/>
                                    <path d="M7 23l-4-4 4-4"/>
                                    <path d="M21 13v2a4 4 0 0 1-4 4H3"/>
                                </svg>
                                Synchronizuj profil
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="loadSourceProfiles()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M23 4v6h-6"/>
                                    <path d="M1 20v-6h6"/>
                                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                                </svg>
                                Odśwież profile
                            </button>
                        </div>
                    </form>
                    
                    <!-- Sync Result -->
                    <div id="profileSyncResult" style="display: none; margin-top: 16px;">
                        <div id="profileSyncLog" style="
                            background: #0f172a;
                            color: #e2e8f0;
                            padding: 12px;
                            border-radius: 8px;
                            font-family: 'JetBrains Mono', monospace;
                            font-size: 12px;
                            max-height: 200px;
                            overflow-y: auto;
                            white-space: pre-wrap;
                        "></div>
                    </div>
                </div>
            </div>

          </div>
        </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="hostConfigModal">
        <div class="modal" style="max-width: 800px; width: 95%;">
            <div class="modal-header">
                <h3 class="modal-title">Konfiguracja Hosta</h3>
                <button class="btn btn-ghost btn-icon" onclick="closeHostConfigModal()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <input type="hidden" id="editHostIndex">
                
                <div class="settings-grid">
                    <div class="form-group" style="grid-column: span 2;">
                        <label class="compact-form-label" for="hostName">Nazwa wyświetlana</label>
                        <input type="text" class="compact-form-input" id="hostName" placeholder="np. Ubuntu VPS">
                    </div>

                    <!-- Roles -->
                    <div class="form-group" style="grid-column: span 2;">
                         <div class="compact-form-label">Role hosta</div>
                         <div class="flex gap-md mt-2">
                             <label class="compact-checkbox-label">
                                 <input type="checkbox" id="hostRoleWorker" class="compact-checkbox">
                                 <span class="compact-checkbox-span">Worker (OCR)</span>
                             </label>
                             <label class="compact-checkbox-label">
                                 <input type="checkbox" id="hostRoleBrowser" class="compact-checkbox">
                                 <span class="compact-checkbox-span">Browser (Playwright)</span>
                             </label>
                         </div>
                    </div>

                    <!-- Worker / Common Settings -->
                    <div class="settings-section-divider text-sm font-medium text-secondary" style="grid-column: span 2;">Połączenie SSH</div>
                    
                    <div class="form-group">
                        <label class="compact-form-label" for="hostAddress">Host (IP/DNS)</label>
                        <input type="text" class="compact-form-input" id="hostAddress" placeholder="192.168.1.10">
                    </div>
                    <div class="form-group">
                        <label class="compact-form-label" for="hostUser">Użytkownik</label>
                        <input type="text" class="compact-form-input" id="hostUser" placeholder="root">
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label class="compact-form-label" for="hostSshOpts">Opcje SSH (Klucz, Port)</label>
                        <input type="text" class="compact-form-input" id="hostSshOpts" placeholder="-p 22 -i /path/to/key">
                    </div>

                    <div class="form-group" style="grid-column: span 2;">
                        <label class="compact-form-label" for="hostOsType">System operacyjny hosta</label>
                        <select class="compact-form-input" id="hostOsType" style="max-width: 200px;">
                            <option value="linux">🐧 Linux (Ubuntu/Arch)</option>
                            <option value="windows">🪟 Windows</option>
                        </select>
                        <small class="text-secondary" style="font-size: 0.75rem; margin-top: 2px; display: block;">Wpływa na format ścieżek w przeglądarce plików</small>
                    </div>

                    <div class="settings-section-divider text-sm font-medium text-secondary" style="grid-column: span 2;">Ścieżki & Worker</div>

                    <div class="form-group">
                        <label class="compact-form-label" for="hostRepoDir">Katalog repozytorium</label>
                        <div class="input-group">
                            <input type="text" class="compact-form-input" id="hostRepoDir" placeholder="/app/ocr-dashboard">
                            <button type="button" class="btn btn-secondary btn-sm" onclick="selectDirectory('hostRepoDir')" title="Wybierz folder">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                                </svg>
                            </button>
                        </div>
                        <small class="text-secondary" style="font-size: 0.75rem; margin-top: 2px; display: block;">💡 Wpisz pełną ścieżkę (np. C:\Users\user\app lub /home/user/app)</small>
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label class="compact-form-label" for="hostPythonPath">Komenda Python / Venv</label>
                        <div class="input-group">
                            <input type="text" class="compact-form-input" id="hostPythonPath" placeholder="/app/venv/bin/python3">
                            <button type="button" class="btn btn-secondary btn-sm" onclick="selectFile('hostPythonPath')" title="Wybierz plik">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                                    <polyline points="13 2 13 9 20 9"></polyline>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="form-group" style="grid-column: span 2;">
                        <label class="compact-form-label" for="hostNasSource">📁 Źródło NAS (SSHFS auto-mount)</label>
                        <input type="text" class="compact-form-input" id="hostNasSource" placeholder="user@nas-host:/volume1/Sources">
                        <small class="text-secondary" style="font-size: 0.75rem; margin-top: 2px; display: block;">Opcjonalnie: ścieżka NAS w formacie SSH. Zostanie automatycznie zamontowana w <code>~/ocr_mounts/sources</code> na tym hoście przed uruchomieniem workerów.</small>
                    </div>

                    <!-- Browser Specific -->
                    <div id="hostBrowserSettings" style="grid-column: span 2; display: contents;">
                        <div class="settings-section-divider text-sm font-medium text-secondary" style="grid-column: span 2; margin-top: 10px;">Ustawienia Przeglądarki (Playwright)</div>
                        
                        <div class="form-group">
                             <label class="compact-form-label" for="hostProfileRoot">Ścieżka Profile Root</label>
                             <div class="input-group">
                                 <input type="text" class="compact-form-input" id="hostProfileRoot" placeholder="/home/user/.cache/profiles">
                                 <button type="button" class="btn btn-secondary btn-sm" onclick="selectDirectory('hostProfileRoot')" title="Wybierz folder">
                                     <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                         <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                                     </svg>
                                 </button>
                             </div>
                             <small class="text-secondary" style="font-size: 0.75rem; margin-top: 2px; display: block;">💡 Katalog główny dla profili Chrome (np. C:\Users\user\.cache\profiles)</small>
                        </div>
                        <div class="form-group">
                             <label class="compact-form-label">Chrome Binary</label>
                             <div class="input-group">
                                 <input type="text" class="compact-form-input" id="hostChromeBin" placeholder="/usr/bin/google-chrome">
                                 <button type="button" class="btn btn-secondary btn-sm" onclick="selectFile('hostChromeBin')" title="Wybierz plik">
                                     <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                         <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                                         <polyline points="13 2 13 9 20 9"></polyline>
                                     </svg>
                                 </button>
                             </div>
                             <small class="text-secondary" style="font-size: 0.75rem; margin-top: 2px; display: block;">💡 Pełna ścieżka do pliku wykonywalnego Chrome/Chromium</small>
                        </div>
                        <div class="host-port-grid" style="grid-column: span 2;">
                             <div class="form-group">
                                <label class="compact-form-label">Port Base</label>
                                <input type="number" class="compact-form-input" id="hostPortBase" value="9222">
                             </div>
                             <div class="form-group">
                                <label class="compact-form-label">Port Span</label>
                                <input type="number" class="compact-form-input" id="hostPortSpan" value="100">
                             </div>
                             <div class="form-group">
                                <label class="compact-form-label">Local Port Base</label>
                                <input type="number" class="compact-form-input" id="hostLocalPortBase" value="9222">
                             </div>
                        </div>

                        <div class="form-group" style="grid-column: span 2;">
                             <label class="compact-checkbox-label">
                                 <input type="checkbox" id="hostTunnel" class="compact-checkbox">
                                 <span class="compact-checkbox-span">Używaj Tunelowania SSH (zalecane)</span>
                             </label>
                        </div>
                    </div>

                    <!-- Auto-Deploy Section -->
                    <div class="settings-section-divider text-sm font-medium text-secondary" style="grid-column: span 2; margin-top: 16px;">Automatyczny Deployment</div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label class="compact-checkbox-label">
                            <input type="checkbox" id="hostAutoDeploy" class="compact-checkbox" onchange="toggleHostDeploySection()">
                            <span class="compact-checkbox-span">🚀 Auto-deploy (zainstaluj na nowej maszynie)</span>
                        </label>
                        <small class="text-secondary" style="font-size: 0.75rem; display: block; margin-top: 4px;">Zaznacz jeśli to nowy host i chcesz automatycznie zainstalować wszystkie zależności (Python, venv, Playwright, NAS mount itp.)</small>
                    </div>

                    <div id="hostDeploySection" style="grid-column: span 2; display: none;">
                        <div class="settings-grid" style="gap: 8px;">
                            <!-- OS Type -->
                            <div class="form-group" style="grid-column: span 2;">
                                <label class="compact-form-label">System operacyjny</label>
                                <div class="flex gap-sm">
                                    <label class="compact-checkbox-label">
                                        <input type="radio" name="hostDeployOs" value="ubuntu" checked>
                                        <span class="compact-checkbox-span">Ubuntu 20.04+</span>
                                    </label>
                                    <label class="compact-checkbox-label">
                                        <input type="radio" name="hostDeployOs" value="arch">
                                        <span class="compact-checkbox-span">Arch Linux</span>
                                    </label>
                                    <label class="compact-checkbox-label">
                                        <input type="radio" name="hostDeployOs" value="windows">
                                        <span class="compact-checkbox-span">Windows 11</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Sudo Password -->
                            <div class="form-group">
                                <label class="compact-form-label" for="hostDeploySudoPass">Hasło sudo</label>
                                <div style="position: relative;">
                                    <input type="password" class="compact-form-input" id="hostDeploySudoPass" placeholder="Hasło dla sudo" style="padding-right: 36px;">
                                    <button type="button" class="btn btn-ghost btn-icon" onclick="togglePasswordVisibility('hostDeploySudoPass', this)" style="position: absolute; right: 2px; top: 50%; transform: translateY(-50%); padding: 2px;" title="Pokaż/ukryj hasło">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="eye-icon">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                            <circle cx="12" cy="12" r="3"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <!-- GitHub Repo -->
                            <div class="form-group">
                                <label class="compact-form-label" for="hostDeployGithubRepo">GitHub Repo</label>
                                <input type="text" class="compact-form-input" id="hostDeployGithubRepo" value="https://github.com/tomaasz/ocr-dashboard-v3" placeholder="https://github.com/user/repo">
                            </div>

                            <!-- NAS Config -->
                            <div class="form-group">
                                <label class="compact-form-label" for="hostDeployNasHost">NAS Host</label>
                                <input type="text" class="compact-form-input" id="hostDeployNasHost" placeholder="192.168.1.10" value="100.80.240.52">
                            </div>
                            <div class="form-group">
                                <label class="compact-form-label" for="hostDeployNasShare">NAS Share</label>
                                <input type="text" class="compact-form-input" id="hostDeployNasShare" placeholder="scans" value="Genealogy">
                            </div>
                            <div class="form-group">
                                <label class="compact-form-label" for="hostDeployNasUser">NAS Username</label>
                                <input type="text" class="compact-form-input" id="hostDeployNasUser" placeholder="admin">
                            </div>
                            <div class="form-group">
                                <label class="compact-form-label" for="hostDeployNasPass">NAS Password</label>
                                <div style="position: relative;">
                                    <input type="password" class="compact-form-input" id="hostDeployNasPass" style="padding-right: 36px;">
                                    <button type="button" class="btn btn-ghost btn-icon" onclick="togglePasswordVisibility('hostDeployNasPass', this)" style="position: absolute; right: 2px; top: 50%; transform: translateY(-50%); padding: 2px;" title="Pokaż/ukryj hasło">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="eye-icon">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                            <circle cx="12" cy="12" r="3"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <!-- PostgreSQL -->
                            <div class="form-group" style="grid-column: span 2;">
                                <label class="compact-checkbox-label">
                                    <input type="checkbox" id="hostDeployPostgres" class="compact-checkbox">
                                    <span class="compact-checkbox-span">Zainstaluj lokalny PostgreSQL</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Deployment Log (inline in modal) -->
                    <div id="hostDeployLogContainer" style="grid-column: span 2; display: none; margin-top: 12px;">
                        <div class="settings-section-divider text-sm font-medium text-secondary">Logi deployment</div>
                        <div id="hostDeployLog" style="
                            background: #0f172a;
                            color: #e2e8f0;
                            padding: 12px;
                            border-radius: 8px;
                            font-family: 'JetBrains Mono', monospace;
                            font-size: 11px;
                            max-height: 300px;
                            overflow-y: auto;
                            margin-top: 8px;
                            white-space: pre-wrap;
                        ">Oczekiwanie na deployment...</div>
                        <div class="flex gap-sm" style="margin-top: 8px;">
                            <button type="button" class="btn btn-secondary btn-sm" onclick="copyHostDeployLogs()">Kopiuj logi</button>
                        </div>
                    </div>

                    <!-- Host Test Result -->
                    <div id="hostTestResultContainer" style="grid-column: span 2; display: none; margin-top: 12px;">
                        <div class="settings-section-divider text-sm font-medium text-secondary">Wynik testu hosta</div>
                        <div id="hostTestResult" style="
                            background: #0f172a;
                            color: #e2e8f0;
                            padding: 12px;
                            border-radius: 8px;
                            font-family: 'JetBrains Mono', monospace;
                            font-size: 11px;
                            max-height: 220px;
                            overflow-y: auto;
                            margin-top: 8px;
                            white-space: pre-wrap;
                        ">Brak testu.</div>
                    </div>

                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="hostTestBtn" onclick="testHostConfig()" disabled>Test hosta</button>
                <button class="btn btn-secondary" onclick="closeHostConfigModal()">Anuluj</button>
                <button class="btn btn-primary" id="hostSaveBtn" onclick="saveHostConfig()" data-remote-host-edit="true">Zapisz</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
      <div class="modal">
        <div class="modal-header">
          <h3>Usuń profil</h3>
          <button class="modal-close" onclick="closeDeleteModal()">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <p>
            Czy na pewno chcesz usunąć profil
            <strong id="deleteProfileName"></strong>?
          </p>
          <p class="text-danger" id="deleteProfileBlockedMsg" style="display: none;">
            Nie można usunąć profilu domyślnego.
          </p>
          <p class="text-danger">
            Ta operacja jest nieodwracalna. Usunięte zostaną:
          </p>
          <ul class="text-secondary" style="margin-left: 20px">
            <li>Katalog profilu</li>
            <li>Pliki konfiguracyjne</li>
            <li>Historia lokalna</li>
          </ul>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeDeleteModal()">
            Anuluj
          </button>
          <button class="btn btn-danger" id="deleteProfileConfirmBtn" onclick="confirmDeleteProfile()">
            Usuń
          </button>
        </div>
      </div>
    </div>

    <!-- Delete Host Confirmation Modal -->
    <div class="modal-overlay" id="deleteHostModal">
      <div class="modal" style="max-width: 420px;">
        <div class="modal-header" style="border-bottom: 1px solid var(--color-border);">
          <div class="flex items-center gap-sm">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--color-danger)" stroke-width="2">
              <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
              <line x1="10" y1="11" x2="10" y2="17"/>
              <line x1="14" y1="11" x2="14" y2="17"/>
            </svg>
            <h3 style="color: var(--color-text-primary);">Usuń host zdalny</h3>
          </div>
          <button class="modal-close" onclick="closeDeleteHostModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding: 20px;">
          <p class="text-secondary" style="margin-bottom: 12px;">
            Czy na pewno chcesz usunąć host <strong id="deleteHostName" style="color: var(--color-text-primary);"></strong>?
          </p>
          <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 12px; margin-top: 12px;">
            <p class="text-sm" style="color: var(--color-danger); margin: 0;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: -2px; margin-right: 6px;">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
              </svg>
              Host zostanie usunięty tylko z konfiguracji. Oprogramowanie na serwerze pozostanie zainstalowane.
            </p>
          </div>
        </div>
        <div class="modal-footer" style="border-top: 1px solid var(--color-border); padding: 16px 20px;">
          <button class="btn btn-secondary" onclick="closeDeleteHostModal()">
            Anuluj
          </button>
          <button class="btn btn-danger" id="deleteHostConfirmBtn" onclick="confirmDeleteHost()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="icon-gap">
              <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
            </svg>
            Usuń host
          </button>
        </div>
      </div>
    </div>

    <!-- Login Logs Modal -->
    <div class="modal-overlay" id="loginLogModal">
      <div class="modal" style="max-width: 800px; width: 90%">
        <div class="modal-header">
          <h3>Logowanie: <span id="loginLogProfileName"></span></h3>
          <button class="modal-close" onclick="closeLoginLogModal()">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <div class="info-banner" style="margin-bottom: 10px">
            <i class="fas fa-info-circle"></i> To okno pokazuje logi z procesu
            logowania HEADED. Jeśli widzisz błąd "Brak serwera X / DISPLAY",
            upewnij się, że masz uruchomiony X Server (np. Xming/VcXsrv) i
            skonfigurowany DISPLAY w Ustawieniach.
          </div>
          <div
            class="log-viewer"
            id="loginLogContent"
            style="
              height: 400px;
              background: #0f172a;
              color: #e2e8f0;
              padding: 15px;
              overflow: auto;
              font-family: &quot;JetBrains Mono&quot;, monospace;
              font-size: 13px;
              border-radius: 6px;
              border: 1px solid var(--border-color);
            "
          >
            Inicjalizacja procesu logowania...
          </div>
        </div>
        <div class="modal-footer" style="display: flex; justify-content: space-between; align-items: center;">
          <button class="btn btn-primary" onclick="copyLoginLogs()" id="copyLoginLogsBtn" style="display: flex; align-items: center; gap: 8px;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            Kopiuj logi
          </button>
          <button class="btn btn-secondary" onclick="closeLoginLogModal()">
            Zamknij
          </button>
        </div>
      </div>
    </div>

    <!-- Profile Details Modal -->
    <div class="modal-overlay" id="profileModal">
      <div class="modal" style="max-width: 820px; width: 92%;">
        <div class="modal-header">
          <h3 class="modal-title">Szczegóły profilu: <span id="modalProfileName"></span></h3>
          <button class="modal-close" onclick="closeModal()">
            &times;
          </button>
        </div>
        <div class="modal-body" id="modalContent">
          <!-- Content will be populated by JavaScript -->
        </div>
        <div class="modal-footer" style="display: flex; justify-content: space-between; align-items: center;">
          <button class="btn btn-primary" onclick="copyProfileInfo()" style="display: flex; align-items: center; gap: 8px;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            Kopiuj informacje
          </button>
          <button class="btn btn-secondary" onclick="closeModal()">
            Zamknij
          </button>
        </div>
      </div>
    </div>

    <!-- Cleanup Modal -->
    <div class="modal-overlay" id="cleanupModal">
      <div class="modal" style="max-width: 450px">
        <div class="modal-header">
          <h3 class="modal-title">Wyczyść foldery</h3>
          <button class="modal-close" onclick="closeCleanupModal()">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <p
            class="text-secondary"
            style="font-size: 13px; margin-bottom: var(--spacing-md)"
          >
            Wybierz foldery do wyczyszczenia:
          </p>
          <div class="cleanup-options">
            <label class="checkbox-label">
              <input type="checkbox" id="cleanupJobs-modal" checked />
              <span>jobs/</span>
              <span
                class="text-secondary"
                style="font-size: 11px; margin-left: auto"
                >Dane jobów</span
              >
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="cleanupLogs-modal" checked />
              <span>logs/</span>
              <span
                class="text-secondary"
                style="font-size: 11px; margin-left: auto"
                >Logi aplikacji</span
              >
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="cleanupArtifacts-modal" />
              <span>artifacts/</span>
              <span
                class="text-secondary"
                style="font-size: 11px; margin-left: auto"
                >Wygenerowane pliki</span
              >
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="cleanupUiHealth-modal" />
              <span>artifacts/screenshots/ui_health/</span>
              <span
                class="text-secondary"
                style="font-size: 11px; margin-left: auto"
                >Screenshoty podglądu</span
              >
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="cleanupTestResults-modal" />
              <span>test-results/</span>
              <span
                class="text-secondary"
                style="font-size: 11px; margin-left: auto"
                >Wyniki testów</span
              >
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="cleanupPycache-modal" />
              <span>__pycache__</span>
              <span
                class="text-secondary"
                style="font-size: 11px; margin-left: auto"
                >Cache Pythona</span
              >
            </label>
          </div>
          <div
            style="
              margin-top: var(--spacing-md);
              padding-top: var(--spacing-md);
              border-top: 1px solid var(--color-border);
            "
          >
            <label class="checkbox-label">
              <input type="checkbox" id="cleanupForce-modal" />
              <span>Force</span>
              <span
                class="text-secondary"
                style="font-size: 11px; margin-left: auto"
                >Wymuś nawet gdy joby działają</span
              >
            </label>
          </div>
          <div
            class="text-secondary"
            style="font-size: 12px; margin-top: var(--spacing-sm); display: flex; align-items: center; justify-content: space-between;"
          >
            <span id="cleanupStatus-modal"></span>
            <button class="btn btn-ghost btn-sm" onclick="copyFromElement('cleanupStatus-modal', this)" title="Kopiuj status" style="display: none;" id="cleanupCopyBtn">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeCleanupModal()">
            Anuluj
          </button>
          <button
            class="btn btn-danger"
            onclick="runCleanup('-modal')"
            id="cleanupExecuteBtn-modal"
          >
            Wyczyść
          </button>
        </div>
      </div>
    </div>

    <!-- Restart Confirmation Modal -->
    <div class="modal-overlay" id="restartModal">
      <div class="modal" style="max-width: 400px">
        <div class="modal-header">
          <h3 class="modal-title">Zrestartuj aplikację</h3>
          <button class="modal-close" onclick="closeRestartModal()">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <p>Czy na pewno chcesz zrestartować aplikację?</p>
          <p
            class="text-secondary"
            style="font-size: 12px; margin-top: var(--spacing-sm)"
          >
            Wszystkie aktywne joby zostaną zatrzymane. Strona zostanie
            automatycznie odświeżona po restarcie.
          </p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeRestartModal()">
            Anuluj
          </button>
          <button class="btn btn-warning" onclick="confirmRestartApp()">
            Restartuj
          </button>
        </div>
      </div>
    </div>

    <!-- Full Reset Report Modal -->
    <div class="modal-overlay" id="restartReportModal">
      <div class="modal" style="max-width: 520px">
        <div class="modal-header">
          <h3 class="modal-title">Raport Full Reset</h3>
          <button class="modal-close" onclick="closeRestartReportModal()">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <p id="restartReportSummary"></p>
          <div
            id="restartReportList"
            style="max-height: 320px; overflow: auto; margin-top: var(--spacing-sm)"
          ></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" onclick="closeRestartReportModal()">
            OK
          </button>
        </div>
      </div>
    </div>

    <!-- Reset Config Confirmation Modal -->
    <div class="modal-overlay" id="resetConfigModal">
      <div class="modal" style="max-width: 400px">
        <div class="modal-header">
          <h3 class="modal-title">Przywróć domyślne</h3>
          <button class="modal-close" onclick="closeResetConfigModal()">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <p>Czy na pewno chcesz przywrócić domyślne ustawienia konfiguracji?</p>
          <p
            class="text-secondary"
            style="font-size: 12px; margin-top: var(--spacing-sm)"
          >
            Wszystkie wprowadzone zmiany w formularzu zostaną utracone.
          </p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeResetConfigModal()">
            Anuluj
          </button>
          <button class="btn btn-primary" onclick="confirmResetJobConfig()">
            Przywróć
          </button>
        </div>
      </div>
    </div>

    <!-- Image Preview Modal -->
    <div
      class="modal-overlay"
      id="imagePreviewModal"
      onclick="closeImagePreview()"
      style="background: rgba(0, 0, 0, 0.9)"
    >
      <div class="image-preview-container" role="presentation" onclick="event.stopPropagation()">
        <button class="image-preview-close" onclick="closeImagePreview()">
          &times;
        </button>
        <img id="imagePreviewImg" src="" alt="Preview" />
        <div class="image-preview-info" id="imagePreviewInfo"></div>
      </div>
    </div>

    <!-- Non-Pro Banner (sticky warning) -->
    <div id="nonProBanner" class="alert-banner warning hidden">
      <svg
        width="16"
        height="16"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <path
          d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"
        />
        <line x1="12" y1="9" x2="12" y2="13" />
        <line x1="12" y1="17" x2="12.01" y2="17" />
      </svg>
      <span
        >Odrzucone wyniki nie-Pro w sesji:
        <strong id="nonProCount">0</strong></span
      >
      <span class="text-secondary" style="margin-left: var(--spacing-sm)"
        >Profil(e): <span id="nonProProfiles">-</span>
        <button class="btn btn-ghost btn-sm" onclick="copyFromElement('nonProProfiles', this)" title="Kopiuj listę" style="padding: 0 4px; height: 16px; margin-left: 4px;">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
        </button>
      </span>
      <button class="btn btn-ghost btn-sm" onclick="hideNonProBanner()">
        ×
      </button>
    </div>

    <!-- Add Profile Modal -->
    <div class="modal-overlay" id="addProfileModal">
      <div class="modal" style="max-width: 400px">
        <div class="modal-header">
          <h3 class="modal-title">Dodaj nowy profil</h3>
          <button class="modal-close" onclick="closeAddProfileModal()">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Nazwa profilu</label>
            <input
              type="text"
              class="form-input"
              id="newProfileName-modal"
              placeholder="np. user123"
            />
            <p
              class="text-secondary"
              style="font-size: 11px; margin-top: var(--spacing-xs)"
            >
              Nazwa będzie użyta jako suffix: gemini-profile-[nazwa]
            </p>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeAddProfileModal()">
            Anuluj
          </button>
          <button class="btn btn-primary" onclick="confirmAddProfile()">
            Dodaj profil
          </button>
        </div>
      </div>
    </div>



    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <script>
      // ============================================
      // Internationalization (i18n)
      // ============================================

      const translations = {
        pl: {
          // Sidebar
          "nav.menu": "Menu",
          "nav.overview": "Przegląd",
          "nav.profiles": "Profile",
          "nav.preview": "Podgląd",
          "nav.logs": "Logi",
          "nav.limits": "Limity",
          "nav.postprocess": "Post-Process",
          "nav.settings": "Ustawienia",
          "nav.quickStatus": "Szybki status",
          "nav.active": "Aktywne",
          "nav.paused": "Wstrzymane",
          "nav.limit": "Limit",
          "nav.todayScans": "Dzisiejsze skany",
          "nav.collapse": "Zwiń",

          // Header
          "header.active": "Aktywnych",
          "header.paused": "Wstrzymanych",
          "header.limit": "Limit",
          "header.today": "Dzisiaj",
          "header.proEst": "Pro Est.",
          "header.batch": "Batch",
          "header.startJob": "Start Job",
          "header.stopAll": "Stop All",
          "header.restart": "Restart",
          "header.cleanup": "Cleanup",

          // Overview
          "overview.title": "Przegląd",
          "overview.subtitle": "Podsumowanie stanu farmy OCR",
          "overview.lastUpdate": "Ostatnia aktualizacja",
          "overview.totalProfiles": "Wszystkich profili",
          "overview.activeWorkers": "Aktywnych workerów",
          "overview.processedToday": "Przetworzonych dziś",
          "overview.errorRate": "Błędów",
          "overview.recentActivity": "Ostatnia aktywność",
          "overview.noActivity": "Brak aktywności",
          "overview.activityWillAppear":
            "Aktywność pojawi się tutaj po rozpoczęciu przetwarzania.",

          // Profiles
          "profiles.title": "Profile",
          "profiles.subtitle": "Zarządzanie profilami Gemini",
          "profiles.search": "Szukaj profilu...",
          "profiles.all": "Wszystkie",
          "profiles.active": "Aktywne",
          "profiles.idle": "Bezczynne",
          "profiles.error": "Błąd",
          "profiles.select": "Zaznacz",
          "profiles.cancel": "Anuluj",
          "profiles.processed": "Przetw.",
          "profiles.tokens": "Tokeny",
          "profiles.errors": "Błędy",
          "profiles.mode": "Tryb",
          "profiles.lastActivity": "Ostatnia aktywność",
          "profiles.actions": "Akcje",
          "profiles.start": "Start",
          "profiles.stop": "Stop",
          "profiles.login": "Login",
          "profiles.info": "Info",
          "profiles.delete": "Usuń",

          // Live Preview
          "preview.title": "Podgląd na żywo",
          "preview.subtitle": "Podgląd i aktywność aktywnych workerów",
          "preview.refreshAll": "Odśwież wszystkie",
          "preview.autoRefresh": "Auto-odświeżanie (10s)",
          "preview.noWorkers": "Brak aktywnych workerów",
          "preview.screenshotsWillAppear":
            "Screenshoty pojawią się tutaj po uruchomieniu jobów.",

          // Logs
          "logs.title": "Logi",
          "logs.subtitle": "Logi systemowe i błędy",
          "logs.noLogs": "Brak logów",
          "logs.willAppear":
            "Logi pojawią się tutaj po rozpoczęciu przetwarzania.",

          // Limits
          "limits.title": "Limits Checker",
          "limits.subtitle": "Sprawdzanie statusu limitów Pro dla profili",
          "limits.lastCheck": "Ostatni check",
          "limits.okProfiles": "Profile OK",
          "limits.limitedProfiles": "Z limitem",
          "limits.sessionRuns": "Checki w sesji",
          "limits.selectProfiles": "Wybierz profile do sprawdzenia",
          "limits.selectAll": "Wszystkie",
          "limits.selectNone": "Żadne",
          "limits.quickMode": "Quick Mode",
          "limits.parallel": "Równolegle",
          "limits.host": "Host",
          "limits.runCheck": "Sprawdź limity",
          "limits.results": "Wyniki",
          "limits.profile": "Profil",
          "limits.status": "Status",
          "limits.proRemaining": "Pro pozostało",
          "limits.resetTime": "Reset",
          "limits.checkedAt": "Sprawdzono",
          "limits.noResults": "Brak wyników",
          "limits.runCheckFirst": "Uruchom sprawdzanie aby zobaczyć wyniki.",

          // Post-Process
          "postprocess.title": "Post-Processing",
          "postprocess.subtitle": "Strukturyzacja danych OCR",
          "postprocess.status": "Status",
          "postprocess.startProcessing": "Start Processing",
          "postprocess.stopProcessing": "Stop Processing",
          "postprocess.apiKey": "API Key (OpenRouter)",
          "postprocess.apiKeyHint":
            "Opcjonalne. Zostaw puste aby używać przeglądarki (darmowe).",
          "postprocess.stats": "Statystyki",
          "postprocess.newToProcess": "Nowe do przetworzenia",
          "postprocess.processed": "Przetworzone",
          "postprocess.tools": "Narzędzia",
          "postprocess.createTables": "Utwórz tabele (normalizacja DB)",
          "postprocess.createTablesHint":
            "Tworzy tabele documents i entries zamiast kolumn JSON.",

          // Settings
          "settings.title": "Ustawienia",
          "settings.subtitle": "Konfiguracja systemu",
          "settings.general": "Ogólne",
          "settings.generalSystem": "Ogólne + System",
          "settings.autoRestart": "Auto-restart workerów po błędzie",
          "settings.display": "Wyświetlanie",
          "settings.x11Display": "X11 DISPLAY",
          "settings.updateCountsOnNewPaths": "Aktualizuj liczniki przy nowych folderach",
          "settings.updateCountsPollSec": "Interwał sprawdzania (sek.)",
          "settings.remoteConfig": "Konfiguracja zdalna",
          "settings.enableRemote": "Włącz zdalne uruchamianie",
          "settings.remoteHosts": "Hosty zdalne",
          "settings.remoteWorker": "Remote worker (WSL/Ubuntu)",
          "settings.remoteBrowser": "Remote browser (Chrome)",
          "settings.remoteHostsSave": "Zapisz hosty",
          "settings.remoteHost": "Host",
          "settings.remoteUser": "Użytkownik",
          "settings.remoteRepoDir": "Katalog repo",
          "settings.remoteSourceDir": "Katalog źródeł",
          "settings.remoteSshOpts": "Opcje SSH",
          "settings.remoteBrowserProfileRoot": "Katalog profili",
          "settings.remoteBrowserPython": "Python",
          "settings.remoteBrowserChromeBin": "Chrome bin",
          "settings.remoteBrowserPortBase": "Port bazowy",
          "settings.remoteBrowserPortSpan": "Zakres portów",
          "settings.remoteBrowserLocalPortBase": "Local port base",
          "settings.presetWslWorker": "Preset: WSL worker",
          "settings.presetWslBrowser": "Preset: WSL browser",
          "settings.advanced": "Zaawansowane",
          "settings.maintenance": "Konserwacja",
          "settings.cleanupFolders": "Wyczyść foldery tymczasowe",
          "settings.syncProfiles": "Synchronizuj profile z remote",
          "settings.language": "Język",
          "settings.webshare": "Webshare Sync",
          "settings.webshareToken": "API Token",
          "settings.webshareMode": "Tryb proxy",
          "settings.websharePlanId": "Plan ID",
          "settings.websharePageSize": "Page size",
          "settings.webshareCountries": "Kody krajów",
          "settings.webshareMinValid": "Tylko valid",
          "settings.proxyDisabledGlobal": "Wyłącz proxy dla całej farmy",
          "settings.webshareSeed": "Seed",
          "settings.webshareSyncNow": "Sync teraz",
          "settings.tooltips.updateCountsOnNewPaths":
            "Fallback: gdy LISTEN/NOTIFY nie działa, uruchom update_counts.sh po wykryciu nowych folderów.",
          "settings.tooltips.updateCountsPollSec":
            "Fallback co ile sekund sprawdzać nowe source_path. 0 = wyłącz.",

          // Start Job Modal
          "startJob.title": "Uruchom Job OCR",
          "startJob.basic": "Podstawowe",
          "startJob.performance": "Wydajność",
          "startJob.database": "Baza danych",
          "startJob.preprocess": "Preprocess",
          "startJob.advanced": "Zaawansowane",
          "startJob.sourcePath": "Folder źródłowy",
          "startJob.batchId": "Batch ID",
          "startJob.headedMode": "Tryb okienkowy (pokazuj przeglądarkę)",
          "startJob.engine": "Silnik OCR",
          "startJob.profilesToRun": "Profile do uruchomienia",
          "startJob.all": "Wszystkie",
          "startJob.okLimit": "OK Limit",
          "startJob.clear": "Wyczyść",
          "startJob.addProfile": "Dodaj",
          "startJob.cancel": "Anuluj",
          "startJob.run": "Uruchom Job",

          "nav.jobconfig": "Konfiguracja Job",
          "job.title": "Konfiguracja Job",
          "job.subtitle": "Ustawienia nowego zadania OCR",
          "job.startBtn": "Uruchom Job",
          "job.resetBtn": "Przywróć domyślne",

          "job.tabs.basic": "Podstawowe",
          "job.tabs.performance": "Wydajność",
          "job.tabs.database": "Baza danych",
          "job.tabs.preprocess": "Przetwarzanie obrazu",
          "job.tabs.advanced": "Zaawansowane",

          "job.basic.sourcePath": "Ścieżka źródłowa",
          "job.basic.batchId": "ID Partii (Batch ID)",
          "job.basic.headed": "Tryb z oknem (Headed)",
          "job.basic.engine": "Silnik OCR",
          "profiles.headedMode": "Headed (dla nowych)",
          "profiles.headedModeTooltip": "Pokazuj okno przeglądarki dla nowo uruchamianych profili. Zmiana tego ustawienia nie wpływa na już działające profile.",
          "job.basic.profiles": "Profile do uruchomienia",
          "job.basic.all": "Wszystkie",
          "job.basic.okLimit": "OK Limit",
          "job.basic.clear": "Wyczyść",
          "job.basic.add": "Dodaj",

          "job.perf.windows": "Liczba okien (Chrome)",
          "job.perf.tabsPerWindow": "Karty na okno",
          "job.perf.totalWorkers": "Razem workerów",
          "job.perf.scans": "Skanów na worker",
          "job.perf.timeout": "Limit czasu (Collect Timeout)",
          "job.perf.tabsSection": "Karty przeglądarki",
          "job.perf.closeIdle": "Auto-zamykaj nieużywane",
          "job.perf.maxTabs": "Max kart / kontekst",
          "job.perf.ctxSection": "Konteksty",
          "job.perf.isolated": "Izolowane konteksty",
          "job.perf.pool": "Pula kontekstów",
          "job.perf.uiSection": "Profil UI",
          "job.perf.viewportW": "Viewport Width",
          "job.perf.viewportH": "Viewport Height",
          "job.perf.reducedMotion": "Ogranicz animacje",

          "job.db.enabled": "PostgreSQL Włączony",
          "job.db.dsn": "DSN Bazy",
          "job.db.table": "Tabela",
          "job.db.syncSection": "Synchronizacja",
          "job.db.syncBtn": "Synchronizuj profile (Remote)",
          "job.db.syncDesc": "Kopiuje lokalne profile (Gemini) na zdalnego workera",

          "job.prep.desc": "Parametry przetwarzania obrazu. Domyślne wartości są optymalne.",
          "job.prep.scaleSection": "Skalowanie i Szum",
          "job.prep.maxDim": "Max Dimension",
          "job.prep.median": "Median Kernel",
          "job.prep.denoise": "Denoise Strength",
          "job.prep.morph": "Morph Kernel",
          "job.prep.contrastSection": "Kontrast i Kontury",
          "job.prep.claheClip": "CLAHE Clip Limit",
          "job.prep.claheGrid": "CLAHE Grid Size",
          "job.prep.localSigma": "Local Contrast Sigma",
          "job.prep.localAmount": "Local Contrast Amount",

          "job.adv.mode": "Tryb pracy",
          "job.adv.continue": "Tryb kontynuacji (Continue)",
          "job.adv.autoAdvance": "Auto-advance folderów",
          "job.adv.proOnly": "Tylko model Pro",
          "job.adv.clean": "Czyść pliki tymczasowe",
          "job.adv.diagSection": "Diagnostyka",
          "job.adv.debug": "Debug Artifacts",
          "job.adv.video": "Nagrywaj wideo",

          "job.tooltips.sourcePath": "Folder na serwerze zawierający zdjęcia dokumentów do przetworzenia.",
          "job.tooltips.batchId": "Unikalny identyfikator partii (Batch ID). Jeśli puste, zostanie wygenerowany automatycznie.",
          "job.tooltips.headed": "Pokaż okno przeglądarki podczas pracy. Przydatne do obserwacji, ale działa wolniej.",
          "job.tooltips.engine": "Wybierz silnik OCR. 'Gemini' jest zalecany.",
          "job.tooltips.workers": "Liczba równoległych procesów. Więcej = szybciej, ale większe zużycie zasobów (CPU/RAM).",
          "job.tooltips.scans": "Ile dokumentów przetworzyć w jednej serii (instancji przeglądarki).",
          "job.tooltips.timeout": "Maksymalny czas oczekiwania na przetworzenie jednego dokumentu (sekundy).",
          "job.tooltips.closeIdle": "Zamykaj karty po zakonczeniu zadania, aby zwolnić pamięć RAM.",
          "job.tooltips.maxTabs": "Limit otwartych kart na kontekst przeglądarki. 0 = brak limitu.",
          "job.tooltips.isolated": "Uruchom każdego workera w osobnej instancji przeglądarki (większa stabilność).",
          "job.tooltips.pool": "Liczba przygotowanych kontekstów w puli.",
          "job.tooltips.reducedMotion": "Wyłącz animacje na stronach (może przyspieszyć działanie).",
          "job.tooltips.pgEnabled": "Włącz zapisywanie wyników do bazy danych PostgreSQL.",
          "job.tooltips.maxDim": "Przeskaluj obraz w dół, jeśli jest większy niż X pikseli.",
          "job.tooltips.median": "Filtr usuwający szum (kropki) z obrazu.",
          "job.tooltips.denoise": "Siła odszumiania.",
          "job.tooltips.morph": "Operacje morfologiczne poprawiające kształt liter.",
          "job.tooltips.continue": "Pomiń już przetworzone pliki (wznów przerwaną pracę).",
          "job.tooltips.autoAdvance": "Po ukończeniu folderu przejdź automatycznie do następnego.",
          "job.tooltips.proOnly": "Używaj tylko modelu Pro (najwyższa jakość).",
          "job.tooltips.clean": "Usuń pliki tymczasowe z dysku po zakończeniu pracy.",
          "job.tooltips.debug": "Zachowaj pliki debugowania (screenshoty, html) w razie błędu.",
          "job.tooltips.video": "Nagrywaj wideo z procesu (tylko w trybie Headed).",

          // Cleanup Modal

          // Cleanup Modal
          "cleanup.title": "Wyczyść foldery",
          "cleanup.selectFolders": "Wybierz foldery do wyczyszczenia:",
          "cleanup.jobs": "Dane jobów",
          "cleanup.logs": "Logi",
          "cleanup.artifacts": "Screenshoty debug",
          "cleanup.testResults": "Wyniki testów",
          "cleanup.pycache": "Cache Pythona",
          "cleanup.force": "Wymuś nawet gdy joby działają",
          "cleanup.cancel": "Anuluj",
          "cleanup.clean": "Wyczyść",

          // Restart Modal
          "restart.title": "Zrestartuj aplikację",
          "restart.confirm": "Czy na pewno chcesz zrestartować aplikację?",
          "restart.warning":
            "Wszystkie aktywne joby zostaną zatrzymane. Strona zostanie automatycznie odświeżona po restarcie.",
          "restart.cancel": "Anuluj",
          "restart.restart": "Restartuj",

          // Delete Modal
          "delete.title": "Potwierdź usunięcie",
          "delete.confirm": "Czy na pewno chcesz usunąć profil",
          "delete.warning": "Ta operacja jest nieodwracalna.",
          "delete.cancel": "Anuluj",
          "delete.delete": "Usuń",

          // Add Profile Modal
          "addProfile.title": "Dodaj nowy profil",
          "addProfile.name": "Nazwa profilu",
          "addProfile.hint":
            "Nazwa będzie użyta jako suffix: gemini-profile-[nazwa]",
          "addProfile.cancel": "Anuluj",
          "addProfile.add": "Dodaj profil",

          // File Browser
          "fileBrowser.title": "Wybierz folder",
          "fileBrowser.favorites": "Ulubione",
          "fileBrowser.up": "W górę",
          "fileBrowser.cancel": "Anuluj",
          "fileBrowser.select": "Wybierz",

          // Common
          "common.loading": "Ładowanie...",
          "common.error": "Błąd",
          "common.success": "Sukces",
          "common.save": "Zapisz",
          "common.cancel": "Anuluj",
          "common.close": "Zamknij",
          "common.refresh": "Odśwież",
          "common.actions": "Akcje",
        },

        en: {
          // Sidebar
          "nav.menu": "Menu",
          "nav.overview": "Overview",
          "nav.profiles": "Profiles",
          "nav.preview": "Preview",
          "nav.logs": "Logs",
          "nav.limits": "Limits",
          "nav.postprocess": "Post-Process",
          "nav.settings": "Settings",
          "nav.quickStatus": "Quick Status",
          "nav.active": "Active",
          "nav.paused": "Paused",
          "nav.limit": "Limit",
          "nav.todayScans": "Today's scans",
          "nav.collapse": "Collapse",

          // Header
          "header.active": "Active",
          "header.paused": "Paused",
          "header.limit": "Limit",
          "header.today": "Today",
          "header.proEst": "Pro Est.",
          "header.batch": "Batch",
          "header.startJob": "Start Job",
          "header.stopAll": "Stop All",
          "header.restart": "Restart",
          "header.cleanup": "Cleanup",

          // Overview
          "overview.title": "Overview",
          "overview.subtitle": "OCR Farm status summary",
          "overview.lastUpdate": "Last update",
          "overview.totalProfiles": "Total profiles",
          "overview.activeWorkers": "Active workers",
          "overview.processedToday": "Processed today",
          "overview.errorRate": "Errors",
          "overview.recentActivity": "Recent Activity",
          "overview.noActivity": "No activity",
          "overview.activityWillAppear":
            "Activity will appear here once processing starts.",

          // Profiles
          "profiles.title": "Profiles",
          "profiles.subtitle": "Gemini profile management",
          "profiles.search": "Search profile...",
          "profiles.all": "All",
          "profiles.active": "Active",
          "profiles.idle": "Idle",
          "profiles.error": "Error",
          "profiles.select": "Select",
          "profiles.cancel": "Cancel",
          "profiles.processed": "Proc.",
          "profiles.tokens": "Tokens",
          "profiles.errors": "Errors",
          "profiles.mode": "Mode",
          "profiles.lastActivity": "Last Activity",
          "profiles.actions": "Actions",
          "profiles.start": "Start",
          "profiles.stop": "Stop",
          "profiles.login": "Login",
          "profiles.info": "Info",
          "profiles.delete": "Del",

          // Live Preview
          "preview.title": "Live Preview",
          "preview.subtitle": "Live preview and activity of active workers",
          "preview.refreshAll": "Refresh all",
          "preview.autoRefresh": "Auto-refresh (10s)",
          "preview.noWorkers": "No active workers",
          "preview.screenshotsWillAppear":
            "Screenshots will appear here when jobs are running.",

          // Logs
          "logs.title": "Logs",
          "logs.subtitle": "System logs and errors",
          "logs.noLogs": "No logs",
          "logs.willAppear": "Logs will appear here once processing starts.",

          // Limits
          "limits.title": "Limits Checker",
          "limits.subtitle": "Check Pro limits status for profiles",
          "limits.lastCheck": "Last check",
          "limits.okProfiles": "OK Profiles",
          "limits.limitedProfiles": "Limited",
          "limits.sessionRuns": "Session checks",
          "limits.selectProfiles": "Select profiles to check",
          "limits.selectAll": "All",
          "limits.selectNone": "None",
          "limits.quickMode": "Quick Mode",
          "limits.parallel": "Parallel",
          "limits.host": "Host",
          "limits.runCheck": "Check limits",
          "limits.results": "Results",
          "limits.profile": "Profile",
          "limits.status": "Status",
          "limits.proRemaining": "Pro remaining",
          "limits.resetTime": "Reset",
          "limits.checkedAt": "Checked at",
          "limits.noResults": "No results",
          "limits.runCheckFirst": "Run a check to see results.",

          // Post-Process
          "postprocess.title": "Post-Processing",
          "postprocess.subtitle": "OCR data structuring",
          "postprocess.status": "Status",
          "postprocess.startProcessing": "Start Processing",
          "postprocess.stopProcessing": "Stop Processing",
          "postprocess.apiKey": "API Key (OpenRouter)",
          "postprocess.apiKeyHint":
            "Optional. Leave empty to use browser (free).",
          "postprocess.stats": "Statistics",
          "postprocess.newToProcess": "New to process",
          "postprocess.processed": "Processed",
          "postprocess.tools": "Tools",
          "postprocess.createTables": "Create tables (DB normalization)",
          "postprocess.createTablesHint":
            "Creates documents and entries tables instead of JSON columns.",

          // Settings
          "settings.title": "Settings",
          "settings.subtitle": "System configuration",
          "settings.general": "General",
          "settings.generalSystem": "General + System",
          "settings.autoRestart": "Auto-restart workers on error",
          "settings.display": "Display",
          "settings.x11Display": "X11 DISPLAY",
          "settings.updateCountsOnNewPaths": "Update counts for new folders",
          "settings.updateCountsPollSec": "Check interval (sec.)",
          "settings.remoteConfig": "Remote Configuration",
          "settings.enableRemote": "Enable Remote Run",
          "settings.remoteHosts": "Remote hosts",
          "settings.remoteWorker": "Remote worker (WSL/Ubuntu)",
          "settings.remoteBrowser": "Remote browser (Chrome)",
          "settings.remoteHostsSave": "Save hosts",
          "settings.remoteHost": "Host",
          "settings.remoteUser": "User",
          "settings.remoteRepoDir": "Repo dir",
          "settings.remoteSourceDir": "Source dir",
          "settings.remoteSshOpts": "SSH opts",
          "settings.remoteBrowserProfileRoot": "Profile root",
          "settings.remoteBrowserPython": "Python",
          "settings.remoteBrowserChromeBin": "Chrome bin",
          "settings.remoteBrowserPortBase": "Port base",
          "settings.remoteBrowserPortSpan": "Port span",
          "settings.remoteBrowserLocalPortBase": "Local port base",
          "settings.presetWslWorker": "Preset: WSL worker",
          "settings.presetWslBrowser": "Preset: WSL browser",
          "settings.advanced": "Advanced",
          "settings.maintenance": "Maintenance",
          "settings.cleanupFolders": "Clean temporary folders",
          "settings.syncProfiles": "Sync profiles with remote",
          "settings.language": "Language",
          "settings.webshare": "Webshare Sync",
          "settings.webshareToken": "API Token",
          "settings.webshareMode": "Proxy mode",
          "settings.websharePlanId": "Plan ID",
          "settings.websharePageSize": "Page size",
          "settings.webshareCountries": "Country codes",
          "settings.webshareMinValid": "Only valid",
          "settings.proxyDisabledGlobal": "Disable proxy for whole farm",
          "settings.webshareSeed": "Seed",
          "settings.webshareSyncNow": "Sync now",
          "settings.tooltips.updateCountsOnNewPaths":
            "Fallback: if LISTEN/NOTIFY fails, run update_counts.sh for new folders.",
          "settings.tooltips.updateCountsPollSec":
            "Fallback polling interval for new source_path values. 0 = disabled.",

          // Start Job Modal
          "startJob.title": "Start OCR Job",
          "startJob.basic": "Basic",
          "startJob.performance": "Performance",
          "startJob.database": "Database",
          "startJob.preprocess": "Preprocess",
          "startJob.advanced": "Advanced",
          "startJob.sourcePath": "Source folder",
          "startJob.batchId": "Batch ID",
          "startJob.headedMode": "Headed mode (show browser)",
          "startJob.engine": "OCR Engine",
          "startJob.profilesToRun": "Profiles to run",
          "startJob.all": "All",
          "startJob.okLimit": "OK Limit",
          "startJob.clear": "Clear",
          "startJob.addProfile": "Add",
          "startJob.cancel": "Cancel",
          "startJob.run": "Run Job",

          "nav.jobconfig": "Job Config",
          "job.title": "Job Configuration",
          "job.subtitle": "New OCR Job Settings",
          "job.startBtn": "Start Job",
          "job.resetBtn": "Reset to defaults",

          "job.tabs.basic": "Basic",
          "job.tabs.performance": "Performance",
          "job.tabs.database": "Database",
          "job.tabs.preprocess": "Preprocess",
          "job.tabs.advanced": "Advanced",

          "job.basic.sourcePath": "Source Path",
          "job.basic.batchId": "Batch ID",
          "job.basic.headed": "Headed Mode",
          "job.basic.engine": "OCR Engine",
          "profiles.headedMode": "Headed (for new)",
          "profiles.headedModeTooltip": "Show browser window for newly started profiles. Changing this setting does not affect already running profiles.",
          "job.basic.profiles": "Profiles to run",
          "job.basic.all": "All",
          "job.basic.okLimit": "OK Limit",
          "job.basic.clear": "Clear",
          "job.basic.add": "Add",

          "job.perf.windows": "Windows (Chrome)",
          "job.perf.tabsPerWindow": "Tabs per Window",
          "job.perf.totalWorkers": "Total Workers",
          "job.perf.scans": "Scans per Worker",
          "job.perf.timeout": "Collect Timeout",
          "job.perf.tabsSection": "Browser Tabs",
          "job.perf.closeIdle": "Auto-close idle",
          "job.perf.maxTabs": "Max Tabs / Context",
          "job.perf.ctxSection": "Contexts",
          "job.perf.isolated": "Isolated Contexts",
          "job.perf.pool": "Context Pool",
          "job.perf.uiSection": "UI Profile",
          "job.perf.viewportW": "Viewport Width",
          "job.perf.viewportH": "Viewport Height",
          "job.perf.reducedMotion": "Reduced Motion",

          "job.db.enabled": "PostgreSQL Enabled",
          "job.db.dsn": "DSN",
          "job.db.table": "Table",
          "job.db.syncSection": "Sync",
          "job.db.syncBtn": "Sync Profiles (Remote)",
          "job.db.syncDesc": "Copies local profiles to remote worker",

          "job.prep.desc": "Image processing parameters.",
          "job.prep.scaleSection": "Scaling & Noise",
          "job.prep.maxDim": "Max Dimension",
          "job.prep.median": "Median Kernel",
          "job.prep.denoise": "Denoise Strength",
          "job.prep.morph": "Morph Kernel",
          "job.prep.contrastSection": "Contrast & Contours",
          "job.prep.claheClip": "CLAHE Clip Limit",
          "job.prep.claheGrid": "CLAHE Grid Size",
          "job.prep.localSigma": "Local Contrast Sigma",
          "job.prep.localAmount": "Local Contrast Amount",

          "job.adv.mode": "Mode",
          "job.adv.continue": "Continue Mode",
          "job.adv.autoAdvance": "Auto-advance folders",
          "job.adv.proOnly": "Pro Only",
          "job.adv.clean": "Clean Temp Files",
          "job.adv.diagSection": "Diagnostics",
          "job.adv.debug": "Debug Artifacts",
          "job.adv.video": "Capture Video",

          "job.tooltips.sourcePath": "Source folder path containing images.",
          "job.tooltips.batchId": "Unique identifier for the batch.",
          "job.tooltips.headed": "Show browser window during processing.",
          "job.tooltips.engine": "Select OCR Engine.",
          "job.tooltips.workers": "Number of parallel workers.",
          "job.tooltips.scans": "Number of scans per worker session.",
          "job.tooltips.timeout": "Max time to wait for a document.",
          "job.tooltips.closeIdle": "Close idle tabs to save RAM.",
          "job.tooltips.maxTabs": "Max tabs limit per context.",
          "job.tooltips.isolated": "Run workers in isolated browser instances.",
          "job.tooltips.pool": "Number of contexts in pool.",
          "job.tooltips.reducedMotion": "Disable animations.",
          "job.tooltips.pgEnabled": "Enable PostgreSQL output.",
          "job.tooltips.maxDim": "Downscale image if larger than X px.",
          "job.tooltips.median": "Noise removal filter.",
          "job.tooltips.denoise": "Denoise strength.",
          "job.tooltips.morph": "Morphological operations.",
          "job.tooltips.continue": "Resume job (skip processed).",
          "job.tooltips.autoAdvance": "Automatically move to the next folder when done.",
          "job.tooltips.proOnly": "Use Pro model only.",
          "job.tooltips.clean": "Remove temp files after job.",
          "job.tooltips.debug": "Keep debug artifacts on error.",
          "job.tooltips.video": "Record video of the process.",

          // Cleanup Modal

          "cleanup.title": "Clean folders",
          "cleanup.selectFolders": "Select folders to clean:",
          "cleanup.jobs": "Job data",
          "cleanup.logs": "Logs",
          "cleanup.artifacts": "Debug screenshots",
          "cleanup.testResults": "Test results",
          "cleanup.pycache": "Python cache",
          "cleanup.force": "Force even when jobs are running",
          "cleanup.cancel": "Cancel",
          "cleanup.clean": "Clean",

          // Restart Modal
          "restart.title": "Restart application",
          "restart.confirm":
            "Are you sure you want to restart the application?",
          "restart.warning":
            "All active jobs will be stopped. The page will automatically refresh after restart.",
          "restart.cancel": "Cancel",
          "restart.restart": "Restart",

          // Delete Modal
          "delete.title": "Confirm deletion",
          "delete.confirm": "Are you sure you want to delete profile",
          "delete.warning": "This operation is irreversible.",
          "delete.cancel": "Cancel",
          "delete.delete": "Delete",

          // Add Profile Modal
          "addProfile.title": "Add new profile",
          "addProfile.name": "Profile name",
          "addProfile.hint":
            "Name will be used as suffix: gemini-profile-[name]",
          "addProfile.cancel": "Cancel",
          "addProfile.add": "Add profile",

          // File Browser
          "fileBrowser.title": "Select folder",
          "fileBrowser.favorites": "Favorites",
          "fileBrowser.up": "Up",
          "fileBrowser.cancel": "Cancel",
          "fileBrowser.select": "Select",

          // Common
          "common.loading": "Loading...",
          "common.error": "Error",
          "common.success": "Success",
          "common.save": "Save",
          "common.cancel": "Cancel",
          "common.close": "Close",
          "common.refresh": "Refresh",
          "common.actions": "Actions",
        },
      };

      let currentLang = localStorage.getItem("ocr-dashboard-lang") || "pl";

      function t(key) {
        return (
          translations[currentLang]?.[key] || translations["pl"]?.[key] || key
        );
      }

      function setLanguage(lang) {
        currentLang = lang;
        localStorage.setItem("ocr-dashboard-lang", lang);
        document.documentElement.lang = lang;
        applyTranslations();
        updateLanguageButtons();
      }

      function updateLanguageButtons() {
        document.querySelectorAll(".lang-btn").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.lang === currentLang);
        });
      }

      function applyTranslations() {
        document.querySelectorAll("[data-i18n]").forEach((el) => {
          const key = el.dataset.i18n;
          const text = t(key);
          if (el.tagName === "INPUT" && el.type === "text") {
            el.placeholder = text;
          } else {
            el.textContent = text;
          }
        });
        document.querySelectorAll("[data-i18n-title]").forEach((el) => {
          el.title = t(el.dataset.i18nTitle);
        });
      }

      // ============================================
      // State Management
      // ============================================

      let currentTab = "overview";
      let currentFilter = "all";
      let currentViewMode = "table";

      let selectedProfiles = new Set();
      let profilesData = [];
      const LAST_START_STORAGE_KEY = "profileLastStartTimes";
      const AUTO_RESTART_STORAGE_KEY = "autoRestartEnabled";
      const HARD_REFRESH_PENDING_KEY = "hard_refresh_pending";
      
      // Auto-restart state
      let autoRestartEnabled = true;

      // Load auto-restart setting from localStorage
      function loadAutoRestartSetting() {
        try {
          const saved = localStorage.getItem(AUTO_RESTART_STORAGE_KEY);
          if (saved !== null) {
            autoRestartEnabled = saved === "true";
          }
          // Sync both checkboxes
          const headerToggle = document.getElementById("autoRestartToggle");
          const settingsToggle = document.getElementById("settingAutoRestart");
          if (headerToggle) headerToggle.checked = autoRestartEnabled;
          if (settingsToggle) settingsToggle.checked = autoRestartEnabled;
        } catch (e) {
          console.error("Failed to load auto-restart setting:", e);
        }
      }

      // Toggle auto-restart
      function toggleAutoRestart(enabled) {
        autoRestartEnabled = enabled;
        try {
          localStorage.setItem(AUTO_RESTART_STORAGE_KEY, String(enabled));
          // Sync both checkboxes
          const headerToggle = document.getElementById("autoRestartToggle");
          const settingsToggle = document.getElementById("settingAutoRestart");
          if (headerToggle) headerToggle.checked = enabled;
          if (settingsToggle) settingsToggle.checked = enabled;
          
          showToast(
            "info",
            "Auto-restart",
            enabled ? "Włączono automatyczny restart workerów" : "Wyłączono automatyczny restart workerów"
          );
        } catch (e) {
          console.error("Failed to save auto-restart setting:", e);
        }
      }


      function loadLastStartTimes() {
        try {
          const raw = localStorage.getItem(LAST_START_STORAGE_KEY);
          const parsed = raw ? JSON.parse(raw) : {};
          return parsed && typeof parsed === "object" ? parsed : {};
        } catch (e) {
          return {};
        }
      }

      function clearAllLastStartTimes() {
        try {
          localStorage.removeItem(LAST_START_STORAGE_KEY);
        } catch (e) {}
      }

      function clearProfileLastStartTime(profileName) {
        if (!profileName) return;
        const times = loadLastStartTimes();
        if (!times || typeof times !== "object") return;
        if (!(profileName in times)) return;
        try {
          delete times[profileName];
          saveLastStartTimes(times);
        } catch (e) {}
      }

      function saveLastStartTimes(times) {
        try {
          localStorage.setItem(LAST_START_STORAGE_KEY, JSON.stringify(times));
        } catch (e) {}
      }

      function setLastStartTime(profileName, timestamp) {
        const times = loadLastStartTimes();
        times[profileName] = timestamp;
        saveLastStartTimes(times);
        return times;
      }

      function applyLastStartTimes(profiles) {
        const times = loadLastStartTimes();
        return (profiles || []).map((profile) => ({
          ...profile,
          last_start: times[profile.name] || profile.last_start || null,
        }));
      }

      // ============================================
      // Tab Navigation
      // ============================================

      function switchTab(tabId) {
        if (tabId === "activity") {
          tabId = "preview";
        }
        // Update hash (will trigger handleHashChange if changed by user, but here we set it to push state)
        // But if we just click, we want to update the view immediately for responsiveness,
        // then update hash. However, updating hash triggers hashchange.
        // Best pattern: Update hash, let hashchange handle the view switch?
        // Or: View switch, then silent update?
        // Simple approach: Update hash, allow router to handle it?
        // No, the user might want immediate feedback.
        // Let's go with: Update UI, then update hash (silently if possible, or just standard).
        // Actually, setting hash handles history. Let's rely on HashChange for the logic source of truth?
        // If I set hash, it triggers hashchange. So I should put the logic in handleHashChange.
        // BUT existing onclicks call switchTab directly.
        // So: switchTab updates UI, THEN updates Hash. To avoid loop, check if hash matches.

        const currentHashTab =
          window.location.hash.slice(1).split("/")[0] || "overview";
        if (currentHashTab !== tabId) {
          window.location.hash = tabId;
          return; // Let hashchange event handle the rest to ensure internal consistency?
          // If I return here, there might be a lag.
          // Let's execute UI update immediately, and manage the flag.
        }

        // Update nav items
        document.querySelectorAll(".nav-item").forEach((item) => {
          item.classList.toggle("active", item.dataset.tab === tabId);
        });

        // Update tab panels
        document.querySelectorAll(".tab-panel").forEach((panel) => {
          panel.classList.toggle("active", panel.id === "tab-" + tabId);
        });

        currentTab = tabId;

        // Trigger specific tab actions
        if (tabId === "preview") {
          refreshLivePreviewAll();
        } else if (tabId === "limits") {
          ensureLimitSelection();
        } else if (tabId === "logs") {
          refreshLogs();
          stopServiceLogAutoRefresh();
        } else if (tabId === "services") {
          refreshServiceLog();
          startServiceLogAutoRefresh();
        } else if (tabId === "settings") {
          // Reload settings data when switching to settings tab
          loadAutoRestartState();
          loadX11Display();
          loadUpdateCountsSettings();
          loadWebshareSettings();
          loadRemoteHosts();
        }

        updateBreadcrumb(tabId);
      }

      // ============================================
      // Sidebar
      // ============================================

      function toggleSidebar() {
        const layout = document.getElementById("appLayout");
        layout.classList.toggle("sidebar-collapsed");

        // Update toggle button text
        const toggleBtn = document.querySelector(".sidebar-toggle");
        const isCollapsed = layout.classList.contains("sidebar-collapsed");
        toggleBtn.innerHTML = isCollapsed
          ? '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="13 17 18 12 13 7"/><polyline points="6 17 11 12 6 7"/></svg>'
          : '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="11 17 6 12 11 7"/><polyline points="18 17 13 12 18 7"/></svg><span class="nav-item-text">Zwiń</span>';
      }

      // ============================================
      // Profile Filtering & Search
      // ============================================

      async function hideDefaultProfile() {
        const btn = document.getElementById("hideDefaultProfileBtn");
        if (btn) btn.disabled = true;
        try {
          const response = await fetch("/api/profiles/default/visibility", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ hidden: true }),
          });
          if (response.ok) {
            showToast("success", "Ukryto", "Profil default został ukryty");
            location.reload();
          } else {
            const data = await response.json().catch(() => ({}));
            showToast(
              "error",
              "Błąd",
              data.detail || "Nie udało się ukryć profilu default",
            );
          }
        } catch (e) {
          console.error("Failed to hide default profile:", e);
          showToast("error", "Błąd", "Nie udało się ukryć profilu default");
        } finally {
          if (btn) btn.disabled = false;
        }
      }

      let tableSortState = { col: null, dir: "asc" };

      function getProfilesTableColumnFilters() {
        const filters = {};
        document
          .querySelectorAll(
            "#profilesTable .table-filter-input, #profilesTable .table-filter-select",
          )
          .forEach((input) => {
            const value = (input.value || "").trim().toLowerCase();
            if (value) {
              filters[input.dataset.col] = value;
            }
          });
        return filters;
      }

      function getProfileTableCellText(row, col) {
        if (!row || !row.cells[col]) return "";
        if (col === 1) return (row.dataset.profile || "").toLowerCase();
        if (col === 2) return (row.dataset.status || "").toLowerCase();
        if (col === 3) {
          const select = row.cells[col].querySelector("select");
          const text =
            select?.selectedOptions?.[0]?.textContent ||
            select?.value ||
            row.cells[col].innerText ||
            "";
          return text.toLowerCase();
        }
        if (col === 8) return (row.dataset.lastError || "").toLowerCase();
        if (col === 9) return (row.dataset.lastActivity || "").toLowerCase();
        if (col === 10) return (row.dataset.limitReset || "").toLowerCase();
        if (col === 11) return (row.dataset.lastStart || "").toLowerCase();
        return row.cells[col].innerText.replace(/\s+/g, " ").trim().toLowerCase();
      }

      function rowMatchesColumnFilters(row, filters) {
        for (const [col, value] of Object.entries(filters)) {
          if (!value) continue;
          if (col === "2") {
            const status = (row.dataset.status || "").toLowerCase();
            if (!status.includes(value)) return false;
            continue;
          }
          const cellText = getProfileTableCellText(row, Number(col));
          if (!cellText.includes(value)) return false;
        }
        return true;
      }

      function parseDateTime(value) {
        if (!value) return null;
        const normalized = String(value).trim();
        if (!normalized || normalized === "-") return null;
        if (normalized.includes("T")) {
          const parsed = new Date(normalized);
          return Number.isNaN(parsed.getTime()) ? null : parsed.getTime();
        }
        if (/^\d{4}-\d{2}-\d{2}\s/.test(normalized)) {
          const parsed = new Date(normalized.replace(" ", "T"));
          return Number.isNaN(parsed.getTime()) ? null : parsed.getTime();
        }
        const parsed = new Date(normalized);
        return Number.isNaN(parsed.getTime()) ? null : parsed.getTime();
      }

      function parseNumber(value) {
        if (value == null) return null;
        const raw = String(value).trim().toLowerCase();
        if (!raw || raw === "-") return null;
        const match = raw.match(/[\d.]+/);
        if (!match) return null;
        return Number(match[0]);
      }

      function getSortValue(row, col) {
        if (!row) return null;
        if (col === 1) return row.dataset.profile || "";
        if (col === 2) return row.dataset.status || "";
        if (col === 3) {
          const select = row.cells[col]?.querySelector("select");
          return (
            select?.selectedOptions?.[0]?.textContent ||
            select?.value ||
            row.cells[col]?.innerText ||
            ""
          );
        }
        if (col === 4) {
          const init = parseNumber(row.dataset.workersInit);
          const prompt = parseNumber(row.dataset.workersPrompt);
          if (init != null && prompt != null) return init * 1000 + prompt;
          const text = row.cells[col]?.innerText || "";
          const parts = text.split("/").map((p) => parseNumber(p));
          return (parts[0] || 0) * 1000 + (parts[1] || 0);
        }
        if (col === 5) return parseNumber(row.dataset.processed);
        if (col === 6) {
          const tokensK = parseNumber(row.dataset.tokensK);
          if (tokensK != null) return tokensK * 1000;
          return parseNumber(row.cells[col]?.innerText);
        }
        if (col === 7) return parseNumber(row.dataset.errors);
        if (col === 8) return parseDateTime(row.dataset.lastError);
        if (col === 9) return parseDateTime(row.dataset.lastActivity);
        if (col === 10) return parseDateTime(row.dataset.limitReset);
        if (col === 11) return parseDateTime(row.dataset.lastStart);
        return row.cells[col]?.innerText || "";
      }

      function compareSortValues(a, b) {
        if (a == null && b == null) return 0;
        if (a == null) return 1;
        if (b == null) return -1;
        if (typeof a === "number" && typeof b === "number") return a - b;
        return String(a).localeCompare(String(b), "pl", {
          numeric: true,
          sensitivity: "base",
        });
      }

      function applyTableSort() {
        if (!tableSortState.col) return;
        const tbody = document.querySelector("#profilesTable tbody");
        if (!tbody) return;
        const rows = Array.from(tbody.querySelectorAll(".profile-row"));
        const col = tableSortState.col;
        const dir = tableSortState.dir;
        const sorted = rows
          .map((row, index) => ({
            row,
            index,
            value: getSortValue(row, col),
          }))
          .sort((a, b) => {
            const cmp = compareSortValues(a.value, b.value);
            if (cmp === 0) return a.index - b.index;
            return dir === "asc" ? cmp : -cmp;
          });
        sorted.forEach((item) => tbody.appendChild(item.row));
      }

      function toggleTableSort(th) {
        const col = Number(th.dataset.sortCol);
        if (!Number.isFinite(col)) return;
        if (tableSortState.col === col) {
          tableSortState.dir = tableSortState.dir === "asc" ? "desc" : "asc";
        } else {
          tableSortState.col = col;
          tableSortState.dir = "asc";
        }
        document
          .querySelectorAll("#profilesTable thead th.table-sortable")
          .forEach((header) => {
            header.classList.remove("sorted-asc", "sorted-desc");
          });
        th.classList.add(
          tableSortState.dir === "asc" ? "sorted-asc" : "sorted-desc",
        );
        applyTableSort();
      }

      function initProfilesTableInteractions() {
        document
          .querySelectorAll("#profilesTable thead th.table-sortable")
          .forEach((th) => {
            th.addEventListener("click", () => toggleTableSort(th));
          });

        document
          .querySelectorAll(
            "#profilesTable .table-filter-input, #profilesTable .table-filter-select",
          )
          .forEach((input) => {
            input.addEventListener("input", filterProfiles);
            input.addEventListener("change", filterProfiles);
          });
      }

      function filterProfiles() {
        const searchTerm = document
          .getElementById("profileSearch")
          .value.toLowerCase();
        let visibleCount = 0;
        const columnFilters = getProfilesTableColumnFilters();

        // Filter grid cards
        const cards = document.querySelectorAll(".profile-card");
        cards.forEach((card) => {
          const profileName = card.dataset.profile.toLowerCase();
          const status = card.dataset.status;

          const matchesSearch = profileName.includes(searchTerm);
          const matchesFilter =
            currentFilter === "all" || status === currentFilter;

          const isVisible = matchesSearch && matchesFilter;
          card.style.display = isVisible ? "" : "none";

          if (isVisible) visibleCount++;
        });

        // Filter table rows
        let visibleRowCount = 0;
        const rows = document.querySelectorAll(".profile-row");
        rows.forEach((row) => {
          const profileName = row.dataset.profile.toLowerCase();
          const status = row.dataset.status;

          const matchesSearch = profileName.includes(searchTerm);
          const matchesFilter =
            currentFilter === "all" || status === currentFilter;
          const matchesColumns = rowMatchesColumnFilters(row, columnFilters);

          const isVisible = matchesSearch && matchesFilter && matchesColumns;
          row.style.display = isVisible ? "" : "none";
          if (isVisible) visibleRowCount++;
        });

        document.getElementById("profilesVisibleCount").textContent =
          currentViewMode === "table" || Object.keys(columnFilters).length > 0
            ? visibleRowCount
            : visibleCount;
        applyTableSort();
      }

      function setFilter(filter) {
        currentFilter = filter;

        // Update filter buttons
        document.querySelectorAll(".filter-btn").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.filter === filter);
        });

        filterProfiles();
      }

      // ============================================
      // View Mode (Grid/Table)
      // ============================================

      function setViewMode(mode) {
        currentViewMode = mode;

        // Update toggle buttons
        document.querySelectorAll(".view-toggle-btn").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.view === mode);
        });

        // Show/hide views
        const grid = document.getElementById("profilesGrid");
        const table = document.getElementById("profilesTable");

        if (mode === "grid") {
          grid.classList.remove("hidden");
          table.classList.add("hidden");
        } else {
          grid.classList.add("hidden");
          table.classList.remove("hidden");
        }

        // Re-apply filters
        filterProfiles();
      }

      function toggleSelectAll() {
        const selectAll = document.getElementById("selectAllTable");
        const checkboxes = document.querySelectorAll(".profile-checkbox-table");

        checkboxes.forEach((cb) => {
          const row = cb.closest(".profile-row");
          if (row && row.style.display !== "none") {
            cb.checked = selectAll.checked;
          }
        });

        updateSelectionFromTable();
      }

      function updateSelectionFromTable() {
        const checkboxes = document.querySelectorAll(
          ".profile-checkbox-table:checked",
        );
        selectedProfiles = new Set(
          [...checkboxes].map((cb) => cb.dataset.profile),
        );

        document.getElementById("selectedCount").textContent =
          selectedProfiles.size;

        const bulkBar = document.getElementById("bulkActionsBar");
        bulkBar.classList.toggle("visible", selectedProfiles.size > 0);
      }



      function updateSelection() {
        const checkboxes = document.querySelectorAll(
          ".profile-checkbox:checked",
        );
        selectedProfiles = new Set(
          [...checkboxes].map((cb) => cb.dataset.profile),
        );

        document.getElementById("selectedCount").textContent =
          selectedProfiles.size;

        const bulkBar = document.getElementById("bulkActionsBar");
        bulkBar.classList.toggle("visible", selectedProfiles.size > 0);
      }

      function clearSelection() {
        document.querySelectorAll(".profile-checkbox").forEach((cb) => {
          cb.checked = false;
        });
        selectedProfiles.clear();
        updateSelection();
      }

      // ============================================
      // Profile Actions
      // ============================================

      function _pickSavedValue(savedValue, fallbackValue) {
        if (savedValue === undefined || savedValue === null || savedValue === "") {
          return fallbackValue;
        }
        return savedValue;
      }

      function buildProfileStartPayload(profileName) {
        let savedConfig = null;
        try {
          const raw = localStorage.getItem("jobConfig");
          if (raw) savedConfig = JSON.parse(raw);
        } catch (e) {
          savedConfig = null;
        }

        const rawMode = executionModes[profileName] || "local";
        let executionMode = rawMode;
        let remoteHostId = null; 

        if (rawMode.includes("|")) {
            const parts = rawMode.split("|");
            remoteHostId = parts[0];
            executionMode = parts[1];
        }

        const payload = {
          remote_host_id: remoteHostId,
          execution_mode: executionMode,
          source_path: _pickSavedValue(
            savedConfig?.sourcePath,
            document.getElementById("jobSourcePath")?.value || ""
          ),
          headed: _pickSavedValue(
            savedConfig?.headedMode,
            document.getElementById("jobHeadedMode")?.checked || false,
          ),
          windows: parseInt(
            _pickSavedValue(
              savedConfig?.windows,
              document.getElementById("jobWindows")?.value,
            ),
          ) || 2,
          tabs_per_window: parseInt(
            _pickSavedValue(
              savedConfig?.tabsPerWindow,
              document.getElementById("jobTabsPerWindow")?.value,
            ),
          ) || 2,
          scans_per_worker: parseInt(
            _pickSavedValue(
              savedConfig?.scansPerWorker,
              document.getElementById("jobScansPerWorker")?.value,
            ),
          ) || 2,
          collect_timeout_sec: parseInt(
            _pickSavedValue(
              savedConfig?.collectTimeout,
              document.getElementById("jobCollectTimeout")?.value,
            ),
          ) || 400,
          close_idle_tabs: _pickSavedValue(
            savedConfig?.closeIdleTabs,
            document.getElementById("jobCloseIdleTabs")?.checked,
          ),
          max_tabs_per_context: parseInt(
            _pickSavedValue(
              savedConfig?.maxTabsPerContext,
              document.getElementById("jobMaxTabsPerContext")?.value,
            ),
          ) || 0,
          isolated_contexts: _pickSavedValue(
            savedConfig?.isolatedContexts,
            document.getElementById("jobIsolatedContexts")?.checked,
          ),
          context_pool_size: parseInt(
            _pickSavedValue(
              savedConfig?.contextPoolSize,
              document.getElementById("jobContextPoolSize")?.value,
            ),
          ) || 0,
          viewport_width: parseInt(
            _pickSavedValue(
              savedConfig?.viewportWidth,
              document.getElementById("jobViewportWidth")?.value,
            ),
          ) || 1200,
          viewport_height: parseInt(
            _pickSavedValue(
              savedConfig?.viewportHeight,
              document.getElementById("jobViewportHeight")?.value,
            ),
          ) || 800,
          reduced_motion: _pickSavedValue(
            savedConfig?.reducedMotion,
            document.getElementById("jobReducedMotion")?.checked,
          ),
          pg_enabled: _pickSavedValue(
            savedConfig?.pgEnabled,
            document.getElementById("jobPgEnabled")?.checked,
          ),
          pg_dsn: _pickSavedValue(
            savedConfig?.pgDsn,
            document.getElementById("jobPgDsn")?.value,
          ),
          pg_table: _pickSavedValue(
            savedConfig?.pgTable,
            document.getElementById("jobPgTable")?.value,
          ),
          continue_mode: _pickSavedValue(
            savedConfig?.continueMode,
            document.getElementById("jobContinueMode")?.checked,
          ),
          auto_advance: _pickSavedValue(
            savedConfig?.autoAdvance,
            document.getElementById("jobAutoAdvance")?.checked,
          ),
          pro_only: _pickSavedValue(
            savedConfig?.proOnly,
            document.getElementById("jobProOnly")?.checked,
          ),
          clean_temp_images: _pickSavedValue(
            savedConfig?.cleanTemp,
            document.getElementById("jobCleanTemp")?.checked,
          ),
          debug_artifacts: _pickSavedValue(
            savedConfig?.debugArtifacts,
            document.getElementById("jobDebugArtifacts")?.checked,
          ),
          capture_video: _pickSavedValue(
            savedConfig?.captureVideo,
            document.getElementById("jobCaptureVideo")?.checked,
          ),
          tracing_mode: _pickSavedValue(
            savedConfig?.tracingMode,
            document.getElementById("jobTracingMode")?.value,
          ),
          auth_ensure_enabled: _pickSavedValue(
            savedConfig?.authEnsure,
            document.getElementById("jobAuthEnsure")?.checked,
          ),
          auth_ensure_interval_sec: parseInt(
            _pickSavedValue(
              savedConfig?.authEnsureInterval,
              document.getElementById("jobAuthEnsureInterval")?.value,
            ),
          ) || 900,
          model_switch_retries: parseInt(
            _pickSavedValue(
              savedConfig?.modelSwitchRetries,
              document.getElementById("jobModelSwitchRetries")?.value,
            ),
          ) || 3,
          model_switch_cooldown_ms: parseInt(
            _pickSavedValue(
              savedConfig?.modelSwitchCooldown,
              document.getElementById("jobModelSwitchCooldown")?.value,
            ),
          ) || 1200,
          limit_check_interval_sec: parseInt(
            _pickSavedValue(
              savedConfig?.limitCheckInterval,
              document.getElementById("jobLimitCheckInterval")?.value,
            ),
          ) || 1800,
          pro_pause_buffer_sec: parseInt(
            _pickSavedValue(
              savedConfig?.proPauseBuffer,
              document.getElementById("jobProPauseBuffer")?.value,
            ),
          ) || 180,
          pro_fallback_pause_min: parseInt(
            _pickSavedValue(
              savedConfig?.proFallbackPause,
              document.getElementById("jobProFallbackPause")?.value,
            ),
          ) || 60,
          browser_id: _pickSavedValue(
            savedConfig?.browserId,
            document.getElementById("jobBrowserId")?.value,
          ),
          execution_mode: getExecutionMode(profileName),
          preproc_max_dimension: parseInt(
            _pickSavedValue(
              savedConfig?.preprocMaxDim,
              document.getElementById("jobPreprocMaxDim")?.value,
            ),
          ) || 2500,
          preproc_median_kernel: parseInt(
            _pickSavedValue(
              savedConfig?.preprocMedianKernel,
              document.getElementById("jobPreprocMedianKernel")?.value,
            ),
          ) || 3,
          preproc_denoise_strength: parseInt(
            _pickSavedValue(
              savedConfig?.preprocDenoise,
              document.getElementById("jobPreprocDenoise")?.value,
            ),
          ) || 8,
          preproc_morph_kernel_size: parseInt(
            _pickSavedValue(
              savedConfig?.preprocMorph,
              document.getElementById("jobPreprocMorph")?.value,
            ),
          ) || 2,
          preproc_clahe_clip_limit: parseFloat(
            _pickSavedValue(
              savedConfig?.preprocClahe,
              document.getElementById("jobPreprocClahe")?.value,
            ),
          ) || 2.0,
          preproc_clahe_grid_size: _pickSavedValue(
            savedConfig?.preprocClaheGrid,
            document.getElementById("jobPreprocClaheGrid")?.value,
          ),
          preproc_local_contrast_sigma: parseFloat(
            _pickSavedValue(
              savedConfig?.preprocLocalSigma,
              document.getElementById("jobPreprocLocalSigma")?.value,
            ),
          ) || 12.0,
          preproc_local_contrast_amount: parseFloat(
            _pickSavedValue(
              savedConfig?.preprocLocalAmount,
              document.getElementById("jobPreprocLocalAmount")?.value,
            ),
          ) || 0.35,
          preproc_blackhat_kernel_size: parseInt(
            _pickSavedValue(
              savedConfig?.preprocBlackhatKernel,
              document.getElementById("jobPreprocBlackhatKernel")?.value,
            ),
          ) || 5,
          preproc_blackhat_strength: parseFloat(
            _pickSavedValue(
              savedConfig?.preprocBlackhatStrength,
              document.getElementById("jobPreprocBlackhatStrength")?.value,
            ),
          ) || 0.45,
          preproc_unsharp_amount: parseFloat(
            _pickSavedValue(
              savedConfig?.preprocUnsharpAmount,
              document.getElementById("jobPreprocUnsharpAmount")?.value,
            ),
          ) || 1.2,
          preproc_unsharp_radius: parseInt(
            _pickSavedValue(
              savedConfig?.preprocUnsharpRadius,
              document.getElementById("jobPreprocUnsharpRadius")?.value,
            ),
          ) || 1,
          preproc_margin_percent: parseFloat(
            _pickSavedValue(
              savedConfig?.preprocMarginPercent,
              document.getElementById("jobPreprocMarginPercent")?.value,
            ),
          ) || 0.05,
          preproc_dark_threshold: parseInt(
            _pickSavedValue(
              savedConfig?.preprocDarkThreshold,
              document.getElementById("jobPreprocDarkThreshold")?.value,
            ),
          ) || 60,
          preproc_margin_ink_ratio_max: parseFloat(
            _pickSavedValue(
              savedConfig?.preprocMarginInkRatio,
              document.getElementById("jobPreprocMarginInkRatio")?.value,
            ),
          ) || 0.01,
          preproc_margin_shadow_mean_max: parseInt(
            _pickSavedValue(
              savedConfig?.preprocMarginShadow,
              document.getElementById("jobPreprocMarginShadow")?.value,
            ),
          ) || 200,
          preproc_background_kernel_ratio: parseFloat(
            _pickSavedValue(
              savedConfig?.preprocBgKernelRatio,
              document.getElementById("jobPreprocBgKernelRatio")?.value,
            ),
          ) || 0.025,
          preproc_background_kernel_min: parseInt(
            _pickSavedValue(
              savedConfig?.preprocBgKernelMin,
              document.getElementById("jobPreprocBgKernelMin")?.value,
            ),
          ) || 31,
          preproc_enable_adaptive_binarization: _pickSavedValue(
            savedConfig?.preprocBinarization,
            document.getElementById("jobPreprocBinarization")?.checked,
          ),
          preproc_sauvola_window: parseInt(
            _pickSavedValue(
              savedConfig?.preprocSauvolaW,
              document.getElementById("jobPreprocSauvolaW")?.value,
            ),
          ) || 31,
          preproc_sauvola_k: parseFloat(
            _pickSavedValue(
              savedConfig?.preprocSauvolaK,
              document.getElementById("jobPreprocSauvolaK")?.value,
            ),
          ) || 0.2,
          preproc_sauvola_r: parseFloat(
            _pickSavedValue(
              savedConfig?.preprocSauvolaR,
              document.getElementById("jobPreprocSauvolaR")?.value,
            ),
          ) || 128.0,
          preproc_text_mask_block_size: parseInt(
            _pickSavedValue(
              savedConfig?.preprocTextMaskBlock,
              document.getElementById("jobPreprocTextMaskBlock")?.value,
            ),
          ) || 31,
          preproc_text_mask_c: parseInt(
            _pickSavedValue(
              savedConfig?.preprocTextMaskC,
              document.getElementById("jobPreprocTextMaskC")?.value,
            ),
          ) || 12,
          preproc_text_mask_open_kernel: parseInt(
            _pickSavedValue(
              savedConfig?.preprocTextMaskOpenK,
              document.getElementById("jobPreprocTextMaskOpenK")?.value,
            ),
          ) || 3,
          preproc_text_mask_close_kernel: parseInt(
            _pickSavedValue(
              savedConfig?.preprocTextMaskCloseK,
              document.getElementById("jobPreprocTextMaskCloseK")?.value,
            ),
          ) || 9,
          preproc_text_mask_close_iters: parseInt(
            _pickSavedValue(
              savedConfig?.preprocTextMaskCloseI,
              document.getElementById("jobPreprocTextMaskCloseI")?.value,
            ),
          ) || 2,
          preproc_text_mask_dilate_iters: parseInt(
            _pickSavedValue(
              savedConfig?.preprocTextMaskDilateI,
              document.getElementById("jobPreprocTextMaskDilateI")?.value,
            ),
          ) || 1,
          preproc_text_mask_min_area_ratio: parseFloat(
            _pickSavedValue(
              savedConfig?.preprocTextMaskMinArea,
              document.getElementById("jobPreprocTextMaskMinArea")?.value,
            ),
          ) || 0.0005,
          preproc_trim_band_ratio: parseFloat(
            _pickSavedValue(
              savedConfig?.preprocTrimBand,
              document.getElementById("jobPreprocTrimBand")?.value,
            ),
          ) || 0.02,
          preproc_trim_ink_ratio_max: parseFloat(
            _pickSavedValue(
              savedConfig?.preprocTrimInk,
              document.getElementById("jobPreprocTrimInk")?.value,
            ),
          ) || 0.02,
          preproc_trim_max_ratio: parseFloat(
            _pickSavedValue(
              savedConfig?.preprocTrimMax,
              document.getElementById("jobPreprocTrimMax")?.value,
            ),
          ) || 0.15,
          preproc_trim_min_dimension: parseInt(
            _pickSavedValue(
              savedConfig?.preprocTrimMinDim,
              document.getElementById("jobPreprocTrimMinDim")?.value,
            ),
          ) || 200,
        };

        const manualHeaded = document.getElementById("manualHeadedMode")?.checked;
        if (manualHeaded !== undefined) {
          payload.headed = manualHeaded;
        }

        return payload;
      }

      async function startProfile(profileName, overrides = null) {
        manualStopUntil.delete(profileName);
        // Optimistic UI Update
        const profile = profilesData.find((p) => p.name === profileName);
        const nowIso = new Date().toISOString();
        markStartGrace(profileName);
        setLastStartTime(profileName, nowIso);
        if (profile) {
          profile.status = "starting";
          profile.status_label = "STARTING...";
          profile.last_start = nowIso;
          updateProfiles(profilesData); // Re-render UI with new status
        }

        showToast(
          "info",
          "Uruchamianie...",
          `Uruchamianie profilu ${profileName}`,
        );
        try {
          const payload = buildProfileStartPayload(profileName);
          if (overrides && typeof overrides === "object") {
            Object.assign(payload, overrides);
          }
          const response = await fetch(`/api/profile/${profileName}/start`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (response.ok) {
            showToast(
              "success",
              "Uruchomiono",
              `Profil ${profileName} został uruchomiony`,
            );

            // Keep "starting" until backend confirms active
            if (profile) {
              profile.status = "starting";
              profile.status_label = "STARTING...";
              updateProfiles(profilesData);
            }

            setTimeout(refreshData, 100); // Fast refresh
          } else {
            showToast("error", "Błąd", "Nie udało się uruchomić profilu");
            refreshData(); // Revert on error
          }
        } catch (e) {
          showToast("error", "Błąd", e.message);
          refreshData(); // Revert on error
        }
      }

      async function stopProfile(profileName) {
        markManualStop(profileName);
        // Optimistic UI Update
        const profile = profilesData.find((p) => p.name === profileName);
        startGraceUntil.delete(profileName);
        if (profile) {
          profile.status = "stopping";
          profile.status_label = "STOPPING...";
          updateProfiles(profilesData); // Re-render UI with new status
        }

        showToast(
          "info",
          "Zatrzymywanie...",
          `Zatrzymywanie profilu ${profileName}`,
        );
        try {
          const response = await fetch(`/api/profile/${profileName}/stop`, {
            method: "POST",
          });
          if (response.ok) {
            showToast(
              "success",
              "Zatrzymano",
              `Profil ${profileName} został zatrzymany`,
            );

            // Keep "stopping" until backend confirms idle
            if (profile) {
              profile.status = "stopping";
              profile.status_label = "STOPPING...";
              updateProfiles(profilesData);
            }

            setTimeout(refreshData, 100); // Fast refresh
          } else {
            showToast("error", "Błąd", "Nie udało się zatrzymać profilu");
            refreshData(); // Revert
          }
        } catch (e) {
          showToast("error", "Błąd", e.message);
          refreshData(); // Revert
        }
      }

      async function waitForProfileStop(profileName, timeoutMs = 30000) {
        const deadline = Date.now() + timeoutMs;
        while (Date.now() < deadline) {
          await new Promise((resolve) => setTimeout(resolve, 1000));
          try {
            const statsResp = await fetch("/api/stats/v2", { cache: "no-store" });
            if (!statsResp.ok) continue;
            const statsData = await statsResp.json();
            const p = (statsData.profiles || []).find((x) => x.name === profileName);
            if (!p) return true;
            if (!["active", "starting", "stopping"].includes(p.status)) {
              return true;
            }
          } catch (e) {
            // Ignore transient fetch errors during stop
          }
        }
        return false;
      }

      async function toggleHeaded(profileName) {
        const profile = profilesData.find((p) => p.name === profileName);
        const currentlyHeaded = Boolean(profile?.headed);
        const targetHeaded = !currentlyHeaded;
        const modeLabel = targetHeaded ? "headed" : "headless";

        if (profile && ["active", "starting", "stopping"].includes(profile.status)) {
          showToast(
            "info",
            "Przełączanie...",
            `Restart profilu ${profileName} w trybie ${modeLabel}`,
          );
          await stopProfile(profileName);
          const stopped = await waitForProfileStop(profileName, 30000);
          if (!stopped) {
            showToast("error", "Błąd", "Nie udało się zatrzymać profilu na czas");
            return;
          }
          await startProfile(profileName, { headed: targetHeaded });
          return;
        }

        showToast(
          "info",
          "Uruchamianie...",
          `Start profilu ${profileName} w trybie ${modeLabel}`,
        );
        await startProfile(profileName, { headed: targetHeaded });
      }

      // ============================================
      // Execution Mode Management
      // ============================================

      const executionModes = {};

      function updateProfileExecutionOptions() {
          const selects = document.querySelectorAll('select.execution-mode-select');
          
          selects.forEach(select => {
              const currentVal = select.value;
              const profileName = select.dataset.profile;
              const savedMode = executionModes[profileName] || "local";
              
              // Clear existing options except local? Or rebuild entirely.
              select.innerHTML = '<option value="local">Local</option>';
              
              if (remoteHostsData && remoteHostsData.length > 0) {
                  remoteHostsData.forEach(host => {
                      // Skip localhost - it's already covered by "Local" option
                      if (host.isLocal) return;
                      
                      const hid = host.id;
                      
                      // Support both 'modes' array and 'roles' object formats
                      const hasWorker = Array.isArray(host.modes) 
                          ? host.modes.includes('Worker') 
                          : host.roles?.worker;
                      const hasBrowser = Array.isArray(host.modes) 
                          ? host.modes.includes('Browser') 
                          : host.roles?.browser;
                      
                      if (hasWorker) {
                          const val = `${hid}|worker`;
                          const opt = document.createElement("option");
                          opt.value = val;
                          opt.textContent = `${hid} (Worker)`;
                          select.appendChild(opt);
                      }
                      if (hasBrowser) {
                          const val = `${hid}|browser`;
                          const opt = document.createElement("option");
                          opt.value = val;
                          opt.textContent = `${hid} (Browser)`;
                          select.appendChild(opt);
                      }
                  });
              }
              
              // Restore selected value
              if (savedMode) {
                  // Check if savedMode exists in new options
                  const exists = Array.from(select.options).some(o => o.value === savedMode);
                  if (exists) {
                      select.value = savedMode;
                  } else if (savedMode !== 'local') {
                       // Try to find by partial match if ID changed? Unlikely since we rely on ID.
                       // Just default to local if missing
                       select.value = "local";
                  }
              }
          });
      }

      function updateExecutionMode(profileName, mode) {
        executionModes[profileName] = mode;
        localStorage.setItem(
          "ocr-execution-modes",
          JSON.stringify(executionModes),
        );

        // Sync all selects for this profile (grid and table)
        document
          .querySelectorAll(
            `select.execution-mode-select[data-profile="${profileName}"]`,
          )
          .forEach((select) => {
            if (select.value !== mode) {
              select.value = mode;
            }
          });
      }

      function loadExecutionModes() {
        const stored = localStorage.getItem("ocr-execution-modes");
        if (stored) {
          try {
            const modes = JSON.parse(stored);
            Object.assign(executionModes, modes);

            // Apply to all selects
            Object.entries(modes).forEach(([profileName, mode]) => {
              document
                .querySelectorAll(
                  `select.execution-mode-select[data-profile="${profileName}"]`,
                )
                .forEach((select) => {
                  select.value = mode;
                });
            });
            
            // Also trigger update of options just in case hosts are already loaded
            if (remoteHostsData && remoteHostsData.length > 0) {
                updateProfileExecutionOptions();
            }
          } catch (e) {
            console.error("Failed to load execution modes:", e);
          }
        }
      }

      function getExecutionMode(profileName) {
        return executionModes[profileName] || "local";
      }

      function getProfilesByExecutionMode() {
        const result = {
          profiles: [],
          remote_browser_profiles: [],
          remote_ssh_profiles: [],
        };

        const selectedProfiles = getSelectedProfiles();

        selectedProfiles.forEach((profileName) => {
          const mode = getExecutionMode(profileName);
          switch (mode) {
            case "local":
              result.profiles.push(profileName);
              break;
            case "wsl_browser":
              result.remote_browser_profiles.push(profileName);
              break;
            case "wsl_worker":
              result.remote_ssh_profiles.push(profileName);
              break;
          }
        });

        return result;
      }

      async function restartProfile(profileName) {
        await stopProfile(profileName);
        setTimeout(() => startProfile(profileName), 1000);
      }

      async function startAllProfiles() {
        showToast("info", "Uruchamianie...", "Uruchamianie wszystkich profili");
        try {
          const response = await fetch("/api/farm/start", { method: "POST" });
          if (response.ok) {
            showToast(
              "success",
              "Uruchomiono",
              "Wszystkie profile zostały uruchomione",
            );
            refreshData();
          }
        } catch (e) {
          showToast("error", "Błąd", e.message);
        }
      }

      async function stopAllProfiles() {
        showToast(
          "info",
          "Zatrzymywanie...",
          "Zatrzymywanie wszystkich profili",
        );
        try {
          const initialProfiles = profilesData || [];
          initialProfiles
            .filter((p) => ["active", "starting", "stopping"].includes(p.status))
            .forEach((p) => markManualStop(p.name));
          const remaining = new Set(
            initialProfiles
              .filter((p) => ["active", "starting", "stopping"].includes(p.status))
              .map((p) => p.name),
          );

          const response = await fetch("/api/farm/stop", { method: "POST" });
          if (response.ok) {
            const timeoutMs = 30000;
            const pollIntervalMs = 1000;
            const deadline = Date.now() + timeoutMs;

            while (Date.now() < deadline) {
              await new Promise((resolve) => setTimeout(resolve, pollIntervalMs));
              const statsResp = await fetch("/api/stats/v2", { cache: "no-store" });
              if (!statsResp.ok) break;
              const statsData = await statsResp.json();
              updateProfiles(statsData.profiles || []);
              updateStats(statsData);
              updateLastUpdate();

              (statsData.profiles || []).forEach((profile) => {
                if (
                  remaining.has(profile.name) &&
                  !["active", "starting", "stopping"].includes(profile.status)
                ) {
                  remaining.delete(profile.name);
                  showToast(
                    "info",
                    "Zatrzymano profil",
                    `Profil ${profile.name} został zatrzymany`,
                  );
                }
              });

              const stillRunning = (statsData.profiles || []).some((p) =>
                ["active", "starting", "stopping"].includes(p.status),
              );
              if (!stillRunning) {
                showToast(
                  "success",
                  "Zatrzymano",
                  "Wszystkie profile zostały zatrzymane",
                );
                updateHeaderStartStopButton(statsData.profiles || []);
                return;
              }
            }

            showToast(
              "warning",
              "W trakcie",
              "Zatrzymywanie trwa dłużej — odświeżono statusy",
            );
            refreshData();
          } else {
            showToast("error", "Błąd", "Nie udało się zatrzymać profili");
          }
        } catch (e) {
          showToast("error", "Błąd", e.message);
        }
      }

      async function startSelected() {
        for (const profile of selectedProfiles) {
          await startProfile(profile);
        }
        clearSelection();
      }

      async function stopSelected() {
        for (const profile of selectedProfiles) {
          await stopProfile(profile);
        }
        clearSelection();
      }

      // ============================================
      // Data Refresh
      // ============================================

      async function refreshData(options = {}) {
        const { showSpinner = true } = options;
        const refreshIcon = document.getElementById("refreshIcon");
        if (showSpinner && refreshIcon) {
          refreshIcon.style.animation = "spin 1s linear infinite";
        }

        try {
          const response = await fetch("/api/stats/v2", { cache: "no-store" });
          const data = await response.json();

          updateStats(data);
          const profilesWithStartTimes = applyLastStartTimes(
            data.profiles || [],
          );
          const profilesWithGrace = applyStartGrace(profilesWithStartTimes);
          updateProfiles(profilesWithGrace);
          updateLastUpdate();
          
          // Fetch and update host load information
          await fetchHostLoad();
        } catch (e) {
          console.error("Failed to refresh data:", e);
        } finally {
          if (showSpinner && refreshIcon) {
            refreshIcon.style.animation = "";
          }
        }
      }

      async function fetchHostLoad() {
        try {
          const response = await fetch("/api/host-load", { cache: "no-store" });
          const data = await response.json();
          updateHostLoad(data.hosts || []);
        } catch (e) {
          console.error("Failed to fetch host load:", e);
        }
      }

      async function refreshHostLoadFor(hostId) {
        const selectorId = typeof CSS !== "undefined" && CSS.escape ? CSS.escape(hostId) : hostId;
        const btn = document.querySelector(
          `.host-refresh-btn[data-host-id="${selectorId}"]`,
        );
        if (btn) {
          btn.disabled = true;
          btn.dataset.originalText = btn.textContent || "Odśwież";
          btn.textContent = "Odświeżanie...";
        }
        try {
          await fetchHostLoad();
        } finally {
          if (btn) {
            btn.disabled = false;
            btn.textContent = btn.dataset.originalText || "Odśwież";
          }
        }
      }

      async function killHostBrowsers(hostId) {
        const selectorId = typeof CSS !== "undefined" && CSS.escape ? CSS.escape(hostId) : hostId;
        const btn = document.querySelector(
          `.host-kill-browsers-btn[data-host-id="${selectorId}"]`,
        );
        if (btn) {
          btn.disabled = true;
          btn.dataset.originalText = btn.textContent || "Kill";
          btn.textContent = "Killuję...";
        }
        try {
          const response = await fetch("/api/host-browsers/kill", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ host_id: hostId }),
          });
          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText || "Kill failed");
          }
          const result = await response.json();
          const killed = Number(result.killed_estimate);
          const before = Number(result.before);
          const after = Number(result.after);
          let message = "Wysłano sygnał do procesów przeglądarek.";
          if (Number.isFinite(before) && Number.isFinite(after)) {
            message = `Przed: ${before}, Po: ${after}`;
            if (Number.isFinite(killed)) {
              message += `, Zabite: ${killed}`;
            }
          }
          toastHost("success", "Przeglądarki zatrzymane", message, hostId);
          await fetchHostLoad();
        } catch (e) {
          console.error("Failed to kill browsers:", e);
          toastHost(
            "error",
            "Błąd zatrzymywania",
            "Nie udało się zabić procesów przeglądarek dla hosta.",
            hostId,
          );
        } finally {
          if (btn) {
            btn.disabled = false;
            btn.textContent = btn.dataset.originalText || "Kill";
          }
        }
      }

      function updateHostLoad(hosts) {
        const container = document.getElementById("hostLoadSummary");
        if (!container) return;

        if (hosts.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">🖥️</div>
              <p class="empty-message">Brak skonfigurowanych hostów remote</p>
            </div>
          `;
          return;
        }

        let html = '';
        hosts.forEach(host => {
          const statusClass = host.status === 'overloaded' ? 'error' : 
                            host.status === 'busy' ? 'warning' : 
                            host.status === 'available' ? 'success' : 
                            host.status === 'unavailable' ? 'error' : 'idle';
          
          const statusLabel = host.status === 'overloaded' ? 'Przeciążony' : 
                             host.status === 'busy' ? 'Obciążony' : 
                             host.status === 'available' ? 'Dostępny' : 
                             host.status === 'unavailable' ? 'Niedostępny' : 'Nieaktywny';
                             
          const barColor = host.status === 'overloaded' ? 'var(--color-error)' :
                          host.status === 'busy' ? 'var(--color-warning)' :
                          host.status === 'available' ? 'var(--color-success)' : 
                          host.status === 'unavailable' ? 'var(--color-error)' :
                          'var(--color-idle)';

          const cpuColor = host.cpu_percent > 80 ? 'var(--color-error)' :
                          host.cpu_percent > 60 ? 'var(--color-warning)' :
                          'var(--color-success)';

          const memColor = host.memory_percent > 80 ? 'var(--color-error)' :
                          host.memory_percent > 60 ? 'var(--color-warning)' :
                          'var(--color-success)';

          const topProcesses = Array.isArray(host.top_processes) ? host.top_processes : [];
          const topByCpu = [...topProcesses]
            .sort((a, b) => (Number(b.cpu_percent) || 0) - (Number(a.cpu_percent) || 0))
            .slice(0, 5);
          const topByMem = [...topProcesses]
            .sort((a, b) => (Number(b.memory_percent) || 0) - (Number(a.memory_percent) || 0))
            .slice(0, 5);
          const renderTopRows = (list, metricKey, metricLabel) => {
            if (!list.length) {
              return '<div style="font-style: italic">Brak danych o procesach</div>';
            }
            return list
              .map((proc) => {
                const metric = Number(proc[metricKey]) || 0;
                const name = proc.name || "process";
                const pid = proc.pid ? `#${proc.pid}` : "";
                return `
                  <div class="flex justify-between" style="font-size: 11px; margin-top: 2px">
                    <span>${escapeHtml(name)} <span class="text-secondary">${escapeHtml(pid)}</span></span>
                    <span>${metric.toFixed(1)}% ${metricLabel}</span>
                  </div>
                `;
              })
              .join("");
          };
          const topCpuRows = renderTopRows(topByCpu, "cpu_percent", "CPU");
          const topMemRows = renderTopRows(topByMem, "memory_percent", "RAM");

          html += `
            <div style="margin-bottom: var(--spacing-lg); padding-bottom: var(--spacing-md); border-bottom: 1px solid var(--color-border)">
              <div class="flex justify-between mb-sm">
                <div>
                  <span style="font-weight: 600; font-size: 14px">${escapeHtml(host.name)}</span>
                  <span class="text-secondary" style="font-size: 11px; margin-left: 8px">${escapeHtml(host.host)}</span>
                </div>
                <div class="host-load-meta">
                  <span class="font-bold">${host.worker_count}/${host.max_recommended}</span>
                  <span class="badge badge-sm badge-${statusClass}" style="margin-left: 8px">${statusLabel}</span>
                  <button
                    class="btn btn-ghost btn-sm host-refresh-btn"
                    data-host-id="${escapeHtml(host.id)}"
                    onclick="refreshHostLoadFor(this.dataset.hostId)"
                    title="Odśwież dane hosta"
                  >
                    Odśwież
                  </button>
                </div>
              </div>
              
              <!-- Workerzy -->
              <div style="margin-bottom: var(--spacing-sm)">
                <div class="flex justify-between" style="font-size: 11px; margin-bottom: 2px">
                  <span class="text-secondary">Workery</span>
                  <span>${host.load_percentage}%</span>
                </div>
                <div class="progress" style="height: 6px">
                  <div class="progress-bar" style="width: ${host.load_percentage}%; background: ${barColor}"></div>
                </div>
              </div>

              ${host.system_available ? `
                <!-- CPU -->
                <div style="margin-bottom: var(--spacing-sm)">
                  <div class="flex justify-between" style="font-size: 11px; margin-bottom: 2px">
                    <span class="text-secondary">CPU</span>
                    <span>${host.cpu_percent.toFixed(1)}%</span>
                  </div>
                  <div class="progress" style="height: 6px">
                    <div class="progress-bar" style="width: ${host.cpu_percent}%; background: ${cpuColor}"></div>
                  </div>
                </div>

                <!-- RAM -->
                <div style="margin-bottom: var(--spacing-sm)">
                  <div class="flex justify-between" style="font-size: 11px; margin-bottom: 2px">
                    <span class="text-secondary">RAM</span>
                    <span>${host.memory_percent.toFixed(1)}% (${host.memory_used_gb.toFixed(1)}/${host.memory_total_gb.toFixed(1)} GB)</span>
                  </div>
                  <div class="progress" style="height: 6px">
                    <div class="progress-bar" style="width: ${host.memory_percent}%; background: ${memColor}"></div>
                  </div>
                </div>

                ${Number.isFinite(host.chrome_process_count) ? `
                  <div class="flex justify-between" style="font-size: 11px; color: var(--color-text-secondary); align-items: center">
                    <span>Browsers (Playwright): ${host.chrome_process_count}</span>
                    <button
                      class="btn btn-ghost btn-sm host-kill-browsers-btn"
                      data-host-id="${escapeHtml(host.id)}"
                      onclick="killHostBrowsers(this.dataset.hostId)"
                      title="Zabij procesy przeglądarek (Playwright) na tym hoście"
                    >
                      Kill
                    </button>
                  </div>
                ` : ''}
              ` : `
                <div style="font-size: 11px; color: var(--color-text-secondary); font-style: italic">
                  Zasoby systemowe niedostępne
                  ${host.system_error ? `<div style="margin-top: 2px; font-style: normal">Powód: ${escapeHtml(host.system_error)}</div>` : ""}
                </div>
              `}

              ${host.active_profiles.length > 0 ? `
                <div style="margin-top: 8px; font-size: 11px; color: var(--color-text-secondary)">
                  <strong>Profile:</strong> ${host.active_profiles.join(', ')}
                </div>
              ` : ''}

              <div class="host-top-processes">
                <div class="host-top-column">
                  <div class="host-top-title">Top procesy CPU</div>
                  ${topCpuRows}
                </div>
                <div class="host-top-column">
                  <div class="host-top-title">Top procesy RAM</div>
                  ${topMemRows}
                </div>
              </div>
            </div>
          `;
        });

        container.innerHTML = html;
      }

      function hardRefreshNoCache() {
        try {
          sessionStorage.setItem("hard_refresh_pending", "1");
        } catch (e) {}
        const url = new URL(window.location.href);
        url.searchParams.set("cache_bust", Date.now().toString());
        // lgtm[js/client-side-unvalidated-url-redirection]
        // deepcode ignore OR: URL is constructed from current location, only adding cache_bust parameter
        window.location.replace(url.toString());
      }

      function markReloadOverlayPending() {
        try {
          sessionStorage.setItem("hard_refresh_pending", "1");
        } catch (e) {}
      }

      function reloadWithCacheBust() {
        const url = new URL(window.location.href);
        url.searchParams.set("cache_bust", Date.now().toString());
        // lgtm[js/client-side-unvalidated-url-redirection]
        // deepcode ignore OR: URL is constructed from current location, only adding cache_bust parameter
        window.location.replace(url.toString());
      }

      async function fetchWithTimeout(url, options = {}, timeoutMs = 3000) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
        try {
          return await fetch(url, { ...options, signal: controller.signal });
        } finally {
          clearTimeout(timeoutId);
        }
      }

      function applyCacheBustToAssets(bust) {
        if (!bust) return;
        const links = document.querySelectorAll(
          'link[rel="stylesheet"], link[rel="icon"]',
        );
        links.forEach((link) => {
          try {
            const url = new URL(link.href, window.location.origin);
            url.searchParams.set("v", bust);
            link.href = url.toString();
          } catch (e) {
            // Ignore malformed URLs to avoid breaking the page.
          }
        });
      }

      // Helper function to safely update DOM elements
      function safeUpdate(id, value) {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
      }

      function formatStartTimestamp(value) {
        if (!value) return "-";
        const parsed = new Date(value);
        if (Number.isNaN(parsed.getTime())) return "-";
        return parsed.toLocaleTimeString();
      }

      const STARTING_GRACE_MS = 3000;
      const startGraceUntil = new Map();
      const MANUAL_STOP_GRACE_MS = 45000;
      const manualStopUntil = new Map();

      function markStartGrace(profileName, durationMs = STARTING_GRACE_MS) {
        startGraceUntil.set(profileName, Date.now() + durationMs);
      }

      function markManualStop(profileName, durationMs = MANUAL_STOP_GRACE_MS) {
        manualStopUntil.set(profileName, Date.now() + durationMs);
      }

      function hasManualStopIntent(profileName) {
        const until = manualStopUntil.get(profileName);
        if (!until) return false;
        if (Date.now() > until) {
          manualStopUntil.delete(profileName);
          return false;
        }
        return true;
      }

      function applyStartGrace(profiles) {
        const now = Date.now();
        return (profiles || []).map((profile) => {
          const until = startGraceUntil.get(profile.name);
          if (!until) return profile;
          if (now > until) {
            startGraceUntil.delete(profile.name);
            return profile;
          }
          if (["active", "starting", "stopping"].includes(profile.status)) {
            startGraceUntil.delete(profile.name);
            return profile;
          }
          return {
            ...profile,
            status: "starting",
            status_label: "STARTING...",
          };
        });
      }

      const START_JOB_ICON =
        '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3" /></svg>';
      const STOP_ALL_ICON =
        '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="6" width="12" height="12" rx="1" /></svg>';

      function updateHeaderStartStopButton(profiles) {
        const btn = document.getElementById("startStopBtn");
        if (!btn) return;

        const hasRunning = (profiles || []).some((profile) =>
          ["active", "starting", "paused", "limit", "stopping"].includes(
            profile.status,
          ),
        );

        if (hasRunning) {
          btn.className = "btn btn-danger btn-sm";
          btn.title = "Stop All";
          btn.onclick = stopAllProfiles;
          btn.innerHTML = `${STOP_ALL_ICON}<span>Stop All</span>`;
        } else {
          btn.className = "btn btn-primary btn-sm";
          btn.title = "Konfiguracja i Start";
          btn.onclick = () => switchTab("jobconfig");
          btn.innerHTML = `${START_JOB_ICON}<span>Start Job</span>`;
        }
      }

      function updateStats(data) {
        const stats = data.stats || {};
        const profiles = data.profiles || [];

        // Count statuses
        const activeCount = profiles.filter(
          (p) => p.status === "active",
        ).length;
        const pausedCount = profiles.filter(
          (p) => p.status === "paused",
        ).length;
        const limitCount = profiles.filter((p) => p.status === "limit").length;
        const idleCount = profiles.filter(
          (p) => !p.status || p.status === "idle" || p.status === "error",
        ).length;
        const totalProfiles = profiles.length;
        const workersInitialized = profiles.reduce(
          (sum, p) => sum + (p.workers_initialized || 0),
          0,
        );
        const workersPromptSent = profiles.reduce(
          (sum, p) => sum + (p.workers_prompt_sent || 0),
          0,
        );

        const computedTodayScans = profiles.reduce(
          (sum, p) => sum + (p.processed_today ?? p.processed ?? 0),
          0,
        );
        // Always prefer database value from stats
        const todayScans = typeof stats.today_scans === "number" 
            ? stats.today_scans 
            : computedTodayScans;
        
        // Scans since last Full Reset (from database)
        const sinceResetScans = stats.since_reset_scans || stats.total_processed || 0;

        let batchId = "-";
        let proRemaining = "-";
        try {
          if (stats.batch_id) batchId = stats.batch_id;
          const raw = localStorage.getItem("jobConfig");
          if (batchId === "-" && raw) {
            const saved = JSON.parse(raw);
            if (saved?.batchId) batchId = saved.batchId;
          }
          if (stats.pro_remaining) proRemaining = stats.pro_remaining;
          const storedPro = localStorage.getItem("lastProRemaining");
          if (proRemaining === "-" && storedPro) proRemaining = storedPro;
        } catch (e) {}

        // Header stats
        safeUpdate("headerActiveProfiles", activeCount);
        safeUpdate("headerPausedProfiles", pausedCount);
        safeUpdate("headerLimitProfiles", limitCount);
        safeUpdate("headerTodayScans", todayScans);
        safeUpdate("headerSinceResetScans", sinceResetScans);
        safeUpdate("headerTotalProcessed", stats.total_processed || 0);
        safeUpdate("headerBatchId", batchId);
        safeUpdate("headerProRemaining", proRemaining);

        // Sidebar stats
        safeUpdate("sidebarActiveCount", activeCount);
        safeUpdate("sidebarPausedCount", pausedCount);
        safeUpdate("sidebarLimitCount", limitCount);
        safeUpdate("sidebarTodayScans", todayScans);

        // Overview stats
        safeUpdate("statTotalProfiles", totalProfiles);
        safeUpdate("statActiveWorkers", stats.active_workers || activeCount);
        safeUpdate("statTodayProcessed", todayScans);
        safeUpdate("statErrors", stats.errors || 0);
        safeUpdate("profilesWorkersInit", workersInitialized);
        safeUpdate("profilesWorkersPrompt", workersPromptSent);

        // Summary progress bars
        safeUpdate("summaryActive", activeCount);
        safeUpdate("summaryPaused", pausedCount);
        safeUpdate("summaryLimit", limitCount);
        safeUpdate("summaryIdle", idleCount);

        const total = totalProfiles || 1;
        document.getElementById("progressActive").style.width =
          (activeCount / total) * 100 + "%";
        document.getElementById("progressPaused").style.width =
          (pausedCount / total) * 100 + "%";
        document.getElementById("progressLimit").style.width =
          (limitCount / total) * 100 + "%";
        document.getElementById("progressIdle").style.width =
          (idleCount / total) * 100 + "%";

        // Filter counts
        document.getElementById("filterAllCount").textContent = totalProfiles;
        document.getElementById("filterActiveCount").textContent = activeCount;
        document.getElementById("filterPausedCount").textContent = pausedCount;
        document.getElementById("filterLimitCount").textContent = limitCount;
        document.getElementById("filterIdleCount").textContent = idleCount;

        updateHeaderStartStopButton(profiles);
        unlockRemoteHostEditing();
      }

      function updateProfiles(profiles) {
        // Debounce unexpected-stop toasts to avoid flapping statuses
        if (!window._pendingStopAlerts) {
          window._pendingStopAlerts = new Map();
        }

        // Detect status changes and show notifications
        if (profilesData && profilesData.length > 0) {
          profiles.forEach((newProfile) => {
            const oldProfile = profilesData.find(p => p.name === newProfile.name);
            if (oldProfile) {
              const oldStatus = oldProfile.status || 'idle';
              const newStatus = newProfile.status || 'idle';
              
              // Skip if status hasn't changed
              if (oldStatus === newStatus) {
                return;
              }
              
              console.log(`[Status Change] ${newProfile.name}: ${oldStatus} -> ${newStatus}`);
              
              // Detect crashes and unexpected stops
              // A profile is considered crashed if it was running (active/starting) and suddenly stopped
              const wasRunning = ['active', 'starting'].includes(oldStatus);
              const isNowStopped = ['idle', 'terminated', 'error', 'crashed'].includes(newStatus);
              const isExpectedStop = oldStatus === 'stopping'; // Expected stop transition
              
              if (wasRunning && isNowStopped && !isExpectedStop) {
                // Profile crashed or stopped unexpectedly (debounced)
                const pending = window._pendingStopAlerts.get(newProfile.name);
                if (pending) clearTimeout(pending);
                const timer = setTimeout(() => {
                  const current = profilesData?.find(p => p.name === newProfile.name);
                  const currentStatus = current?.status || 'idle';
                  const stillStopped = ['idle', 'terminated', 'error', 'crashed'].includes(currentStatus);
                  if (!stillStopped) return;

                  const times = loadLastStartTimes();
                  const lastStartValue = times ? times[newProfile.name] : null;
                  const lastStartMs = parseDateTime(lastStartValue);
                  const lastErrMs = parseDateTime(current?.last_error || null);
                  const errorInSession =
                    lastStartMs != null && lastErrMs != null && lastErrMs >= lastStartMs;

                  if (currentStatus === 'error' || currentStatus === 'crashed') {
                    if (autoRestartEnabled && errorInSession && !hasManualStopIntent(newProfile.name)) {
                      showToast(
                        'info',
                        'Auto-restart',
                        `Restarting crashed profile ${newProfile.name} (status: ${currentStatus})...`
                      );
                      startProfile(newProfile.name);
                    } else {
                      showToast(
                        'error',
                        'Profil uległ awarii',
                        `Profil ${newProfile.name} uległ awarii (status: ${currentStatus})`
                      );
                    }
                  } else {
                    if (hasManualStopIntent(newProfile.name)) {
                      return;
                    }
                    if (autoRestartEnabled && errorInSession) {
                      showToast(
                        'info',
                        'Auto-restart',
                        `Restarting stopped profile ${newProfile.name} (error detected in session)...`
                      );
                      startProfile(newProfile.name);
                    } else {
                      showToast(
                        'warning',
                        'Profil zatrzymany',
                        `Profil ${newProfile.name} został zatrzymany`
                      );
                    }
                  }
                }, 1500);
                window._pendingStopAlerts.set(newProfile.name, timer);
              } else if (oldStatus === 'active' && newStatus === 'limit') {
                // Limit reached
                showToast(
                  'warning',
                  'Osiągnięto limit',
                  `Profil ${newProfile.name} osiągnął limit i został zatrzymany`
                );
              } else if (oldStatus === 'active' && newStatus === 'paused') {
                // Profile paused
                showToast(
                  'info',
                  'Profil wstrzymany',
                  `Profil ${newProfile.name} został wstrzymany`
                );
              }
              
              // Clear pending stop alerts when profile recovers
              if (newStatus === 'active' || newStatus === 'starting' || newStatus === 'stopping') {
                const pending = window._pendingStopAlerts.get(newProfile.name);
                if (pending) {
                  clearTimeout(pending);
                  window._pendingStopAlerts.delete(newProfile.name);
                }
              }

              // Detect successful stops (from stopping to idle/terminated)
              if (oldStatus === 'stopping' && (newStatus === 'idle' || newStatus === 'terminated')) {
                // This is expected, stopProfile already shows success toast
                // No additional notification needed
              }
            }
          });
        }
        
        profilesData = profiles;


        profiles.forEach((profile) => {
          const statusValue = profile.status || "idle";
          const statusLabel = profile.status_label || statusValue || "IDLE";
          const criticalMessage = profile.critical_message || "";
          const criticalRequiresAction = Boolean(profile.critical_requires_action);
          const labelUpper = statusLabel.toUpperCase();

          const card = document.querySelector(
            `.profile-card[data-profile="${profile.name}"]`,
          );
          if (card) {
            // Update status
            card.className = `profile-card status-${statusValue}`;
            card.dataset.status = statusValue;

            // Update status badge
            const statusBadge = card.querySelector(".profile-status");
            if (statusBadge) {
              statusBadge.className = `profile-status ${escapeHtml(statusValue)}`;
              statusBadge.title = criticalMessage;
              statusBadge.innerHTML =
                statusValue === "active"
                  ? `<span style="width:6px;height:6px;background:currentColor;border-radius:50%;animation:pulse 2s infinite;"></span> ${escapeHtml(statusLabel)}`
                  : escapeHtml(statusLabel);
            }
            const headedBadge = card.querySelector(".profile-headed-badge");
            if (headedBadge) {
              headedBadge.classList.toggle("visible", Boolean(profile.headed));
            }
            const alertBadge = card.querySelector(".profile-alert-badge");
            if (alertBadge) {
              alertBadge.classList.toggle("visible", criticalRequiresAction);
              alertBadge.title = criticalMessage;
            }
            const promptBadge = card.querySelector(".profile-prompt-badge");
            if (promptBadge) {
              promptBadge.classList.toggle("visible", Boolean(profile.prompt_blocked));
              promptBadge.title = profile.last_error || "";
            }

            // Update stats
            const statValues = card.querySelectorAll(".profile-stat-value");
            if (statValues.length >= 3) {
              statValues[0].textContent = profile.processed || 0;
              statValues[1].textContent = (profile.tokens_k || 0) + "k";
              statValues[2].textContent = profile.errors || 0;
            }

            // Update actions
            const actionsContainer = card.querySelector(
              ".profile-card-actions",
            );
            if (actionsContainer) {
              const isActive = statusValue === "active" || statusValue === "starting" || statusValue === "stopping";
              const toggleLabel = profile.headed ? "Headed" : "Headless";
              const toggleTitle = profile.headed
                ? "Przełącz na headless"
                : "Przełącz na headed";
              actionsContainer.innerHTML = `
                            ${
                              isActive
                                ? `<button class="profile-action-btn danger" onclick="stopProfile(this.dataset.name)" data-name="${escapeHtml(profile.name)}" title="Zatrzymaj">Stop</button>`
                                : `<button class="profile-action-btn primary" onclick="startProfile(this.dataset.name)" data-name="${escapeHtml(profile.name)}" title="Uruchom">Start</button>`
                            }
                            <button class="profile-action-btn" onclick="toggleHeaded(this.dataset.name)" data-name="${escapeHtml(profile.name)}" title="${toggleTitle}">${toggleLabel}</button>
                            <button class="profile-action-btn" onclick="restartProfile(this.dataset.name)" data-name="${escapeHtml(profile.name)}" title="Restart">Restart</button>
                            <button class="profile-action-btn" onclick="showProfileDetails(this.dataset.name)" data-name="${escapeHtml(profile.name)}" title="Szczegóły">Info</button>
                            <button class="profile-action-btn" onclick="resetProfileConfirm(this.dataset.name)" data-name="${escapeHtml(profile.name)}" title="Reset profilu">Reset</button>
                        `;
            }
          }

          // NEW: Update List View (Table Rows)
          const row = document.querySelector(
            `.profile-row[data-profile="${profile.name}"]`,
          );
          if (row) {
            row.dataset.status = statusValue;
            row.dataset.lastError = profile.last_error || "-";
            row.dataset.lastActivity = profile.last_activity || "-";
            row.dataset.lastStart = profile.last_start || "";
            row.dataset.workersInit = profile.workers_initialized || 0;
            row.dataset.workersPrompt = profile.workers_prompt_sent || 0;
            row.dataset.processed = profile.processed || 0;
            row.dataset.tokensK = profile.tokens_k || 0;
            row.dataset.errors = profile.errors || 0;
            row.dataset.proxy = profile.proxy || "-";
            row.dataset.limitReset = profile.limit_reset || "-";

            // Update Status Badge (Column 3)
            const badge = row.querySelector(".badge");
            if (badge) {
              let badgeClass = "neutral";
              if (statusValue === "active") badgeClass = "success";
              else if (statusValue === "paused") badgeClass = "warning";
              else if (statusValue === "limit") badgeClass = "error";
              else if (statusValue === "error") badgeClass = "error";

              if (
                labelUpper.includes("START") ||
                labelUpper.includes("PONAWIANIE")
              ) {
                badgeClass = "info";
              }

              badge.className = `badge badge-${badgeClass}`;
              badge.textContent = statusLabel;
              badge.title = criticalMessage;
            }
            const headedBadge = row.querySelector(".profile-headed-badge");
            if (headedBadge) {
              headedBadge.classList.toggle("visible", Boolean(profile.headed));
            }
            const alertBadge = row.querySelector(".profile-alert-badge");
            if (alertBadge) {
              alertBadge.classList.toggle("visible", criticalRequiresAction);
              alertBadge.title = criticalMessage;
            }
            const promptBadge = row.querySelector(".profile-prompt-badge");
            if (promptBadge) {
              promptBadge.classList.toggle("visible", Boolean(profile.prompt_blocked));
              promptBadge.title = profile.last_error || "";
            }

            const modeProxy = row.querySelector(".mode-proxy");
            if (modeProxy) {
              modeProxy.textContent = profile.proxy || "-";
              modeProxy.title = profile.proxy_server || "";
            }

            const actionCell = row.cells[row.cells.length - 1];
            if (actionCell) {
              const isActive = statusValue === "active" || statusValue === "starting" || statusValue === "stopping";
              const toggleLabel = profile.headed ? "Headed" : "Headless";
              const toggleTitle = profile.headed
                ? "Przełącz na headless"
                : "Przełącz na headed";
              actionCell.innerHTML = `
                    <div class="flex gap-sm">
                      ${
                        isActive
                          ? `<button class="btn btn-danger btn-sm" onclick="stopProfile('${escapeHtml(profile.name)}')">Stop</button>`
                          : `<button class="btn btn-success btn-sm" onclick="startProfile('${escapeHtml(profile.name)}')">Start</button>`
                      }
                      <button class="btn btn-secondary btn-sm" onclick="toggleHeaded('${escapeHtml(profile.name)}')" title="${toggleTitle}">${toggleLabel}</button>
                      <button class="btn btn-secondary btn-sm" onclick="loginProfile('${escapeHtml(profile.name)}')" title="Zaloguj">Login</button>
                      <button class="btn btn-ghost btn-sm" onclick="showProfileDetails('${escapeHtml(profile.name)}')">Info</button>
                      <button class="btn btn-ghost btn-sm" onclick="resetProfileConfirm('${escapeHtml(profile.name)}')" title="Reset profilu">Reset</button>
                      ${
                        profile.name === "default"
                          ? `<button class="btn btn-ghost btn-sm text-error" disabled title="Nie można usunąć profilu domyślnego">Del</button>`
                          : `<button class="btn btn-ghost btn-sm text-error" onclick="deleteProfileConfirm('${escapeHtml(profile.name)}')" title="Usuń">Del</button>`
                      }
                    </div>
                  `;
            }

            // Update Stats (Cols 4-11)
            // Col index: 0=check, 1=name, 2=status, 3=mode, 4=win/workers,
            // 5=proc, 6=tok, 7=err, 8=last_error, 9=last, 10=limit_reset, 11=start, 12=act
            if (row.cells.length > 12) {
              row.cells[4].textContent = `${profile.workers_initialized || 0} / ${profile.workers_prompt_sent || 0}`;
              row.cells[5].textContent = profile.processed || 0;
              row.cells[6].textContent = (profile.tokens_k || 0) + "k";
              row.cells[7].textContent = profile.errors || 0;
              row.cells[8].innerHTML = formatDateTimeCell(profile.last_error || "-");
              row.cells[9].innerHTML = formatDateTimeCell(profile.last_activity || "-");
              row.cells[10].innerHTML = formatDateTimeCell(profile.limit_reset || "-");
              row.cells[11].textContent = formatStartTimestamp(profile.last_start);

              // Update Actions (Col 12)
              const actionsDiv = row.cells[12].querySelector("div");
              if (actionsDiv) {
                const isActive =
                  statusValue === "active" ||
                  statusValue === "starting" ||
                  statusValue === "stopping" ||
                  labelUpper.includes("START") ||
                  labelUpper.includes("PONAWIANIE");
                // If starting/retrying, we usually want to show Stop too, or at least disable Start

                const deleteButtonHtml =
                  profile.name === "default"
                    ? `<button class="btn btn-ghost btn-sm text-error" disabled title="Nie można usunąć profilu domyślnego">Del</button>`
                    : `<button class="btn btn-ghost btn-sm text-error" onclick="deleteProfileConfirm(this.dataset.name)" data-name="${escapeHtml(profile.name)}" title="Usuń">Del</button>`;
                actionsDiv.innerHTML = `
                                ${
                                  isActive
                                    ? `<button class="btn btn-danger btn-sm" onclick="stopProfile(this.dataset.name)" data-name="${escapeHtml(profile.name)}">Stop</button>`
                                    : `<button class="btn btn-success btn-sm" onclick="startProfile(this.dataset.name)" data-name="${escapeHtml(profile.name)}">Start</button>`
                                }
                                <button class="btn btn-secondary btn-sm" onclick="loginProfile(this.dataset.name)" data-name="${escapeHtml(profile.name)}" title="Zaloguj">Login</button>
                                <button class="btn btn-ghost btn-sm" onclick="showProfileDetails(this.dataset.name)" data-name="${escapeHtml(profile.name)}">Info</button>
                                <button class="btn btn-ghost btn-sm" onclick="resetProfileConfirm(this.dataset.name)" data-name="${escapeHtml(profile.name)}" title="Reset profilu">Reset</button>
                                ${deleteButtonHtml}
                            `;
              }
            }
          }
        });

        filterProfiles();
      }

      function updateLastUpdate() {
        const now = new Date();
        document.getElementById("lastUpdate").textContent =
          now.toLocaleTimeString("pl-PL");
      }

      // ============================================
      // Logs
      // ============================================

      async function refreshLogs() {
        try {
          const profileFilter =
            document.getElementById("logProfileFilter").value;
          const levelFilter = document.getElementById("logLevelFilter").value;

          const params = new URLSearchParams();
          if (profileFilter !== "all") params.set("profile", profileFilter);
          if (levelFilter !== "all") params.set("level", levelFilter);
          params.set("hours", "24");
          params.set("limit", "1000"); // Increase limit to show all events

          const response = await fetch(`/api/logs?${params}`);
          const data = await response.json();

          const container = document.getElementById("logContainer");
          const noLogs = document.getElementById("noLogsMessage");

          if (!data.logs || data.logs.length === 0) {
            container.innerHTML = "";
            container.appendChild(noLogs);
            noLogs.style.display = "";
            return;
          }

          noLogs.style.display = "none";

          // lgtm[js/xss]
          // deepcode ignore DOMXSS: content is escaped via escapeHtml()
          container.innerHTML = data.logs
            .map(
              (log) => `
                    <div class="log-entry">
                        <span class="log-time">${escapeHtml(log.time)}</span>
                        <span class="log-level ${escapeHtml(log.level.toLowerCase())}">${escapeHtml(log.level)}</span>
                        <span class="log-message">${escapeHtml(log.message)}</span>
                    </div>
                `,
            )
            .join("");
        } catch (e) {
          console.error("Failed to refresh logs:", e);
        }
      }

      async function refreshServiceLog() {
        const source = document.getElementById("serviceLogSelect").value;
        const tail = document.getElementById("serviceLogTail").value || "400";
        const container = document.getElementById("serviceLogContainer");
        try {
          const response = await fetch(
            `/api/logs/file?name=${encodeURIComponent(source)}&tail=${encodeURIComponent(tail)}`,
          );
          const data = await response.json();
          if (!data.log) {
            container.innerHTML = `
              <div class="empty-state">
                <h3 class="empty-title">Brak logów</h3>
                <p class="empty-message">Log jest pusty lub nie istnieje.</p>
              </div>
            `;
            return;
          }
          const lines = data.log.split("\\n");
          const entries = lines
            .map((line) => {
              const upper = line.toUpperCase();
              let level = "INFO";
              if (upper.includes("ERROR") || upper.includes("FAIL")) level = "ERROR";
              else if (upper.includes("WARN")) level = "WARNING";
              return `
                <div class="log-entry">
                  <span class="log-time">${escapeHtml(data.path || source)}</span>
                  <span class="log-level ${level.toLowerCase()}">${level}</span>
                  <span class="log-message">${escapeHtml(line)}</span>
                </div>
              `;
            })
            .join("");
          // lgtm[js/xss]
          // deepcode ignore DOMXSS: content is escaped via escapeHtml()
          container.innerHTML = entries || `
            <div class="empty-state">
              <h3 class="empty-title">Brak logów</h3>
              <p class="empty-message">Log jest pusty.</p>
            </div>
          `;
        } catch (e) {
          console.error("Failed to refresh service logs:", e);
          container.innerHTML = `
            <div class="empty-state">
              <h3 class="empty-title">Błąd</h3>
              <p class="empty-message">Nie udało się pobrać logów.</p>
            </div>
          `;
        }
      }

      let serviceLogInterval = null;

      function startServiceLogAutoRefresh() {
        stopServiceLogAutoRefresh();
        const val = parseInt(
          document.getElementById("serviceLogAuto").value || "0",
          10,
        );
        if (val > 0) {
          serviceLogInterval = setInterval(refreshServiceLog, val * 1000);
        }
      }

      function stopServiceLogAutoRefresh() {
        if (serviceLogInterval) {
          clearInterval(serviceLogInterval);
          serviceLogInterval = null;
        }
      }

      function filterLogs() {
        refreshLogs();
      }

      function clearLogs() {
        document.getElementById("logContainer").innerHTML = `
                <div class="empty-state" id="noLogsMessage">
                    <div class="empty-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                        </svg>
                    </div>
                    <h3 class="empty-title">Brak logów</h3>
                    <p class="empty-message">Logi pojawią się tutaj po rozpoczęciu przetwarzania.</p>
                </div>
            `;
        // Clear backend logs too so they don't reappear on refresh
        fetch("/api/logs/clear", { method: "POST" })
          .then(() => refreshLogs())
          .catch((e) => console.warn("Failed to clear logs:", e));
      }

      // ============================================
      // Modal
      // ============================================

      function showProfileDetails(profileName) {
        const modal = document.getElementById("profileModal");
        document.getElementById("modalProfileName").textContent = profileName;

        const profile = profilesData.find((p) => p.name === profileName) || {};

        // Build comprehensive profile info
        const infoSections = [];
        
        // Basic Info Section
        infoSections.push(`
          <div class="info-section">
            <h4 style="font-size: 14px; font-weight: 600; margin-bottom: var(--spacing-sm); color: var(--color-text-primary);">Podstawowe informacje</h4>
            <div style="display: grid; grid-template-columns: 140px 1fr; gap: var(--spacing-xs); font-size: 13px;">
              <span class="text-secondary">Nazwa profilu:</span>
              <span class="text-primary font-medium">${escapeHtml(profile.name || '-')}</span>
              
              <span class="text-secondary">Status:</span>
              <span class="badge badge-${profile.status === "active" ? "success" : profile.status === "paused" ? "warning" : profile.status === "limit" ? "error" : "neutral"}">
                ${escapeHtml(profile.status || "idle")}
              </span>
            </div>
          </div>
        `);

        // Statistics Section
        infoSections.push(`
          <div class="info-section">
            <h4 style="font-size: 14px; font-weight: 600; margin-bottom: var(--spacing-sm); color: var(--color-text-primary);">Statystyki</h4>
            <div style="display: grid; grid-template-columns: 140px 1fr; gap: var(--spacing-xs); font-size: 13px;">
              <span class="text-secondary">Przetworzonych:</span>
              <span class="text-primary font-bold">${escapeHtml(profile.processed || 0)}</span>
              
              <span class="text-secondary">Tokeny:</span>
              <span class="text-primary font-bold">${escapeHtml(profile.tokens_k || 0)}k</span>
              
              <span class="text-secondary">Błędy:</span>
              <span class="text-primary font-bold ${(profile.errors || 0) > 0 ? 'text-error' : ''}">${escapeHtml(profile.errors || 0)}</span>
            </div>
          </div>
        `);

        // Activity Section
        const activityInfo = [];
        if (profile.last_activity) {
          activityInfo.push(`
            <span class="text-secondary">Ostatnia aktywność:</span>
            <span class="text-primary">${escapeHtml(profile.last_activity)}</span>
          `);
        }
        if (profile.current_file) {
          activityInfo.push(`
            <span class="text-secondary">Aktualny plik:</span>
            <span class="text-primary font-mono" style="font-size: 11px; word-break: break-all;">${escapeHtml(profile.current_file)}</span>
          `);
        }
        if (profile.current_action) {
          activityInfo.push(`
            <span class="text-secondary">Akcja:</span>
            <span class="text-primary">${escapeHtml(profile.current_action)}</span>
          `);
        }
        
        if (activityInfo.length > 0) {
          infoSections.push(`
            <div class="info-section">
              <h4 style="font-size: 14px; font-weight: 600; margin-bottom: var(--spacing-sm); color: var(--color-text-primary);">Aktywność</h4>
              <div style="display: grid; grid-template-columns: 140px 1fr; gap: var(--spacing-xs); font-size: 13px;">
                ${activityInfo.join('')}
              </div>
            </div>
          `);
        }

        // Additional fields if available
        const additionalFields = [];
        if (profile.proxy) {
          additionalFields.push(`
            <span class="text-secondary">Proxy:</span>
            <span class="text-primary font-mono">${escapeHtml(profile.proxy)}</span>
          `);
        }
        if (profile.limit_reset) {
          additionalFields.push(`
            <span class="text-secondary">Reset limitu:</span>
            <span class="text-primary">${escapeHtml(profile.limit_reset)}</span>
          `);
        }
        if (profile.limit_status) {
          additionalFields.push(`
            <span class="text-secondary">Status limitu:</span>
            <span class="text-primary">${escapeHtml(profile.limit_status)}</span>
          `);
        }
        if (profile.pid) {
          additionalFields.push(`
            <span class="text-secondary">PID:</span>
            <span class="text-primary font-mono">${escapeHtml(profile.pid)}</span>
          `);
        }
        if (profile.uptime) {
          additionalFields.push(`
            <span class="text-secondary">Uptime:</span>
            <span class="text-primary">${escapeHtml(profile.uptime)}</span>
          `);
        }
        
        if (additionalFields.length > 0) {
          infoSections.push(`
            <div class="info-section">
              <h4 style="font-size: 14px; font-weight: 600; margin-bottom: var(--spacing-sm); color: var(--color-text-primary);">Szczegóły techniczne</h4>
              <div style="display: grid; grid-template-columns: 140px 1fr; gap: var(--spacing-xs); font-size: 13px;">
                ${additionalFields.join('')}
              </div>
            </div>
          `);
        }

        infoSections.push(`
          <div class="info-section">
            <h4 style="font-size: 14px; font-weight: 600; margin-bottom: var(--spacing-xs); color: var(--color-text-primary);">Logi profilu</h4>
            <div id="profileLogsStatus" class="text-secondary" style="font-size: 12px; margin-bottom: 6px;">Ładowanie...</div>
            <div
              class="log-viewer"
              id="profileLogsOutput"
              style="
                height: 170px;
                background: #0f172a;
                color: #e2e8f0;
                padding: 12px;
                overflow: auto;
                font-family: &quot;JetBrains Mono&quot;, monospace;
                font-size: 12px;
                border-radius: 6px;
                border: 1px solid var(--border-color);
              "
            >Ładowanie logów...</div>
            <div style="height: 10px;"></div>
            <h4 style="font-size: 14px; font-weight: 600; margin-bottom: var(--spacing-xs); color: var(--color-text-primary);">Błędy profilu</h4>
            <div
              class="log-viewer"
              id="profileErrorLogsOutput"
              style="
                height: 140px;
                background: #0f172a;
                color: #e2e8f0;
                padding: 12px;
                overflow: auto;
                font-family: &quot;JetBrains Mono&quot;, monospace;
                font-size: 12px;
                border-radius: 6px;
                border: 1px solid var(--border-color);
              "
            >Ładowanie błędów...</div>
          </div>
        `);

        document.getElementById("modalContent").innerHTML = `
          <div style="display: flex; flex-direction: column; gap: var(--spacing-md);">
            ${infoSections.join('')}
          </div>
        `;

        modal.classList.add("visible");
        fetchProfileLogs(profileName);
      }

      function closeModal() {
        document.getElementById("profileModal").classList.remove("visible");
      }

      async function fetchProfileLogs(profileName) {
        const statusEl = document.getElementById("profileLogsStatus");
        const logEl = document.getElementById("profileLogsOutput");
        const errEl = document.getElementById("profileErrorLogsOutput");
        if (!logEl || !errEl) return;

        try {
          const response = await fetch(
            `/api/profile/${encodeURIComponent(profileName)}/logs?tail=200&error_tail=120`
          );
          const data = await response.json();

          if (document.getElementById("modalProfileName").textContent !== profileName) {
            return;
          }

          if (!response.ok) {
            throw new Error(data.detail || "Request failed");
          }

          if (!data.exists) {
            if (statusEl) statusEl.textContent = "Brak pliku logu dla profilu.";
            logEl.textContent = "Brak logów profilu.";
            errEl.textContent = "Brak błędów.";
            return;
          }

          if (statusEl) {
            statusEl.textContent = `Ostatnie ${data.lines || 0} linii logu.`;
          }
          logEl.textContent = data.log || "Brak logów profilu.";
          errEl.textContent = data.errors || "Brak błędów.";
        } catch (e) {
          if (statusEl) statusEl.textContent = "Nie udało się pobrać logów.";
          logEl.textContent = `Błąd pobierania logów: ${e.message || e}`;
          errEl.textContent = "";
        }
      }

      function copyProfileInfo() {
        const profileName = document.getElementById("modalProfileName").textContent;
        const profile = profilesData.find((p) => p.name === profileName) || {};
        
        // Build text to copy
        const lines = [];
        lines.push(`=== Profil: ${profile.name || '-'} ===`);
        lines.push('');
        lines.push('PODSTAWOWE INFORMACJE:');
        lines.push(`  Nazwa profilu: ${profile.name || '-'}`);
        lines.push(`  Status: ${profile.status || 'idle'}`);
        lines.push('');
        lines.push('STATYSTYKI:');
        lines.push(`  Przetworzonych: ${profile.processed || 0}`);
        lines.push(`  Tokeny: ${profile.tokens_k || 0}k`);
        lines.push(`  Błędy: ${profile.errors || 0}`);
        
        if (profile.last_activity || profile.current_file) {
          lines.push('');
          lines.push('AKTYWNOŚĆ:');
          if (profile.last_activity) {
            lines.push(`  Ostatnia aktywność: ${profile.last_activity}`);
          }
          if (profile.current_file) {
            lines.push(`  Aktualny plik: ${profile.current_file}`);
          }
          if (profile.current_action) {
            lines.push(`  Akcja: ${profile.current_action}`);
          }
        }
        
        if (profile.proxy || profile.limit_reset || profile.limit_status || profile.pid || profile.uptime) {
          lines.push('');
          lines.push('SZCZEGÓŁY TECHNICZNE:');
          if (profile.proxy) {
            lines.push(`  Proxy: ${profile.proxy}`);
          }
          if (profile.limit_reset) {
            lines.push(`  Reset limitu: ${profile.limit_reset}`);
          }
          if (profile.limit_status) {
            lines.push(`  Status limitu: ${profile.limit_status}`);
          }
          if (profile.pid) {
            lines.push(`  PID: ${profile.pid}`);
          }
          if (profile.uptime) {
            lines.push(`  Uptime: ${profile.uptime}`);
          }
        }
        
        const textToCopy = lines.join('\n');
        
        navigator.clipboard.writeText(textToCopy).then(() => {
          showToast('success', 'Skopiowano', 'Informacje o profilu zostały skopiowane do schowka');
        }).catch(err => {
          console.error('Failed to copy:', err);
          showToast('error', 'Błąd', 'Nie udało się skopiować informacji');
        });
      }

      // Close modal on overlay click
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") closeModal();
      });

      // ============================================
      // Routing & Breadcrumbs
      // ============================================

      const TAB_NAMES = {
        overview: "Przegląd",
        profiles: "Profile",
        preview: "Podgląd",
        logs: "Logi",
        limits: "Limity",
        postprocess: "Post-Process",
        jobconfig: "Konfiguracja Job",

        settings: "Ustawienia",
      };

      const CONFIG_TAB_NAMES = {
        basic: "Podstawowe",
        performance: "Wydajność",
        database: "Database",
        preprocessing: "Preprocessing",
        advanced: "Zaawansowane",
      };

      function updateBreadcrumb(mainTab, subTab = null) {
        const container = document.getElementById("breadcrumb");
        let html = '<span class="breadcrumb-item">Menu</span>';

        // Resolve Main Tab Name safely
        let mainName = TAB_NAMES[mainTab];
        if (!mainName) {
          try {
            // Safe selector construction
            const safeSelector = mainTab.replace(/["\\]/g, "\\$&");
            const navItem = document.querySelector(
              `.nav-item[data-tab="${safeSelector}"] .nav-item-text`,
            );
            if (navItem) mainName = navItem.innerText;
          } catch (e) {}
        }
        if (!mainName) mainName = mainTab;

        const safeMainTab = escapeHtml(mainTab);
        const safeMainName = escapeHtml(mainName);

        if (subTab) {
          // Use href="#" for navigation, removed unsafe onclick
          html += `<span class="breadcrumb-item"><a href="#${safeMainTab}" style="color: inherit; text-decoration: none;">${safeMainName}</a></span>`;

          // Resolve Sub Tab Name safely
          let subName = CONFIG_TAB_NAMES[subTab];
          if (!subName) {
            try {
              const safeSelector = subTab.replace(/["\\]/g, "\\$&");
              const configTabBtn = document.querySelector(
                `.config-tab[data-config-tab="${safeSelector}"]`,
              );
              if (configTabBtn) subName = configTabBtn.innerText;
            } catch (e) {}
          }
          if (!subName) subName = subTab;

          const safeSubName = escapeHtml(subName);

          html += `<span class="breadcrumb-item active">${safeSubName}</span>`;
        } else {
          html += `<span class="breadcrumb-item active">${safeMainName}</span>`;
        }

        container.innerHTML = html;
      }

      function handleHashChange() {
        const hash = window.location.hash.slice(1); // Remove #
        if (!hash) {
          switchTab("overview");
          return;
        }

        const parts = hash.split("/");
        let mainTab = parts[0];
        const subTab = parts[1];
        if (mainTab === "activity") {
          mainTab = "preview";
          window.location.hash = "preview";
        }

        // 1. Switch Main Tab
        // We call the internal logic of switchTab directly to avoid loop or just use it
        // Code of switchTab updates UI.
        // We need to bypass hash update in switchTab if it comes from here?
        // Actually, if we set hash to what it already is, it's fine.

        // Manually switch Main Tab UI
        document.querySelectorAll(".nav-item").forEach((item) => {
          item.classList.toggle("active", item.dataset.tab === mainTab);
        });
        document.querySelectorAll(".tab-panel").forEach((panel) => {
          panel.classList.toggle("active", panel.id === "tab-" + mainTab);
        });
        currentTab = mainTab;
        if (mainTab === "preview") refreshLivePreviewAll();
        if (mainTab === "logs") {
          refreshLogs();
          stopServiceLogAutoRefresh();
        }
        if (mainTab === "services") {
          refreshServiceLog();
          startServiceLogAutoRefresh();
        }

        // 2. Switch Sub Tab if applicable


        updateBreadcrumb(mainTab, subTab);
      }

      // Initialize Router
      window.addEventListener("hashchange", handleHashChange);
      window.addEventListener("DOMContentLoaded", () => {
        handleHashChange();
        const hardRefreshPending =
          sessionStorage.getItem(HARD_REFRESH_PENDING_KEY) === "1";
        if (hardRefreshPending) {
          // Full Reset / hard refresh should clear ephemeral per-profile UI state.
          // Otherwise the Start column will "look into the past".
          clearAllLastStartTimes();
          document.body.classList.add("hard-refreshing");
          const overlay = document.getElementById("hardRefreshOverlay");
          if (overlay) overlay.classList.add("show");
          // Fallback: clear overlay if load event never fires.
          setTimeout(clearHardRefreshOverlay, 7000);
        }
        const bust = new URLSearchParams(window.location.search).get(
          "cache_bust",
        );
        applyCacheBustToAssets(bust);
        // startConnectionCheck(); // TODO: Implement connection check
        refreshData();
        loadWebshareSettings();
        const autoSelect = document.getElementById("serviceLogAuto");
        if (autoSelect) {
          autoSelect.addEventListener("change", startServiceLogAutoRefresh);
        }
      });

      window.addEventListener("load", () => {
        clearHardRefreshOverlay();
      });

      window.addEventListener("pageshow", () => {
        clearHardRefreshOverlay();
      });

      function clearHardRefreshOverlay() {
        if (sessionStorage.getItem(HARD_REFRESH_PENDING_KEY) !== "1") {
          return;
        }
        sessionStorage.removeItem(HARD_REFRESH_PENDING_KEY);
        document.body.classList.remove("hard-refreshing");
        const overlay = document.getElementById("hardRefreshOverlay");
        if (overlay) overlay.classList.remove("show");
      }

      // ============================================
      // Toast Notifications
      // ============================================

      function _firstSentence(text) {
        if (!text) return "";
        const match = text.match(/[.!?]/);
        if (!match || match.index === undefined) return text;
        return text.slice(0, match.index + 1);
      }

      function _normalizeToast(type, title, message, options = {}) {
        const normalized = {
          type,
          title: title || "",
          message: message || "",
          timeoutMs: 5000,
        };
        const context = typeof options === "string" ? options : options.context;
        if (context) {
          normalized.title = `Host: ${context} — ${normalized.title}`;
        }
        if (type === "success") {
          normalized.message = _firstSentence(normalized.message);
          normalized.timeoutMs = 3000;
        } else if (type === "warning") {
          normalized.timeoutMs = 6000;
        } else if (type === "error") {
          normalized.timeoutMs = 8000;
        } else if (type === "info") {
          normalized.timeoutMs = 5000;
        }
        if (typeof options === "object" && options.timeoutMs) {
          normalized.timeoutMs = options.timeoutMs;
        }
        return normalized;
      }

      function showToast(type, title, message, options = {}) {
        const normalized = _normalizeToast(type, title, message, options);
        const container = document.getElementById("toastContainer");

        const icons = {
          success:
            '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>',
          error:
            '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
          warning:
            '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
          info: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>',
        };

        const copyIcon = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
        
        const toast = document.createElement("div");
        toast.className = `toast ${normalized.type}`;
        toast.innerHTML = `
                <span class="toast-icon">${icons[normalized.type]}</span>
                <div class="toast-content">
                    <div class="toast-title">${escapeHtml(normalized.title)}</div>
                    <div class="toast-message">${escapeHtml(normalized.message)}</div>
                </div>
                <div class="toast-actions">
                    <button class="toast-copy" title="Kopiuj wiadomość">${copyIcon}</button>
                    <button class="toast-close">×</button>
                </div>
            `;
        
        // Add copy functionality
        const copyBtn = toast.querySelector('.toast-copy');
        const closeBtn = toast.querySelector('.toast-close');
        
        copyBtn.addEventListener('click', async () => {
            try {
                const textToCopy = `${normalized.title}\n${normalized.message}`;
                await navigator.clipboard.writeText(textToCopy);
                
                // Visual feedback
                copyBtn.classList.add('copied');
                copyBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>';
                
                setTimeout(() => {
                    copyBtn.classList.remove('copied');
                    copyBtn.innerHTML = copyIcon;
                }, 2000);
            } catch (err) {
                console.error('Failed to copy:', err);
            }
        });
        
        closeBtn.addEventListener('click', () => {
            toast.remove();
        });

        container.appendChild(toast);

        // Auto remove after timeout
        setTimeout(() => {
          if (toast.parentElement) {
            toast.style.opacity = "0";
            setTimeout(() => toast.remove(), 300);
          }
        }, normalized.timeoutMs);
      }

      function resolveHostLabel(hostContext) {
        if (!hostContext) return "";
        if (hostContext === "local") return "Lokalny";
        if (hostContext === "localhost") return "Localhost";
        if (Array.isArray(remoteHostsData)) {
          const byId = remoteHostsData.find((h) => h?.id === hostContext);
          if (byId) return byId.name || byId.host || hostContext;
          const byHost = remoteHostsData.find((h) => h?.host === hostContext);
          if (byHost) return byHost.name || byHost.host || hostContext;
        }
        return hostContext;
      }

      function toastHost(type, title, message, hostContext) {
        const label = resolveHostLabel(hostContext);
        showToast(type, title, message, { context: label });
      }

      // ============================================
      // Checkbox Event Listeners
      // ============================================

      document.querySelectorAll(".profile-checkbox").forEach((checkbox) => {
        checkbox.addEventListener("change", updateSelection);
      });

      document
        .querySelectorAll(".profile-checkbox-table")
        .forEach((checkbox) => {
          checkbox.addEventListener("change", updateSelectionFromTable);
        });

      // ============================================
      // Start Job Modal (Recovered)
      // ============================================



        // Removed duplicate switchConfigTab function


        function selectAllJobProfiles() {
            document.querySelectorAll('.job-profile-cb').forEach(cb => cb.checked = true);
        }

        function selectOkLimitProfiles() {
            // Select only profiles that don't have limit status
            document.querySelectorAll('.job-profile-cb').forEach(cb => {
                const profile = profilesData.find(p => p.name === cb.value);
                cb.checked = profile && profile.status !== 'limit';
            });
        }

        function clearJobProfiles() {
            document.querySelectorAll('.job-profile-cb').forEach(cb => cb.checked = false);
        }

        const DEFAULT_JOB_CONFIG = {
            // Basic
            // sourcePath: "", // Don't reset source path as it might be from DB
            headed: false,
            engine: "auto",
            
            // Performance
            windows: 2,
            tabsPerWindow: 2,
            scansPerWorker: 2,
            collectTimeout: 400,
            closeIdleTabs: true,
            maxTabsPerContext: 0,
            isolatedContexts: false,
            contextPoolSize: 0,
            viewportWidth: 1200,
            viewportHeight: 800,
            reducedMotion: true,

            // Database
            pgEnabled: true,
            pgDsn: "postgresql://tomaasz:123Karinka!%40%23@127.0.0.1:5432/ocr",
            pgTable: "public.ocr_raw_texts",

            // Preprocess
            preprocMaxDim: 2500,
            preprocMedianKernel: 3,
            preprocDenoise: 8,
            preprocMorph: 2,
            preprocClahe: 2.0,
            preprocClaheGrid: "8,8",
            preprocLocalSigma: 12.0,
            preprocLocalAmount: 0.35,

            // Advanced
            continueMode: true,
            autoAdvance: true,
            proOnly: true,
            cleanTmp: true,
            debugArtifacts: false,
            captureVideo: false
        };

        function resetJobConfig() {
            document.getElementById('resetConfigModal').classList.add('visible');
        }

        function closeResetConfigModal() {
            document.getElementById('resetConfigModal').classList.remove('visible');
        }

        function confirmResetJobConfig() {
            closeResetConfigModal();
            
            // Reset Source Path
            localStorage.removeItem('lastSourcePath');
            document.getElementById('jobSourcePath').value = '';
            loadDefaultSourcePath();

            // Basic
            document.getElementById('jobHeadedMode').checked = DEFAULT_JOB_CONFIG.headed;
            document.getElementById('jobEngine').value = DEFAULT_JOB_CONFIG.engine;

            // Performance
            document.getElementById('jobWindows').value = DEFAULT_JOB_CONFIG.windows;
            document.getElementById('jobTabsPerWindow').value = DEFAULT_JOB_CONFIG.tabsPerWindow;
            document.getElementById('jobScansPerWorker').value = DEFAULT_JOB_CONFIG.scansPerWorker;
            updateTotalWorkers();
            document.getElementById('jobCollectTimeout').value = DEFAULT_JOB_CONFIG.collectTimeout;
            document.getElementById('jobCloseIdleTabs').checked = DEFAULT_JOB_CONFIG.closeIdleTabs;
            document.getElementById('jobMaxTabsPerContext').value = DEFAULT_JOB_CONFIG.maxTabsPerContext;
            document.getElementById('jobIsolatedContexts').checked = DEFAULT_JOB_CONFIG.isolatedContexts;
            document.getElementById('jobContextPoolSize').value = DEFAULT_JOB_CONFIG.contextPoolSize;
            document.getElementById('jobViewportWidth').value = DEFAULT_JOB_CONFIG.viewportWidth;
            document.getElementById('jobViewportHeight').value = DEFAULT_JOB_CONFIG.viewportHeight;
            document.getElementById('jobReducedMotion').checked = DEFAULT_JOB_CONFIG.reducedMotion;

            // Database
            document.getElementById('jobPgEnabled').checked = DEFAULT_JOB_CONFIG.pgEnabled;
            document.getElementById('jobPgDsn').value = DEFAULT_JOB_CONFIG.pgDsn;
            document.getElementById('jobPgTable').value = DEFAULT_JOB_CONFIG.pgTable;

            // Preprocess
            document.getElementById('jobPreprocMaxDim').value = DEFAULT_JOB_CONFIG.preprocMaxDim;
            document.getElementById('jobPreprocMedianKernel').value = DEFAULT_JOB_CONFIG.preprocMedianKernel;
            document.getElementById('jobPreprocDenoise').value = DEFAULT_JOB_CONFIG.preprocDenoise;
            document.getElementById('jobPreprocMorph').value = DEFAULT_JOB_CONFIG.preprocMorph;
            document.getElementById('jobPreprocClahe').value = DEFAULT_JOB_CONFIG.preprocClahe;
            document.getElementById('jobPreprocClaheGrid').value = DEFAULT_JOB_CONFIG.preprocClaheGrid;
            document.getElementById('jobPreprocLocalSigma').value = DEFAULT_JOB_CONFIG.preprocLocalSigma;
            document.getElementById('jobPreprocLocalAmount').value = DEFAULT_JOB_CONFIG.preprocLocalAmount;

            // Advanced
            document.getElementById('jobContinueMode').checked = DEFAULT_JOB_CONFIG.continueMode;
            document.getElementById('jobAutoAdvance').checked = DEFAULT_JOB_CONFIG.autoAdvance;
            document.getElementById('jobProOnly').checked = DEFAULT_JOB_CONFIG.proOnly;
            document.getElementById('jobCleanTmp').checked = DEFAULT_JOB_CONFIG.cleanTmp;
            document.getElementById('jobDebugArtifacts').checked = DEFAULT_JOB_CONFIG.debugArtifacts;
            document.getElementById('jobCaptureVideo').checked = DEFAULT_JOB_CONFIG.captureVideo;

            showToast('info', 'Zresetowano', 'Przywrócono domyślne ustawienia konfiguracji.');
        }

        async function startJob() {
            const sourcePath = document.getElementById('jobSourcePath').value;
            if (!sourcePath) {
                showToast('error', 'Błąd', 'Podaj ścieżkę źródłową');
                return;
            }

            const selectedProfiles = [...document.querySelectorAll('.job-profile-cb:checked')].map(cb => cb.value);
            if (selectedProfiles.length === 0) {
                showToast('error', 'Błąd', 'Wybierz przynajmniej jeden profil');
                return;
            }

            localStorage.setItem('lastSourcePath', sourcePath);

            // Split profiles by execution mode
            const profilesByMode = {
                profiles: [],
                remote_browser_profiles: [],
                remote_ssh_profiles: [],
            };

            selectedProfiles.forEach(profileName => {
                const mode = getExecutionMode(profileName);
                switch (mode) {
                    case 'local':
                        profilesByMode.profiles.push(profileName);
                        break;
                    case 'wsl_browser':
                        profilesByMode.remote_browser_profiles.push(profileName);
                        break;
                    case 'wsl_worker':
                        profilesByMode.remote_ssh_profiles.push(profileName);
                        break;
                }
            });

            const jobParams = {
                source_dir: sourcePath,
                batch_id: document.getElementById('jobBatchId').value || null,
                headed: document.getElementById('jobHeadedMode').checked,
                engine: document.getElementById('jobEngine').value,
                
                // Performance
                num_windows: parseInt(document.getElementById('jobWindows').value) || 2,
                tabs_per_window: parseInt(document.getElementById('jobTabsPerWindow').value) || 2,
                scans_per_worker: parseInt(document.getElementById('jobScansPerWorker').value) || 2,
                collect_timeout: parseInt(document.getElementById('jobCollectTimeout').value) || 400,
                close_idle_tabs: document.getElementById('jobCloseIdleTabs').checked,
                max_tabs_per_context: parseInt(document.getElementById('jobMaxTabsPerContext').value) || 0,
                isolated_contexts: document.getElementById('jobIsolatedContexts').checked,
                context_pool_size: parseInt(document.getElementById('jobContextPoolSize').value) || 0,
                viewport_width: parseInt(document.getElementById('jobViewportWidth').value) || 1200,
                viewport_height: parseInt(document.getElementById('jobViewportHeight').value) || 800,
                reduced_motion: document.getElementById('jobReducedMotion').checked,

                // Database
                pg_enabled: document.getElementById('jobPgEnabled').checked,
                pg_dsn: document.getElementById('jobPgDsn').value,
                pg_table: document.getElementById('jobPgTable').value,

                // Preprocess
                preproc_max_dimension: parseInt(document.getElementById('jobPreprocMaxDim').value) || 2500,
                preproc_median_kernel: parseInt(document.getElementById('jobPreprocMedianKernel').value) || 3,
                preproc_denoise: parseInt(document.getElementById('jobPreprocDenoise').value) || 8,
                preproc_morph_kernel: parseInt(document.getElementById('jobPreprocMorph').value) || 2,
                preproc_clahe_clip: parseFloat(document.getElementById('jobPreprocClahe').value) || 2.0,
                preproc_clahe_grid: document.getElementById('jobPreprocClaheGrid').value || "8,8",
                preproc_local_sigma: parseFloat(document.getElementById('jobPreprocLocalSigma').value) || 12.0,
                preproc_local_amount: parseFloat(document.getElementById('jobPreprocLocalAmount').value) || 0.35,

                // Advanced
                continue_mode: document.getElementById('jobContinueMode').checked,
                auto_advance: document.getElementById('jobAutoAdvance').checked,
                pro_only: document.getElementById('jobProOnly').checked,
                clean_tmp: document.getElementById('jobCleanTmp').checked,
                debug_artifacts: document.getElementById('jobDebugArtifacts').checked,
                capture_video: document.getElementById('jobCaptureVideo').checked,

                // Profiles
                profiles: profilesByMode.profiles,
                remote_browser_profiles: profilesByMode.remote_browser_profiles,
                remote_ssh_profiles: profilesByMode.remote_ssh_profiles
            };


            showToast('info', 'Uruchamianie...', 'Uruchamianie joba OCR');
            closeStartJobModal();

            try {
                const response = await fetch('/api/jobs/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(jobParams)
                });

                if (response.ok) {
                    showToast('success', 'Uruchomiono', 'Job OCR został uruchomiony');
                    refreshData();
                } else {
                    const data = await response.json();
                    showToast('error', 'Błąd', data.detail || 'Nie udało się uruchomić joba');
                }
            } catch (e) {
                showToast('error', 'Błąd', e.message);
            }
        }

        // ============================================
        // Job Config Tab Functions
        // ============================================

        function switchConfigTab(tabName) {
            // Update URL hash to include subtab
            // Format: #jobconfig/subtab
            const hashParts = window.location.hash.slice(1).split('/');
            const mainTab = hashParts[0] || 'jobconfig';
            if (mainTab === 'jobconfig') {
                const newHash = `${mainTab}/${tabName}`;
                if (window.location.hash.slice(1) !== newHash) {
                    window.location.hash = newHash;
                    // Hash change will finalize if needed, but we update UI strictly here for speed
                }
            }

            // Remove active class from all tabs and panels
            document.querySelectorAll('.config-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.config-panel').forEach(panel => panel.classList.remove('active'));

            // Add active class to selected tab and panel
            const selectedTab = document.querySelector(`.config-tab[data-config-tab="${tabName}"]`);
            const selectedPanel = document.getElementById(`config-${tabName}`);

            if (selectedTab) selectedTab.classList.add('active');
            if (selectedPanel) selectedPanel.classList.add('active');

            updateBreadcrumb('jobconfig', tabName);
        }

        async function startJobFromConfig() {
            const sourcePath = document.getElementById('jobSourcePath').value;
            if (!sourcePath) {
                showToast('error', 'Błąd', 'Podaj ścieżkę źródłową');
                return;
            }

            const selectedProfiles = [...document.querySelectorAll('.job-profile-cb:checked')].map(cb => cb.value);
            if (selectedProfiles.length === 0) {
                showToast('error', 'Błąd', 'Wybierz przynajmniej jeden profil');
                return;
            }

            localStorage.setItem('lastSourcePath', sourcePath);

            // Split profiles by execution mode
            const profilesByMode = {
                profiles: [],
                remote_browser_profiles: [],
                remote_ssh_profiles: [],
            };

            selectedProfiles.forEach(profileName => {
                const mode = getExecutionMode(profileName);
                switch (mode) {
                    case 'local':
                        profilesByMode.profiles.push(profileName);
                        break;
                    case 'wsl_browser':
                        profilesByMode.remote_browser_profiles.push(profileName);
                        break;
                    case 'wsl_worker':
                        profilesByMode.remote_ssh_profiles.push(profileName);
                        break;
                }
            });

            // Collect all job parameters from the form
            const jobParams = {
                source_dir: sourcePath,
                batch_id: document.getElementById('jobBatchId').value || null,
                ...profilesByMode,

                // Basic
                headed: document.getElementById('jobHeadedMode').checked,
                engine: document.getElementById('jobEngine').value,

                // Performance
                windows: parseInt(document.getElementById('jobWindows').value) || 2,
                tabs_per_window: parseInt(document.getElementById('jobTabsPerWindow').value) || 2,
                scans_per_worker: parseInt(document.getElementById('jobScansPerWorker').value) || 2,
                collect_timeout_sec: parseInt(document.getElementById('jobCollectTimeout').value) || 400,
                close_idle_tabs: document.getElementById('jobCloseIdleTabs').checked,
                max_tabs_per_context: parseInt(document.getElementById('jobMaxTabsPerContext').value) || 0,
                isolated_contexts: document.getElementById('jobIsolatedContexts').checked,
                context_pool_size: parseInt(document.getElementById('jobContextPoolSize').value) || 0,
                viewport_width: parseInt(document.getElementById('jobViewportWidth').value) || 1200,
                viewport_height: parseInt(document.getElementById('jobViewportHeight').value) || 800,
                reduced_motion: document.getElementById('jobReducedMotion').checked,

                // Database
                pg_enabled: document.getElementById('jobPgEnabled').checked,
                pg_dsn: document.getElementById('jobPgDsn').value || null,
                pg_table: document.getElementById('jobPgTable').value || 'public.ocr_raw_texts',

                // Preprocess
                preproc_max_dimension: parseInt(document.getElementById('jobPreprocMaxDim').value) || 2500,
                preproc_median_kernel: parseInt(document.getElementById('jobPreprocMedianKernel').value) || 3,
                preproc_denoise: parseInt(document.getElementById('jobPreprocDenoise').value) || 8,
                preproc_morph: parseInt(document.getElementById('jobPreprocMorph').value) || 2,
                preproc_clahe: parseFloat(document.getElementById('jobPreprocClahe').value) || 2.0,
                preproc_clahe_grid: document.getElementById('jobPreprocClaheGrid').value || '8,8',
                preproc_local_sigma: parseFloat(document.getElementById('jobPreprocLocalSigma').value) || 12.0,
                preproc_local_amount: parseFloat(document.getElementById('jobPreprocLocalAmount').value) || 0.35,
                preproc_blackhat_kernel: parseInt(document.getElementById('jobPreprocBlackhatKernel').value) || 5,
                preproc_blackhat_strength: parseFloat(document.getElementById('jobPreprocBlackhatStrength').value) || 0.45,
                preproc_unsharp_amount: parseFloat(document.getElementById('jobPreprocUnsharpAmount').value) || 1.2,
                preproc_unsharp_radius: parseInt(document.getElementById('jobPreprocUnsharpRadius').value) || 1,
                preproc_margin_percent: parseFloat(document.getElementById('jobPreprocMarginPercent').value) || 0.05,
                preproc_dark_threshold: parseInt(document.getElementById('jobPreprocDarkThreshold').value) || 60,
                preproc_margin_ink_ratio: parseFloat(document.getElementById('jobPreprocMarginInkRatio').value) || 0.01,
                preproc_margin_shadow: parseInt(document.getElementById('jobPreprocMarginShadow').value) || 200,
                preproc_bg_kernel_ratio: parseFloat(document.getElementById('jobPreprocBgKernelRatio').value) || 0.025,
                preproc_bg_kernel_min: parseInt(document.getElementById('jobPreprocBgKernelMin').value) || 31,
                preproc_binarization: document.getElementById('jobPreprocBinarization').checked,
                preproc_sauvola_w: parseInt(document.getElementById('jobPreprocSauvolaW').value) || 31,
                preproc_sauvola_k: parseFloat(document.getElementById('jobPreprocSauvolaK').value) || 0.2,
                preproc_sauvola_r: parseFloat(document.getElementById('jobPreprocSauvolaR').value) || 128.0,
                preproc_text_mask_block: parseInt(document.getElementById('jobPreprocTextMaskBlock').value) || 31,
                preproc_text_mask_c: parseInt(document.getElementById('jobPreprocTextMaskC').value) || 12,
                preproc_text_mask_open_k: parseInt(document.getElementById('jobPreprocTextMaskOpenK').value) || 3,
                preproc_text_mask_close_k: parseInt(document.getElementById('jobPreprocTextMaskCloseK').value) || 9,
                preproc_text_mask_close_i: parseInt(document.getElementById('jobPreprocTextMaskCloseI').value) || 2,
                preproc_text_mask_dilate_i: parseInt(document.getElementById('jobPreprocTextMaskDilateI').value) || 1,
                preproc_text_mask_min_area: parseFloat(document.getElementById('jobPreprocTextMaskMinArea').value) || 0.0005,
                preproc_trim_band: parseFloat(document.getElementById('jobPreprocTrimBand').value) || 0.02,
                preproc_trim_ink: parseFloat(document.getElementById('jobPreprocTrimInk').value) || 0.02,
                preproc_trim_max: parseFloat(document.getElementById('jobPreprocTrimMax').value) || 0.15,
                preproc_trim_min_dim: parseInt(document.getElementById('jobPreprocTrimMinDim').value) || 200,

                // Advanced
                continue_mode: document.getElementById('jobContinueMode').checked,
                auto_advance: document.getElementById('jobAutoAdvance').checked,
                pro_only: document.getElementById('jobProOnly').checked,
                clean_temp: document.getElementById('jobCleanTmp').checked,
                debug_artifacts: document.getElementById('jobDebugArtifacts').checked,
                capture_video: document.getElementById('jobCaptureVideo').checked,
                tracing_mode: document.getElementById('jobTracingMode').value,
                auth_ensure: document.getElementById('jobAuthEnsure').checked,
                auth_ensure_interval: parseInt(document.getElementById('jobAuthEnsureInterval').value) || 900,
                model_switch_retries: parseInt(document.getElementById('jobModelSwitchRetries').value) || 3,
                model_switch_cooldown: parseInt(document.getElementById('jobModelSwitchCooldown').value) || 1200,
                limit_check_interval: parseInt(document.getElementById('jobLimitCheckInterval').value) || 1800,
                pro_pause_buffer: parseInt(document.getElementById('jobProPauseBuffer').value) || 180,
                pro_fallback_pause: parseInt(document.getElementById('jobProFallbackPause').value) || 60,
                browser_id: document.getElementById('jobBrowserId').value || null,
            };

            showToast('info', 'Uruchamianie...', 'Uruchamianie joba OCR');

            try {
                const response = await fetch('/api/jobs/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(jobParams)
                });

                if (response.ok) {
                    showToast('success', 'Uruchomiono', 'Job OCR został uruchomiony');
                    refreshData();
                } else {
                    const data = await response.json();
                    showToast('error', 'Błąd', data.detail || 'Nie udało się uruchomić joba');
                }
            } catch (e) {
                showToast('error', 'Błąd', e.message);
            }
        }

        function saveJobConfig() {
            const config = {
                sourcePath: document.getElementById('jobSourcePath').value,
                batchId: document.getElementById('jobBatchId').value,
                headedMode: document.getElementById('jobHeadedMode').checked,
                engine: document.getElementById('jobEngine').value,
                windows: document.getElementById('jobWindows').value,
                tabsPerWindow: document.getElementById('jobTabsPerWindow').value,
                scansPerWorker: document.getElementById('jobScansPerWorker').value,
                collectTimeout: document.getElementById('jobCollectTimeout').value,
                closeIdleTabs: document.getElementById('jobCloseIdleTabs').checked,
                maxTabsPerContext: document.getElementById('jobMaxTabsPerContext').value,
                isolatedContexts: document.getElementById('jobIsolatedContexts').checked,
                contextPoolSize: document.getElementById('jobContextPoolSize').value,
                viewportWidth: document.getElementById('jobViewportWidth').value,
                viewportHeight: document.getElementById('jobViewportHeight').value,
                reducedMotion: document.getElementById('jobReducedMotion').checked,
                pgEnabled: document.getElementById('jobPgEnabled').checked,
                pgDsn: document.getElementById('jobPgDsn').value,
                pgTable: document.getElementById('jobPgTable').value,
                preprocMaxDim: document.getElementById('jobPreprocMaxDim').value,
                preprocMedianKernel: document.getElementById('jobPreprocMedianKernel').value,
                preprocDenoise: document.getElementById('jobPreprocDenoise').value,
                preprocMorph: document.getElementById('jobPreprocMorph').value,
                preprocClahe: document.getElementById('jobPreprocClahe').value,
                preprocClaheGrid: document.getElementById('jobPreprocClaheGrid').value,
                preprocLocalSigma: document.getElementById('jobPreprocLocalSigma').value,
                preprocLocalAmount: document.getElementById('jobPreprocLocalAmount').value,
                preprocBlackhatKernel: document.getElementById('jobPreprocBlackhatKernel').value,
                preprocBlackhatStrength: document.getElementById('jobPreprocBlackhatStrength').value,
                preprocUnsharpAmount: document.getElementById('jobPreprocUnsharpAmount').value,
                preprocUnsharpRadius: document.getElementById('jobPreprocUnsharpRadius').value,
                preprocMarginPercent: document.getElementById('jobPreprocMarginPercent').value,
                preprocDarkThreshold: document.getElementById('jobPreprocDarkThreshold').value,
                preprocMarginInkRatio: document.getElementById('jobPreprocMarginInkRatio').value,
                preprocMarginShadow: document.getElementById('jobPreprocMarginShadow').value,
                preprocBgKernelRatio: document.getElementById('jobPreprocBgKernelRatio').value,
                preprocBgKernelMin: document.getElementById('jobPreprocBgKernelMin').value,
                preprocBinarization: document.getElementById('jobPreprocBinarization').checked,
                preprocSauvolaW: document.getElementById('jobPreprocSauvolaW').value,
                preprocSauvolaK: document.getElementById('jobPreprocSauvolaK').value,
                preprocSauvolaR: document.getElementById('jobPreprocSauvolaR').value,
                preprocTextMaskBlock: document.getElementById('jobPreprocTextMaskBlock').value,
                preprocTextMaskC: document.getElementById('jobPreprocTextMaskC').value,
                preprocTextMaskOpenK: document.getElementById('jobPreprocTextMaskOpenK').value,
                preprocTextMaskCloseK: document.getElementById('jobPreprocTextMaskCloseK').value,
                preprocTextMaskCloseI: document.getElementById('jobPreprocTextMaskCloseI').value,
                preprocTextMaskDilateI: document.getElementById('jobPreprocTextMaskDilateI').value,
                preprocTextMaskMinArea: document.getElementById('jobPreprocTextMaskMinArea').value,
                preprocTrimBand: document.getElementById('jobPreprocTrimBand').value,
                preprocTrimInk: document.getElementById('jobPreprocTrimInk').value,
                preprocTrimMax: document.getElementById('jobPreprocTrimMax').value,
                preprocTrimMinDim: document.getElementById('jobPreprocTrimMinDim').value,
                continueMode: document.getElementById('jobContinueMode').checked,
                autoAdvance: document.getElementById('jobAutoAdvance').checked,
                proOnly: document.getElementById('jobProOnly').checked,
                cleanTemp: document.getElementById('jobCleanTemp').checked,
                debugArtifacts: document.getElementById('jobDebugArtifacts').checked,
                captureVideo: document.getElementById('jobCaptureVideo').checked,
                tracingMode: document.getElementById('jobTracingMode').value,
                authEnsure: document.getElementById('jobAuthEnsure').checked,
                authEnsureInterval: document.getElementById('jobAuthEnsureInterval').value,
                modelSwitchRetries: document.getElementById('jobModelSwitchRetries').value,
                modelSwitchCooldown: document.getElementById('jobModelSwitchCooldown').value,
                limitCheckInterval: document.getElementById('jobLimitCheckInterval').value,
                proPauseBuffer: document.getElementById('jobProPauseBuffer').value,
                proFallbackPause: document.getElementById('jobProFallbackPause').value,
                browserId: document.getElementById('jobBrowserId').value,
            };

            localStorage.setItem('jobConfig', JSON.stringify(config));
            if (config.batchId) {
              safeUpdate("headerBatchId", config.batchId);
            }
            showToast('success', 'Zapisano', 'Konfiguracja została zapisana');
        }


        // ============================================
        // Navigation and Core UI Functions
        // ============================================

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // Show selected tab
            const selectedTab = document.getElementById(`tab-${tabName}`);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }

            // Highlight selected nav item
            const selectedNav = document.querySelector(`.nav-item[onclick*="${tabName}"]`);
            if (selectedNav) {
                selectedNav.classList.add('active');
            }

            // Update URL hash
            window.location.hash = tabName;

            // If jobconfig tab, restore subtab from hash
            if (tabName === 'jobconfig') {
                const hashParts = window.location.hash.slice(1).split('/');
                const subtab = hashParts[1] || 'basic';
                setTimeout(() => switchConfigTab(subtab), 50);
            }
        }

        async function stopAllJobs() {
            if (!confirm(t('jobs.confirmStopAll') || 'Czy na pewno chcesz zatrzymać wszystkie joby?')) {
                return;
            }

            try {
                const response = await fetch('/api/jobs/stop-all', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    showToast('success', t('jobs.stopped') || 'Zatrzymano', t('jobs.allStopped') || 'Wszystkie joby zostały zatrzymane');
                    refreshData();
                } else {
                    const data = await response.json();
                    showToast('error', t('common.error') || 'Błąd', data.detail || t('jobs.stopFailed') || 'Nie udało się zatrzymać jobów');
                }
            } catch (e) {
                showToast('error', t('common.error') || 'Błąd', e.message);
            }
        }

        function cleanupFolders() {
            const modal = document.getElementById('cleanupModal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }



        function loadJobConfig() {
            const savedConfig = localStorage.getItem('jobConfig');
            if (!savedConfig) {
                showToast('info', 'Brak konfiguracji', 'Nie znaleziono zapisanej konfiguracji');
                return;
            }

            try {
                const config = JSON.parse(savedConfig);

                // Basic
                if (config.sourcePath) document.getElementById('jobSourcePath').value = config.sourcePath;
                if (config.batchId) {
                    document.getElementById('jobBatchId').value = config.batchId;
                    safeUpdate("headerBatchId", config.batchId);
                }
                if (config.headedMode !== undefined) document.getElementById('jobHeadedMode').checked = config.headedMode;
                if (config.engine) document.getElementById('jobEngine').value = config.engine;

                // Performance
                if (config.windows) document.getElementById('jobWindows').value = config.windows;
                if (config.tabsPerWindow) document.getElementById('jobTabsPerWindow').value = config.tabsPerWindow;
                if (config.scansPerWorker) document.getElementById('jobScansPerWorker').value = config.scansPerWorker;
                updateTotalWorkers();
                if (config.collectTimeout) document.getElementById('jobCollectTimeout').value = config.collectTimeout;
                if (config.closeIdleTabs !== undefined) document.getElementById('jobCloseIdleTabs').checked = config.closeIdleTabs;
                if (config.maxTabsPerContext) document.getElementById('jobMaxTabsPerContext').value = config.maxTabsPerContext;
                if (config.isolatedContexts !== undefined) document.getElementById('jobIsolatedContexts').checked = config.isolatedContexts;
                if (config.contextPoolSize) document.getElementById('jobContextPoolSize').value = config.contextPoolSize;
                if (config.viewportWidth) document.getElementById('jobViewportWidth').value = config.viewportWidth;
                if (config.viewportHeight) document.getElementById('jobViewportHeight').value = config.viewportHeight;
                if (config.reducedMotion !== undefined) document.getElementById('jobReducedMotion').checked = config.reducedMotion;

                // Database
                if (config.pgEnabled !== undefined) document.getElementById('jobPgEnabled').checked = config.pgEnabled;
                if (config.pgDsn) document.getElementById('jobPgDsn').value = config.pgDsn;
                if (config.pgTable) document.getElementById('jobPgTable').value = config.pgTable;

                // Preprocess
                if (config.preprocMaxDim) document.getElementById('jobPreprocMaxDim').value = config.preprocMaxDim;
                if (config.preprocMedianKernel) document.getElementById('jobPreprocMedianKernel').value = config.preprocMedianKernel;
                if (config.preprocDenoise) document.getElementById('jobPreprocDenoise').value = config.preprocDenoise;
                if (config.preprocMorph) document.getElementById('jobPreprocMorph').value = config.preprocMorph;
                if (config.preprocClahe) document.getElementById('jobPreprocClahe').value = config.preprocClahe;
                if (config.preprocClaheGrid) document.getElementById('jobPreprocClaheGrid').value = config.preprocClaheGrid;
                if (config.preprocLocalSigma) document.getElementById('jobPreprocLocalSigma').value = config.preprocLocalSigma;
                if (config.preprocLocalAmount) document.getElementById('jobPreprocLocalAmount').value = config.preprocLocalAmount;
                if (config.preprocBlackhatKernel) document.getElementById('jobPreprocBlackhatKernel').value = config.preprocBlackhatKernel;
                if (config.preprocBlackhatStrength) document.getElementById('jobPreprocBlackhatStrength').value = config.preprocBlackhatStrength;
                if (config.preprocUnsharpAmount) document.getElementById('jobPreprocUnsharpAmount').value = config.preprocUnsharpAmount;
                if (config.preprocUnsharpRadius) document.getElementById('jobPreprocUnsharpRadius').value = config.preprocUnsharpRadius;
                if (config.preprocMarginPercent) document.getElementById('jobPreprocMarginPercent').value = config.preprocMarginPercent;
                if (config.preprocDarkThreshold) document.getElementById('jobPreprocDarkThreshold').value = config.preprocDarkThreshold;
                if (config.preprocMarginInkRatio) document.getElementById('jobPreprocMarginInkRatio').value = config.preprocMarginInkRatio;
                if (config.preprocMarginShadow) document.getElementById('jobPreprocMarginShadow').value = config.preprocMarginShadow;
                if (config.preprocBgKernelRatio) document.getElementById('jobPreprocBgKernelRatio').value = config.preprocBgKernelRatio;
                if (config.preprocBgKernelMin) document.getElementById('jobPreprocBgKernelMin').value = config.preprocBgKernelMin;
                if (config.preprocBinarization !== undefined) document.getElementById('jobPreprocBinarization').checked = config.preprocBinarization;
                if (config.preprocSauvolaW) document.getElementById('jobPreprocSauvolaW').value = config.preprocSauvolaW;
                if (config.preprocSauvolaK) document.getElementById('jobPreprocSauvolaK').value = config.preprocSauvolaK;
                if (config.preprocSauvolaR) document.getElementById('jobPreprocSauvolaR').value = config.preprocSauvolaR;
                if (config.preprocTextMaskBlock) document.getElementById('jobPreprocTextMaskBlock').value = config.preprocTextMaskBlock;
                if (config.preprocTextMaskC) document.getElementById('jobPreprocTextMaskC').value = config.preprocTextMaskC;
                if (config.preprocTextMaskOpenK) document.getElementById('jobPreprocTextMaskOpenK').value = config.preprocTextMaskOpenK;
                if (config.preprocTextMaskCloseK) document.getElementById('jobPreprocTextMaskCloseK').value = config.preprocTextMaskCloseK;
                if (config.preprocTextMaskCloseI) document.getElementById('jobPreprocTextMaskCloseI').value = config.preprocTextMaskCloseI;
                if (config.preprocTextMaskDilateI) document.getElementById('jobPreprocTextMaskDilateI').value = config.preprocTextMaskDilateI;
                if (config.preprocTextMaskMinArea) document.getElementById('jobPreprocTextMaskMinArea').value = config.preprocTextMaskMinArea;
                if (config.preprocTrimBand) document.getElementById('jobPreprocTrimBand').value = config.preprocTrimBand;
                if (config.preprocTrimInk) document.getElementById('jobPreprocTrimInk').value = config.preprocTrimInk;
                if (config.preprocTrimMax) document.getElementById('jobPreprocTrimMax').value = config.preprocTrimMax;
                if (config.preprocTrimMinDim) document.getElementById('jobPreprocTrimMinDim').value = config.preprocTrimMinDim;

                // Advanced
                if (config.continueMode !== undefined) document.getElementById('jobContinueMode').checked = config.continueMode;
                if (config.autoAdvance !== undefined) document.getElementById('jobAutoAdvance').checked = config.autoAdvance;
                if (config.proOnly !== undefined) document.getElementById('jobProOnly').checked = config.proOnly;
                if (config.cleanTemp !== undefined) document.getElementById('jobCleanTemp').checked = config.cleanTemp;
                if (config.debugArtifacts !== undefined) document.getElementById('jobDebugArtifacts').checked = config.debugArtifacts;
                if (config.captureVideo !== undefined) document.getElementById('jobCaptureVideo').checked = config.captureVideo;
                if (config.tracingMode) document.getElementById('jobTracingMode').value = config.tracingMode;
                if (config.authEnsure !== undefined) document.getElementById('jobAuthEnsure').checked = config.authEnsure;
                if (config.authEnsureInterval) document.getElementById('jobAuthEnsureInterval').value = config.authEnsureInterval;
                if (config.modelSwitchRetries) document.getElementById('jobModelSwitchRetries').value = config.modelSwitchRetries;
                if (config.modelSwitchCooldown) document.getElementById('jobModelSwitchCooldown').value = config.modelSwitchCooldown;
                if (config.limitCheckInterval) document.getElementById('jobLimitCheckInterval').value = config.limitCheckInterval;
                if (config.proPauseBuffer) document.getElementById('jobProPauseBuffer').value = config.proPauseBuffer;
                if (config.proFallbackPause) document.getElementById('jobProFallbackPause').value = config.proFallbackPause;
                if (config.browserId) document.getElementById('jobBrowserId').value = config.browserId;

                showToast('success', 'Wczytano', 'Konfiguracja została wczytana');
            } catch (e) {
                showToast('error', 'Błąd', 'Nie udało się wczytać konfiguracji');
            }
        }


      // Update total workers display
      function updateTotalWorkers() {
        const windows = parseInt(document.getElementById('jobWindows').value) || 2;
        const tabs = parseInt(document.getElementById('jobTabsPerWindow').value) || 2;
        const total = windows * tabs;
        const el = document.getElementById('jobTotalWorkers');
        if (el) el.textContent = total;
      }

      // Add event listeners for windows/tabs inputs
      document.addEventListener('DOMContentLoaded', function() {
        const windowsInput = document.getElementById('jobWindows');
        const tabsInput = document.getElementById('jobTabsPerWindow');
        if (windowsInput) windowsInput.addEventListener('input', updateTotalWorkers);
        if (tabsInput) tabsInput.addEventListener('input', updateTotalWorkers);
        updateTotalWorkers();
      });

      async function loadDefaultSourcePath() {
        // Priority: LocalStorage > API
        const savedPath = localStorage.getItem('lastSourcePath');
        if (savedPath) {
            const input = document.getElementById("jobSourcePath");
            if (input) {
                input.value = savedPath;
                if (savedPath.trim() !== '') {
                    // Still fetch to populate the source root badge
                    try {
                        const resp = await fetch("/api/default-source-path");
                        const d = await resp.json();
                        if (d.source_root) {
                            const badge = document.getElementById("sourceRootBadge");
                            if (badge) {
                                badge.textContent = d.source_root.replace(/\/$/, '') + '/';
                                badge.title = d.source_root;
                            }
                        }
                    } catch (_) {}
                    _updateSourceBadgeVisibility(savedPath);
                    return;
                }
            }
        }
        try {
          const response = await fetch("/api/default-source-path");
          const data = await response.json();

          // Update source root badge
          if (data.source_root) {
              const badge = document.getElementById("sourceRootBadge");
              if (badge) {
                  badge.textContent = data.source_root.replace(/\/$/, '') + '/';
                  badge.title = data.source_root;
              }
          }

          if (data.path) {
            const input = document.getElementById("jobSourcePath");
            if (input && !input.value) {
              // Strip source_root prefix if present, show relative part only
              let displayPath = data.path;
              if (data.source_root && displayPath.startsWith(data.source_root)) {
                  displayPath = displayPath.slice(data.source_root.length).replace(/^\//, '');
              }
              input.value = displayPath;
              _updateSourceBadgeVisibility(displayPath);
            }
          }
        } catch (e) {
          console.error("Failed to load default source path:", e);
        }
      }

      // --- Source path badge visibility ---

      function _isAbsolutePath(p) {
        if (!p) return false;
        // Unix absolute, home dir, Windows drive, UNC, SSH notation
        return /^(\/|~|[A-Za-z]:[\\/]|\\\\[^\\]|[a-zA-Z0-9._-]+@[^:]+:)/.test(p);
      }

      function _updateSourceBadgeVisibility(value) {
        const badge = document.getElementById("sourceRootBadge");
        const input = document.getElementById("jobSourcePath");
        if (!badge || !input) return;
        if (_isAbsolutePath(value)) {
          badge.style.display = "none";
          input.style.borderRadius = "var(--radius-md) 0 0 var(--radius-md)";
          input.style.borderLeft = "";
        } else {
          badge.style.display = "flex";
          input.style.borderRadius = "0";
          input.style.borderLeft = "none";
        }
      }

      // Wire up real-time badge toggle
      document.addEventListener("DOMContentLoaded", () => {
        const srcInput = document.getElementById("jobSourcePath");
        if (srcInput) {
          srcInput.addEventListener("input", (e) => _updateSourceBadgeVisibility(e.target.value));
          // Initial state
          _updateSourceBadgeVisibility(srcInput.value);
        }
      });

      async function verifySourcePath() {
        const input = document.getElementById("jobSourcePath");
        const statusEl = document.getElementById("sourcePathStatus");
        const btn = document.getElementById("sourceVerifyBtn");
        if (!input || !statusEl) return;

        const path = input.value.trim();
        if (!path) {
            statusEl.innerHTML = '<span style="color: var(--color-warning);">⚠️ Wprowadź ścieżkę</span>';
            return;
        }

        // Show spinner
        btn && (btn.disabled = true);
        statusEl.innerHTML = '<span style="color: var(--color-text-secondary);">⏳ Weryfikuję...</span>';

        try {
            const resp = await fetch(`/api/source-info?path=${encodeURIComponent(path)}`);
            const data = await resp.json();

            if (data.status === "ok") {
                const count = data.image_count || 0;
                // deepcode ignore DOMXSS: count is number/safe
                statusEl.innerHTML = `<span style="color: var(--color-success);">✅ OK — ${count} plików obrazów</span>` +
                    (count === 0 ? ' <span style="color: var(--color-warning);">(Ostrzeżenie: brak obrazów?)</span>' : '');
            } else {
                // lgtm[js/xss]
                // deepcode ignore DOMXSS: error message is escaped
                statusEl.innerHTML = `<span style="color: var(--color-error);">❌ ${escapeHtml(data.error || 'Nieznany błąd')}</span>`;
            }
        } catch (e) {
            statusEl.innerHTML = `<span style="color: var(--color-error);">❌ Błąd połączenia</span>`;
        } finally {
            btn && (btn.disabled = false);
        }
      }

      // ============================================
      // Limits Checker
      // ============================================

      let limitSelectionInitialized = false;

      function updateLimitHostOptions() {
        const select = document.getElementById("limitHost");
        if (!select) return;
        const current = select.value || "local";
        select.innerHTML = "";

        const localOpt = document.createElement("option");
        localOpt.value = "local";
        localOpt.textContent = "Lokalny";
        select.appendChild(localOpt);

        if (Array.isArray(remoteHostsData) && remoteHostsData.length > 0) {
          remoteHostsData.forEach((host) => {
            if (!host?.roles?.browser) return;
            const opt = document.createElement("option");
            opt.value = host.id;
            const hostName = host.name || host.host || "Host";
            opt.textContent = `${hostName} (Browser)`;
            select.appendChild(opt);
          });
        }

        const exists = Array.from(select.options).some(
          (option) => option.value === current,
        );
        select.value = exists ? current : "local";
      }

      function ensureLimitSelection() {
        if (limitSelectionInitialized) return;
        const checkboxes = [
          ...document.querySelectorAll(".limit-profile-cb"),
        ];
        if (checkboxes.length === 0) return;
        const anyChecked = checkboxes.some((cb) => cb.checked);
        if (anyChecked) {
          limitSelectionInitialized = true;
          return;
        }
        const hasActive =
          Array.isArray(profilesData) &&
          profilesData.some((p) => p.status === "active");
        if (hasActive) {
          selectActiveLimitProfiles();
        } else {
          selectAllLimitProfiles();
        }
        limitSelectionInitialized = true;
      }

      function selectAllLimitProfiles() {
        document
          .querySelectorAll(".limit-profile-cb")
          .forEach((cb) => (cb.checked = true));
      }

      function selectActiveLimitProfiles() {
        document.querySelectorAll(".limit-profile-cb").forEach((cb) => {
          const profile = profilesData.find((p) => p.name === cb.value);
          cb.checked = profile && profile.status === "active";
        });
      }

      function selectPausedLimitProfiles() {
        document.querySelectorAll(".limit-profile-cb").forEach((cb) => {
          const profile = profilesData.find((p) => p.name === cb.value);
          cb.checked = profile && profile.status === "paused";
        });
      }

      function clearLimitProfiles() {
        document
          .querySelectorAll(".limit-profile-cb")
          .forEach((cb) => (cb.checked = false));
      }

      function setLimitButtonsDisabled(disabled) {
        const runBtn = document.getElementById("limitRunBtn");
        const fullBtn = document.getElementById("limitRunBtnFull");
        if (runBtn) runBtn.disabled = disabled;
        if (fullBtn) fullBtn.disabled = disabled;
      }

      function setLimitStopEnabled(enabled) {
        const stopBtn = document.getElementById("limitStopBtn");
        if (stopBtn) stopBtn.disabled = !enabled;
      }

      function clearLimitResults() {
        window.lastLimitResults = [];
        const tbody = document.getElementById("limitResultsBody");
        if (tbody) {
          tbody.innerHTML =
            '<tr><td colspan="7" class="text-center text-secondary" style="padding: var(--spacing-lg);">Brak wyników</td></tr>';
        }
        safeUpdate("limitResultsTime", "-");
        safeUpdate("limitLastCheck", "-");
        safeUpdate("limitSessionRuns", "0");
        safeUpdate("limitOkCount", "0");
        safeUpdate("limitExceededCount", "0");
        safeUpdate("limitLoginCount", "0");
        safeUpdate("limitErrorCount", "0");
      }

      let limitHostContext = null;

      async function runLimitCheck(mode = "quick") {
        const selectedProfiles = [
          ...document.querySelectorAll(".limit-profile-cb:checked"),
        ].map((cb) => cb.value);
        if (selectedProfiles.length === 0) {
          showToast("error", "Błąd", "Wybierz przynajmniej jeden profil");
          return;
        }

        const hostValue = document.getElementById("limitHost").value;
        limitHostContext = hostValue || null;
        const params = {
          profiles: selectedProfiles,
          quick: mode !== "full",
          parallel:
            parseInt(document.getElementById("limitParallel").value) || 4,
          host: hostValue,
        };

        setLimitButtonsDisabled(true);
        setLimitStopEnabled(hostValue === "local");
        document.getElementById("limitProgress").classList.remove("hidden");
        document.getElementById("limitProgressBar").style.width = "0%";
        document.getElementById("limitProgressText").textContent =
          "Rozpoczynanie...";

        try {
          if (params.host === "local") {
            const response = await fetch("/api/limits/precheck/start", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                profiles: params.profiles,
                quick: params.quick,
                parallel: params.parallel,
              }),
            });

            if (!response.ok) {
              const data = await response.json();
              toastHost(
                "error",
                "Błąd",
                data.detail || "Nie udało się uruchomić prechecka",
                limitHostContext,
              );
              document.getElementById("limitProgress").classList.add("hidden");
              setLimitButtonsDisabled(false);
              setLimitStopEnabled(false);
              return;
            }

            toastHost(
              "info",
              "Uruchomiono",
              "Precheck limitów rozpoczęty",
              limitHostContext,
            );
            pollLimitPrecheckStatus();
            return;
          }
          // Remote host selected -> use /api/limits/run (SSH precheck on host)
          const response = await fetch("/api/limits/run", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(params),
          });

          if (response.ok) {
            const data = await response.json();

            // Remote worker returns results immediately
            if (data.status === "completed" && data.results) {
              document.getElementById("limitProgress").classList.add("hidden");
              setLimitButtonsDisabled(false);

              // Convert remote results to display format
              const results = (data.results.results || []).map((r) => {
                const raw =
                  r.status ||
                  r.status_raw ||
                  (r.error ? "ERROR" : r.limited ? "LIMIT" : "OK");
                return {
                  profile: r.profile,
                  status_raw: raw,
                  ok: raw === "OK",
                  certainty: r.certainty || "snapshot",
                  pro_remaining: r.pro_remaining || "-",
                  reset_time: r.reset_time || "-",
                  checked_at: r.checked_at || new Date().toLocaleTimeString(),
                };
              });
              updateLimitResults(results);
              updateLimitStats(results);
              toastHost(
                "success",
                "Zakończono",
                `Sprawdzono ${results.length} profili`,
                limitHostContext,
              );
              setLimitStopEnabled(false);
            } else {
              // Local process - need to poll
              toastHost(
                "info",
                "Uruchomiono",
                "Sprawdzanie limitów rozpoczęte",
                limitHostContext,
              );
              pollLimitStatus();
            }
          } else {
            let message = "Nie udało się uruchomić";
            try {
              const raw = await response.text();
              if (raw) {
                try {
                  const data = JSON.parse(raw);
                  message = data.detail || message;
                } catch (e) {
                  message = raw;
                }
              }
            } catch (err) {}
            toastHost("error", "Błąd", message, limitHostContext);
            document.getElementById("limitProgress").classList.add("hidden");
            setLimitButtonsDisabled(false);
            setLimitStopEnabled(false);
          }
        } catch (e) {
          toastHost("error", "Błąd", e.message, limitHostContext);
          document.getElementById("limitProgress").classList.add("hidden");
          setLimitButtonsDisabled(false);
          setLimitStopEnabled(false);
        }
      }

      function runLimitCheckFull() {
        runLimitCheck("full");
      }

      async function pollLimitPrecheckStatus() {
        try {
          const response = await fetch("/api/limits/precheck/status");
          const data = await response.json();

          const rawResults = data.status?.results || [];
          const certaintyLabel = data.status?.quick_mode ? "quick" : "full";
          const results = rawResults.map((r) => ({
            profile: r.profile,
            status_raw: r.status || "",
            ok: r.status === "OK",
            certainty: certaintyLabel,
            pro_remaining: "-",
            reset_time: String(r.status || "").includes("LIMIT")
              ? String(r.status || "").replace("LIMIT until ", "")
              : "-",
            checked_at: data.status?.run_at
              ? new Date(data.status.run_at).toLocaleTimeString()
              : "-",
          }));

          if (data.running) {
            const total = data.status?.total || 0;
            const completed = data.status?.completed || 0;
            const pct = total > 0 ? Math.round((completed / total) * 100) : 20;
            document.getElementById("limitProgressBar").style.width = `${pct}%`;
            document.getElementById("limitProgressText").textContent =
              `Sprawdzanie w toku... ${completed}/${total}`;
            if (results.length > 0) {
              updateLimitResults(results);
              updateLimitStats(results);
            }
            setTimeout(pollLimitPrecheckStatus, 2000);
            return;
          }

          document.getElementById("limitProgress").classList.add("hidden");
          setLimitButtonsDisabled(false);
          setLimitStopEnabled(false);

          if (results.length > 0) {
            updateLimitResults(results);
            updateLimitStats(results);
            toastHost(
              "success",
              "Zakończono",
              `Sprawdzono ${results.length} profili`,
              limitHostContext,
            );
          } else {
            toastHost("info", "Zakończono", "Brak nowych wyników", limitHostContext);
          }
        } catch (e) {
          document.getElementById("limitProgress").classList.add("hidden");
          setLimitButtonsDisabled(false);
          setLimitStopEnabled(false);
          toastHost(
            "error",
            "Błąd",
            "Nie udało się pobrać statusu prechecka",
            limitHostContext,
          );
        }
      }

      async function pollLimitStatus() {
        try {
          const response = await fetch(
            `/api/limits/status?session_start=${limitCheckSessionStart}`,
          );
          const data = await response.json();

          if (data.running) {
            // Still running - show progress
            document.getElementById("limitProgressBar").style.width = "50%";
            document.getElementById("limitProgressText").textContent =
              "Sprawdzanie w toku...";
            setTimeout(pollLimitStatus, 2000);
          } else {
            document.getElementById("limitProgress").classList.add("hidden");
            setLimitButtonsDisabled(false);
            setLimitStopEnabled(false);

            // Get results from status.results
            const rawResults = data.status?.results || [];
            const results = rawResults.map((r) => ({
              profile: r.profile,
              status_raw: r.status || "",
              ok: r.status === "OK",
              certainty: "snapshot",
              pro_remaining: "-",
              reset_time: r.status?.includes("LIMIT")
                ? r.status.replace("LIMIT until ", "")
                : "-",
              checked_at: data.status?.run_at
                ? new Date(data.status.run_at).toLocaleTimeString()
                : "-",
            }));

            if (results.length > 0) {
              updateLimitResults(results);
              updateLimitStats(results);
              toastHost(
                "success",
                "Zakończono",
                `Sprawdzono ${results.length} profili`,
                limitHostContext,
              );
            } else {
              toastHost("info", "Zakończono", "Brak nowych wyników", limitHostContext);
            }
          }
        } catch (e) {
          document.getElementById("limitProgress").classList.add("hidden");
          setLimitButtonsDisabled(false);
          setLimitStopEnabled(false);
          toastHost("error", "Błąd", "Nie udało się pobrać statusu", limitHostContext);
        }
      }

      async function stopLimitCheck() {
        const hostValue = document.getElementById("limitHost").value;
        if (hostValue !== "local") {
          toastHost(
            "info",
            "Info",
            "Zatrzymanie dostępne tylko dla lokalnego prechecka",
            hostValue,
          );
          return;
        }
        try {
          const response = await fetch("/api/limits/precheck/stop", {
            method: "POST",
          });
          if (response.ok) {
            toastHost(
              "info",
              "Zatrzymano",
              "Sprawdzanie zostało zatrzymane",
              hostValue,
            );
          } else {
            let msg = "Nie udało się zatrzymać";
            try {
              const raw = await response.text();
              if (raw) {
                try {
                  const data = JSON.parse(raw);
                  msg = data.detail || msg;
                } catch (e) {
                  msg = raw;
                }
              }
            } catch (err) {}
            toastHost("error", "Błąd", msg, hostValue);
          }
        } catch (e) {
          toastHost("error", "Błąd", e.message, hostValue);
        } finally {
          document.getElementById("limitProgress").classList.add("hidden");
          setLimitButtonsDisabled(false);
          setLimitStopEnabled(false);
        }
      }

      // Session start timestamp for limit checks
      let limitCheckSessionStart = Date.now();
      let limitStatusFilter = "all";
      let limitSearchTerm = "";

      function setLimitStatusFilter(filter) {
        limitStatusFilter = filter;
        if (window.lastLimitResults) {
          updateLimitResults(window.lastLimitResults);
        }
      }

      function setLimitSearch(value) {
        limitSearchTerm = String(value || "").toLowerCase();
        if (window.lastLimitResults) {
          updateLimitResults(window.lastLimitResults);
        }
      }

      function updateLimitResults(results) {
        window.lastLimitResults = results;
        const tbody = document.getElementById("limitResultsBody");
        if (!results || results.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="7" class="text-center text-secondary" style="padding: var(--spacing-lg);">Brak wyników</td></tr>';
          return;
        }

        const filtered = results.filter((r) => {
          const name = String(r.profile || "").toLowerCase();
          if (limitSearchTerm && !name.includes(limitSearchTerm)) return false;
          if (limitStatusFilter === "all") return true;
          const raw = String(r.status_raw || "");
          if (limitStatusFilter === "OK") return raw === "OK";
          if (limitStatusFilter === "LIMIT") return raw.includes("LIMIT");
          if (limitStatusFilter === "LOGIN") return raw.includes("SESSION");
          if (limitStatusFilter === "ERROR") return raw.includes("ERROR");
          return true;
        });

        if (filtered.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="7" class="text-center text-secondary" style="padding: var(--spacing-lg);">Brak wyników dla wybranego filtra.</td></tr>';
          return;
        }

        tbody.innerHTML = filtered
          .map((r) => {
            const raw = String(r.status_raw || "");
            let label = "OK";
            let cls = "success";
            let title = "Brak wykrytego limitu (profil zalogowany)";
            let details = raw && raw !== "OK" ? raw : "-";
            let detailsClass = "badge-neutral";
            if (raw.includes("SESSION")) {
              label = "LOGIN";
              cls = "warning";
              title = "Profil niezalogowany — wynik niepewny";
              details = "SESSION_EXPIRED";
              detailsClass = "badge-warning";
            } else if (raw.includes("ERROR")) {
              label = "ERROR";
              cls = "error";
              title = "Błąd podczas sprawdzania";
              detailsClass = "badge-error";
            } else if (raw.includes("LIMIT")) {
              label = "LIMIT";
              cls = "error";
              title = "Limit Pro aktywny";
              detailsClass = "badge-error";
            }
            return `
                <tr>
                    <td>${escapeHtml(r.profile)}</td>
                    <td><span class="badge badge-${cls}" title="${title}">${label}</span></td>
                    <td><span class="badge badge-neutral">${escapeHtml(r.certainty || "-")}</span></td>
                    <td><span class="badge ${detailsClass}">${escapeHtml(details)}</span></td>
                    <td>${escapeHtml(r.pro_remaining || "-")}</td>
                    <td>${escapeHtml(r.reset_time || "-")}</td>
                    <td class="text-secondary">${escapeHtml(r.checked_at || "-")}</td>
                </tr>
            `;
          })
          .join("");

        document.getElementById("limitResultsTime").textContent =
          "Zaktualizowano: " + new Date().toLocaleTimeString();

        const firstPro = results.find(
          (r) => r.pro_remaining && r.pro_remaining !== "-",
        )?.pro_remaining;
        if (firstPro) {
          try {
            localStorage.setItem("lastProRemaining", firstPro);
          } catch (e) {}
          safeUpdate("headerProRemaining", firstPro);
        }
      }

      function updateLimitStats(results) {
        if (!results || results.length === 0) return;

        const okCount = results.filter((r) => String(r.status_raw || "") === "OK").length;
        const limitCount = results.filter((r) =>
          String(r.status_raw || "").includes("LIMIT"),
        ).length;
        const loginCount = results.filter((r) =>
          String(r.status_raw || "").includes("SESSION"),
        ).length;
        const errorCount = results.filter((r) =>
          String(r.status_raw || "").includes("ERROR"),
        ).length;

        document.getElementById("limitOkCount").textContent = okCount;
        document.getElementById("limitExceededCount").textContent = limitCount;
        document.getElementById("limitLoginCount").textContent = loginCount;
        document.getElementById("limitErrorCount").textContent = errorCount;
        document.getElementById("limitLastCheck").textContent =
          new Date().toLocaleTimeString();

        // Increment session runs
        const currentRuns =
          parseInt(document.getElementById("limitSessionRuns").textContent) ||
          0;
        document.getElementById("limitSessionRuns").textContent =
          currentRuns + 1;
      }

      // ============================================
      // Post-Processing
      // ============================================

      let postProcRunning = false;

      async function togglePostProcess() {
        const apiKey = document.getElementById("postProcApiKey").value;
        // Use the DSN from the main Job Config
        const dsn = document.getElementById("jobPgDsn").value;

        if (!apiKey || !dsn) {
          showToast(
            "error",
            "Błąd",
            "Podaj API Key i upewnij się, że PostgreSQL DSN jest ustawiony w konfiguracji joba",
          );
          return;
        }

        if (!postProcRunning) {
          try {
            const response = await fetch("/api/postprocess/start", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ api_key: apiKey, dsn: dsn }),
            });

            if (response.ok) {
              postProcRunning = true;
              document.getElementById("postProcToggleBtn").innerHTML =
                '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="6" width="12" height="12"/></svg> Stop';
              document.getElementById("postProcStatusBadge").textContent =
                "RUNNING";
              document.getElementById("postProcStatusBadge").className =
                "badge badge-success";
              showToast("success", "Uruchomiono", "Post-processing rozpoczęty");
              pollPostProcStatus();
            } else {
              const data = await response.json();
              showToast(
                "error",
                "Błąd",
                data.detail || "Nie udało się uruchomić post-processingu",
              );
            }
          } catch (e) {
            showToast("error", "Błąd", e.message);
          }
        } else {
          try {
            await fetch("/api/postprocess/stop", { method: "POST" });
            postProcRunning = false;
            document.getElementById("postProcToggleBtn").innerHTML =
              '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg> Start';
            document.getElementById("postProcStatusBadge").textContent = "IDLE";
            document.getElementById("postProcStatusBadge").className =
              "badge badge-neutral";
            showToast("info", "Zatrzymano", "Post-processing zatrzymany");
          } catch (e) {
            showToast("error", "Błąd", e.message);
          }
        }
      }

      async function pollPostProcStatus() {
        if (!postProcRunning) return;

        try {
          // Use DSN from main config
          const dsn = document.getElementById("jobPgDsn").value;
          const response = await fetch(
            `/api/postprocess/status?dsn=${encodeURIComponent(dsn)}`,
          );
          const data = await response.json();

          document.getElementById("postProcNew").textContent =
            data.new_count || 0;
          document.getElementById("postProcDone").textContent =
            data.done_count || 0;

          const total = (data.new_count || 0) + (data.done_count || 0);
          const progress = total > 0 ? (data.done_count / total) * 100 : 0;
          document.getElementById("postProcProgressBar").style.width =
            progress + "%";

          if (data.running) {
            setTimeout(pollPostProcStatus, 2000);
          } else {
            postProcRunning = false;
            document.getElementById("postProcToggleBtn").innerHTML =
              '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg> Start';
            document.getElementById("postProcStatusBadge").textContent = "IDLE";
            document.getElementById("postProcStatusBadge").className =
              "badge badge-neutral";
          }
        } catch (e) {
          console.error("Post-proc status error:", e);
        }
      }

      async function migratePostProcess() {
        // Use DSN from main config
        const dsn = document.getElementById("jobPgDsn").value;
        if (!dsn) {
          showToast("error", "Błąd", "Brak DSN w konfiguracji joba");
          return;
        }

        try {
          const response = await fetch("/api/postprocess/migrate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ dsn: dsn }),
          });

          if (response.ok) {
            showToast("success", "Sukces", "Tabele utworzone pomyślnie");
          } else {
            const data = await response.json();
            showToast(
              "error",
              "Błąd",
              data.detail || "Migracja nie powiodła się",
            );
          }
        } catch (e) {
          showToast("error", "Błąd", e.message);
        }
      }

      // ============================================
      // Settings
      // ============================================

      async function toggleAutoRestart() {
        const enabled = document.getElementById("autoRestartEnabled").checked;
        try {
          await fetch("/api/autorestart", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ enabled: enabled }),
          });
          showToast(
            "info",
            "Zapisano",
            `Auto-restart ${enabled ? "włączony" : "wyłączony"}`,
          );
        } catch (e) {
          showToast("error", "Błąd", e.message);
        }
      }

      async function runCleanup(suffix = "") {
        const check = (id) => {
          const el = document.getElementById(id + suffix);
          return el ? el.checked : false;
        };
        const targets = [];
        if (check("cleanupJobs")) targets.push("jobs");
        if (check("cleanupLogs")) targets.push("logs");
        if (check("cleanupArtifacts")) targets.push("artifacts");
        if (check("cleanupUiHealth")) targets.push("ui_health");
        if (check("cleanupTestResults")) targets.push("test-results");
        if (check("cleanupPycache")) targets.push("__pycache__");

        const force = check("cleanupForce"); // New: Support force

        const btn = document.getElementById("cleanupExecuteBtn" + suffix);
        const status = document.getElementById("cleanupStatus" + suffix);

        if (targets.length === 0) {
           showToast("error", "Błąd", "Wybierz co najmniej jeden folder");
           return;
        }

        if (btn) btn.disabled = true;
        if (status) { 
            status.textContent = "Czyszczenie..."; 
            status.style.color = "";
        }

        try {
          const response = await fetch("/api/cleanup", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ targets, force }),
          });
          const data = await response.json();
          if (response.ok) {
            if (status) {
                status.textContent = `✅ Usunięto: ${data.removed || 0} plików`;
                status.style.color = "#10b981";
            }
            showToast("success", "Wyczyszczono", `Usunięto ${data.removed || 0} plików`);
            if (suffix && typeof closeCleanupModal === 'function') {
                setTimeout(closeCleanupModal, 1500);
            }
          } else {
             if (status) {
                 status.textContent = `❌ Błąd: ${data.detail || "Nieznany błąd"}`;
                 status.style.color = "#ef4444";
             }
             showToast("error", "Błąd", data.detail);
          }
        } catch (e) {
           if (status) {
             status.textContent = `❌ Błąd: ${e.message}`;
             status.style.color = "#ef4444";
           }
           showToast("error", "Błąd", e.message);
        } finally {
           if (btn) btn.disabled = false;
        }
      }



      async function syncProfiles() {
        showToast("info", "Synchronizacja...", "Synchronizowanie profili");
        try {
          const response = await fetch("/api/profiles/sync", {
            method: "POST",
          });
          if (response.ok) {
            showToast(
              "success",
              "Zsynchronizowano",
              "Profile zostały zsynchronizowane",
            );
            location.reload();
          }
        } catch (e) {
          showToast("error", "Błąd", e.message);
        }
      }



      // ============================================
      // X11 Display Settings
      // ============================================

      async function loadX11Display() {
        try {
          const response = await fetch("/api/settings/x11-display");
          if (response.ok) {
            const data = await response.json();
            const displayInput = document.getElementById("settingDisplay");
            if (displayInput) {
              displayInput.value = data.display || "";
            }
          }
        } catch (e) {
          console.error("Failed to load X11 display setting:", e);
        }
      }

      async function saveX11Display() {
        const display = document.getElementById("x11Display").value.trim();
        try {
          const response = await fetch("/api/settings/x11-display", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ display: display }),
          });
          if (response.ok) {
            showToast(
              "success",
              "Zapisano",
              "Ustawienie DISPLAY zostało zapisane",
            );
            document.getElementById("x11DisplayStatus").textContent =
              `Aktualnie: ${display || "(nie ustawiono)"}`;
          } else {
            const data = await response.json();
            showToast("error", "Błąd", data.detail || "Nie można zapisać");
          }
        } catch (e) {
          showToast("error", "Błąd", e.message);
        }
      }

      // ============================================
      // Update Counts Settings
      // ============================================

      async function loadUpdateCountsSettings() {
        try {
          const response = await fetch("/api/settings/update-counts");
          if (!response.ok) return;
          const data = await response.json();
          const toggle = document.getElementById("settingUpdateCountsOnNewPaths");
          const pollInput = document.getElementById("settingUpdateCountsPollSec");
          if (toggle) toggle.checked = !!data.on_new_paths;
          if (pollInput) pollInput.value = data.poll_sec ?? 60;
        } catch (e) {
          console.error("Failed to load update counts settings:", e);
        }
      }

      async function saveUpdateCountsSettings() {
        const toggle = document.getElementById("settingUpdateCountsOnNewPaths");
        const pollInput = document.getElementById("settingUpdateCountsPollSec");
        const payload = {
          on_new_paths: !!(toggle && toggle.checked),
          poll_sec: pollInput ? parseInt(pollInput.value || "0", 10) : 0,
        };
        if (Number.isNaN(payload.poll_sec)) payload.poll_sec = 0;
        if (payload.poll_sec < 0) payload.poll_sec = 0;
        try {
          const response = await fetch("/api/settings/update-counts", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (response.ok) {
            showToast("success", "Zapisano", "Ustawienia aktualizacji liczników zapisane");
          } else {
            const data = await response.json().catch(() => ({}));
            showToast("error", "Błąd", data.detail || "Nie można zapisać");
          }
        } catch (e) {
          showToast("error", "Błąd", e.message);
        }
      }

      // ============================================
      // Webshare Settings
      // ============================================

      async function loadWebshareSettings() {
        try {
          const response = await fetch("/api/settings/webshare");
          if (!response.ok) return;
          const data = await response.json();
          const token = document.getElementById("settingWebshareToken");
          const mode = document.getElementById("settingWebshareMode");
          const planId = document.getElementById("settingWebsharePlanId");
          const pageSize = document.getElementById("settingWebsharePageSize");
          const countries = document.getElementById("settingWebshareCountries");
          const minValid = document.getElementById("settingWebshareMinValid");
          const proxyDisabled = document.getElementById("settingProxyDisabledGlobal");
          const seed = document.getElementById("settingWebshareSeed");
          if (token) token.value = data.WEBSHARE_API_TOKEN || "";
          if (mode) mode.value = data.WEBSHARE_PROXY_MODE || "";
          if (planId) planId.value = data.WEBSHARE_PLAN_ID || "";
          if (pageSize) pageSize.value = data.WEBSHARE_PAGE_SIZE || "";
          if (countries) countries.value = data.WEBSHARE_COUNTRY_CODES || "";
          if (minValid) minValid.checked = String(data.WEBSHARE_MIN_VALID || "1") !== "0";
          if (proxyDisabled) {
            proxyDisabled.checked = ["1", "true", "yes", "on"].includes(
              String(data.OCR_PROXY_DISABLED || "0").toLowerCase(),
            );
          }
          if (seed) seed.value = data.WEBSHARE_ASSIGN_SEED || "";
          loadWebshareStatus();
        } catch (e) {
          console.error("Failed to load Webshare settings:", e);
        }
      }

      async function saveWebshareSettings() {
        const payload = {
          WEBSHARE_API_TOKEN: document.getElementById("settingWebshareToken")?.value || "",
          WEBSHARE_PROXY_MODE: document.getElementById("settingWebshareMode")?.value || "",
          WEBSHARE_PLAN_ID: document.getElementById("settingWebsharePlanId")?.value || "",
          WEBSHARE_PAGE_SIZE: document.getElementById("settingWebsharePageSize")?.value || "",
          WEBSHARE_COUNTRY_CODES: document.getElementById("settingWebshareCountries")?.value || "",
          WEBSHARE_MIN_VALID: document.getElementById("settingWebshareMinValid")?.checked ? "1" : "0",
          OCR_PROXY_DISABLED: document.getElementById("settingProxyDisabledGlobal")?.checked ? "1" : "0",
          WEBSHARE_ASSIGN_SEED: document.getElementById("settingWebshareSeed")?.value || "",
        };
        try {
          const response = await fetch("/api/settings/webshare", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (response.ok) {
            showToast("success", "Zapisano", "Ustawienia Webshare zapisane");
          } else {
            const data = await response.json().catch(() => ({}));
            showToast("error", "Błąd", data.detail || "Nie można zapisać");
          }
        } catch (e) {
          showToast("error", "Błąd", e.message);
        }
      }

      async function runWebshareSync() {
        const status = document.getElementById("webshareSyncStatus");
        if (status) status.textContent = "Sync...";
        try {
          const response = await fetch("/api/settings/webshare/sync", { method: "POST" });
          const data = await response.json().catch(() => ({}));
          if (response.ok && data.success) {
            if (status) status.textContent = data.stdout || "OK";
            showToast("success", "Webshare", "Sync zakończony");
          } else {
            if (status) status.textContent = data.stderr || data.detail || "Błąd";
            showToast("error", "Webshare", data.stderr || data.detail || "Błąd sync");
          }
          loadWebshareStatus();
        } catch (e) {
          if (status) status.textContent = e.message || "Błąd";
          showToast("error", "Webshare", e.message || "Błąd sync");
        }
      }

      async function loadWebshareStatus() {
        try {
          const response = await fetch("/api/settings/webshare/status");
          if (!response.ok) return;
          const data = await response.json();
          const el = document.getElementById("webshareSyncLast");
          if (!el) return;
          if (data && data.timestamp) {
            const status = data.success === true ? "OK" : data.success === false ? "Błąd" : "-";
            const info = data.stdout || data.stderr || "";
            el.textContent = `Ostatni sync: ${data.timestamp} (${status}) ${info}`.trim();
          } else {
            el.textContent = "";
          }
        } catch (e) {
          // Silent
        }
      }

      // ============================================

      // ============================================
      // Remote Configuration (Multi-Host)
      // ============================================

      let remoteHostsData = [];
      let remoteRunEnabledGlobal = false;
      let remoteRepoStatus = {};
      let remoteUpdateLogs = {};  // Store update logs per host
      let localHostDefaults = null;

      function _buildFallbackWindowsPreset(user) {
        const winUser = user || "user";
        const repo = "C:\\ocr-dashboard-v3";
        return {
          os_type: "windows",
          user: winUser,
          ssh_opts: "-p 22",
          repo,
          python: `${repo}\\venv\\Scripts\\python.exe`,
          profile_root: `C:\\Users\\${winUser}\\.cache\\ocr-dashboard-v3`,
          chrome_bin: "C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe",
        };
      }

      function getHostPresetForOs(osType) {
        const data = localHostDefaults || {};
        const normalized = (osType || "linux").toLowerCase();
        if (normalized === "windows") {
          const user = data.user || data.linux?.user || "";
          return data.windows || _buildFallbackWindowsPreset(user);
        }
        return data.linux || data;
      }

      function applyHostPresetForOs(osType, { force = false } = {}) {
        const preset = getHostPresetForOs(osType);
        if (!preset || typeof preset !== "object") return;

        const fieldMap = {
          hostRepoDir: "repo",
          hostPythonPath: "python",
          hostProfileRoot: "profile_root",
          hostChromeBin: "chrome_bin",
        };

        Object.entries(fieldMap).forEach(([inputId, key]) => {
          const el = document.getElementById(inputId);
          if (!el) return;
          const nextValue = String(preset[key] || "").trim();
          if (!nextValue) return;
          if (force || !String(el.value || "").trim()) {
            el.value = nextValue;
          }
        });
      }

      async function loadLocalHostDefaults() {
        if (localHostDefaults) return localHostDefaults;
        try {
          const response = await fetch("/api/settings/remote-host/local-defaults");
          if (!response.ok) return null;
          localHostDefaults = await response.json();
          return localHostDefaults;
        } catch (e) {
          return null;
        }
      }

      // Open Tailscale auth URLs in new browser tabs
      function openTailscaleAuthUrls(authUrls) {
        if (!authUrls || !Array.isArray(authUrls) || authUrls.length === 0) return;
        
        authUrls.forEach((url, idx) => {
          // Small delay between opens to avoid popup blockers
          setTimeout(() => {
            window.open(url, '_blank');
          }, idx * 300);
        });
        
        showToast(
          "warning",
          "Wymagana autoryzacja Tailscale",
          `Otwarto ${authUrls.length} okno/okien autoryzacji. Zaloguj się w przeglądarce.`,
          8000
        );
      }

      async function loadRemoteHosts() {
        try {
          const response = await fetch("/api/settings/remote-hosts");
          if (response.ok) {
            const data = await response.json();
            const config = data.config || data;  // Handle both wrapped and unwrapped responses
            
            // Check normalized keys or string keys
            remoteRunEnabledGlobal = config.OCR_REMOTE_RUN_ENABLED === true || config.OCR_REMOTE_RUN_ENABLED === "true";
            
            let hostsList = config.OCR_REMOTE_HOSTS_LIST;
            if (typeof hostsList === 'string') {
                try {
                    hostsList = JSON.parse(hostsList);
                } catch(e) {
                    console.warn("Failed to parse OCR_REMOTE_HOSTS_LIST string", e);
                    hostsList = [];
                }
            }
            if (!Array.isArray(hostsList)) hostsList = [];
            
            // Note: empty list is valid (all hosts were deleted)

            const normalizedHosts = hostsList.map((host) => {
              const normalized = { ...host };
              if ("source" in normalized) {
                delete normalized.source;
              }
              return normalized;
            });

            // Always expose localhost settings as a visible host card in #settings.
            const defaults = await loadLocalHostDefaults();
            const linuxPreset = defaults?.linux || defaults || {};
            const localHost = {
              id: "localhost",
              name: "Localhost",
              enabled: true,
              isLocal: true,
              roles: {
                worker: true,
                browser: true,
              },
              host: "localhost",
              user: linuxPreset.user || defaults?.user || "",
              ssh: linuxPreset.ssh_opts || defaults?.ssh_opts || "-",
              osType: "linux",
              repo: linuxPreset.repo || defaults?.repo || "",
              python: linuxPreset.python || defaults?.python || "",
              profileRoot: linuxPreset.profile_root || defaults?.profile_root || "",
              chrome: linuxPreset.chrome_bin || defaults?.chrome_bin || "",
              portBase: 9222,
              portSpan: 100,
              localPortBase: 18222,
              tunnel: true,
            };

            remoteHostsData = [
              localHost,
              ...normalizedHosts.filter((host) => !host?.isLocal && String(host?.id) !== "localhost"),
            ];

            // Update UI
            const toggle = document.getElementById("settingRemoteRunEnabled");
            if (toggle) toggle.checked = remoteRunEnabledGlobal;

            renderRemoteHosts();
            updateProfileExecutionOptions(); // Populate dropdowns for profiles
            updateLimitHostOptions();
            populateTargetHosts();
          }
        } catch (e) {
          console.error("Failed to load remote hosts:", e);
          showToast("error", "Błąd", "Nie można załadować konfiguracji zdalnych hostów");
        }
      }

      function initializeDefaultHosts() {
          return [
              {
                  id: "wsl-1dtw2-1",
                  name: "WSL 1dtw2-1",
                  roles: {
                      worker: true,
                      browser: false
                  },
                  host: "1dtw2.tail7319.ts.net",
                  user: "tomaasz",
                  ssh: "-p 2222",
                  repo: "/home/tomaasz/ocr-dashboard-v3",
                  python: "/home/tomaasz/ocr-dashboard-v3/venv/bin/python3",
                  profileRoot: "",
                  chrome: "",
                  portBase: 9222,
                  portSpan: 100,
                  localPortBase: 18222,
                  tunnel: false
              }
          ];
      }

      function renderRemoteHosts() {
         const container = document.getElementById("remoteHostsContainer");
         if (!container) return;
         container.innerHTML = "";

         // Render hosts from data (including localhost if present)
         if (remoteHostsData.length === 0) {
             const emptyMsg = document.createElement("div");
             emptyMsg.className = "text-secondary text-sm p-4 text-center";
             emptyMsg.style.gridColumn = "span 2";
             emptyMsg.textContent = "Brak hostów. Dodaj nowy host.";
             container.appendChild(emptyMsg);
             updateLimitHostOptions();
             return;
         }

        remoteHostsData.forEach((host, index) => {
             const roles = [];
             // Support both 'modes' array (from JSON) and 'roles' object (from UI)
             if (Array.isArray(host.modes)) {
                 if (host.modes.includes('Worker')) roles.push('<span class="status-badge status-active" style="background: rgba(16, 185, 129, 0.2); color: #10b981;">Worker</span>');
                 if (host.modes.includes('Browser')) roles.push('<span class="status-badge status-active" style="background: rgba(59, 130, 246, 0.2); color: #3b82f6;">Browser</span>');
             } else if (host.roles) {
                 if (host.roles.worker) roles.push('<span class="status-badge status-active" style="background: rgba(16, 185, 129, 0.2); color: #10b981;">Worker</span>');
                 if (host.roles.browser) roles.push('<span class="status-badge status-active" style="background: rgba(59, 130, 246, 0.2); color: #3b82f6;">Browser</span>');
             }
             if (host.isLocal) roles.push('<span class="status-badge" style="background: rgba(251, 191, 36, 0.2); color: #fbbf24;">Local</span>');

             const card = document.createElement("div");
             card.className = "host-card";
             if (host.isLocal) card.style.borderLeft = "3px solid var(--color-primary)";
             
             const repoInfo = remoteRepoStatus[String(host.id)] || null;
             const repoBadge = formatRepoStatusBadge(repoInfo);
             
             // Footer buttons - localhost cannot be edited/deleted
             const hasLogs = !!remoteUpdateLogs[String(host.id)];
             const footerButtons = host.isLocal
                 ? `<span class="text-xs text-secondary">Host lokalny</span>`
                 : `<button class="btn btn-secondary btn-sm" onclick="editHost(${index})" data-remote-host-edit="true">Edytuj</button>
                    <button class="btn btn-ghost btn-sm text-danger" onclick="deleteHost(${index})" data-remote-host-edit="true">Usuń</button>
                    <button class="btn btn-ghost btn-sm" onclick="updateRemoteRepo('${host.id}')">Aktualizuj</button>
                    <button class="btn btn-ghost btn-sm ${hasLogs ? '' : 'disabled'}" onclick="copyHostUpdateLogs('${host.id}')" ${hasLogs ? '' : 'disabled'} title="Kopiuj logi aktualizacji">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2 2v1"></path></svg>
                    </button>`;
             
             // lgtm[js/xss]
             // deepcode ignore DOMXSS: host data is escaped
             card.innerHTML = `
                <div class="host-header">
                    <div class="host-title flex items-center gap-sm">
                        ${escapeHtml(host.name || host.host || 'Unnamed Host')}
                        ${roles.join('')}
                    </div>
                </div>
                <div class="host-body text-sm text-secondary">
                    <div>Host: ${escapeHtml(host.host || '-')}</div>
                    <div>User: ${escapeHtml(host.user || '-')}</div>
                    <div>Repo: ${escapeHtml(host.repo || '-')}</div>
                    <div>Python: ${escapeHtml(host.python || '-')}</div>
                    ${!host.isLocal ? `<div class="flex items-center gap-sm mt-1">
                        <span style="font-weight: 600; font-size: 11px;">Repo:</span>
                        ${repoBadge}
                    </div>` : ''}
                </div>
                <div class="host-footer flex gap-sm mt-2 justify-end">
                    ${footerButtons}
                </div>
             `;
             container.appendChild(card);
         });

        unlockRemoteHostEditing();
        updateLimitHostOptions();
      }

      function unlockRemoteHostEditing() {
        document.querySelectorAll('[data-remote-host-edit="true"]').forEach((btn) => {
          btn.disabled = false;
          btn.classList.remove("disabled");
          btn.removeAttribute("aria-disabled");
        });
      }

      function formatRepoStatusBadge(info) {
        if (!info) {
          return '<span class="badge badge-neutral">?</span>';
        }
        const status = info.status;
        const commit = info.commit ? `@${escapeHtml(info.commit)}` : "";
        const branch = info.branch ? escapeHtml(info.branch) : "";
        const suffix = branch ? ` ${branch}${commit}` : commit;
        if (status === "up_to_date") {
          return `<span class="badge badge-success">OK${suffix}</span>`;
        }
        if (status === "behind") {
          return `<span class="badge badge-warning">behind ${info.behind || 0}${suffix}</span>`;
        }
        if (status === "ahead") {
          return `<span class="badge badge-warning">ahead ${info.ahead || 0}${suffix}</span>`;
        }
        if (status === "diverged") {
          return `<span class="badge badge-error">diverged${suffix}</span>`;
        }
        if (status === "no_upstream") {
          return `<span class="badge badge-warning">no upstream${suffix}</span>`;
        }
        if (status === "no_remote") {
          return `<span class="badge badge-warning">no remote${suffix}</span>`;
        }
        if (status === "fetch_failed") {
          return `<span class="badge badge-error">fetch failed${suffix}</span>`;
        }
        if (status === "updated") {
          return `<span class="badge badge-success">updated${suffix}</span>`;
        }
        if (status === "skipped") {
          return `<span class="badge badge-neutral">skipped${suffix}</span>`;
        }
        if (status === "error") {
          const msg = escapeHtml(info.message || "");
          return `<span class="badge badge-error">ERROR${suffix} ${msg}</span>`;
        }
        return `<span class="badge badge-neutral">${escapeHtml(status || "?")}</span>`;
      }

      async function checkRemoteRepos() {
        try {
          const response = await fetch("/api/settings/remote-hosts/repo-status");
          if (!response.ok) throw new Error("Repo status failed");
          const data = await response.json();
          remoteRepoStatus = {};
          (data.hosts || []).forEach((h) => {
            if (h.id) remoteRepoStatus[String(h.id)] = h;
          });
          renderRemoteHosts();
          showToast("success", "Zakończono", "Sprawdzono repo na hostach");
        } catch (e) {
          showToast("error", "Błąd", "Nie udało się sprawdzić repo");
        }
      }

      async function updateRemoteRepos() {
        try {
          const response = await fetch("/api/settings/remote-hosts/repo-update", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ only_outdated: true }),
          });
          if (!response.ok) throw new Error("Repo update failed");
          const data = await response.json();
          
          // Collect all auth_urls from all hosts
          let allAuthUrls = [];
          
          (data.hosts || []).forEach((h) => {
            if (h.id) {
              remoteRepoStatus[String(h.id)] = h;
              // Collect auth URLs
              if (h.auth_urls && Array.isArray(h.auth_urls)) {
                allAuthUrls = allAuthUrls.concat(h.auth_urls);
              }
              // Store logs per host
              const logEntry = [
                `=== Update: ${new Date().toLocaleString()} ===`,
                `Host: ${h.name || h.id}`,
                `  Status: ${h.status}`,
                h.message ? `  Message: ${h.message}` : '',
                h.branch ? `  Branch: ${h.branch}` : '',
                h.commit ? `  Commit: ${h.commit}` : '',
                h.auth_urls ? `  Auth URLs: ${h.auth_urls.join(', ')}` : '',
              ].filter(Boolean).join('\n');
              remoteUpdateLogs[String(h.id)] = logEntry;
            }
          });
          
          // Open auth URLs if any
          if (allAuthUrls.length > 0) {
            openTailscaleAuthUrls([...new Set(allAuthUrls)]);
          }
          
          renderRemoteHosts();
          const anyError = (data.hosts || []).some((h) =>
            ["error", "fetch_failed"].includes(h.status),
          );
          showToast(
            anyError ? "warning" : "success",
            "Zakończono",
            anyError
              ? "Aktualizacja zakończona z błędami"
              : "Aktualizacja zakończona",
          );
        } catch (e) {
          showToast("error", "Błąd", "Nie udało się zaktualizować repo");
        }
      }

      async function updateRemoteRepo(hostId) {
        if (!hostId) return;
        try {
          const response = await fetch("/api/settings/remote-hosts/repo-update", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ host_id: String(hostId), only_outdated: false }),
          });
          if (!response.ok) throw new Error("Repo update failed");
          const data = await response.json();
          
          // Collect all auth_urls and logs from response
          let allAuthUrls = [];
          let logLines = [`=== Update: ${new Date().toLocaleString()} ===`];
          
          (data.hosts || []).forEach((h) => {
            if (h.id) {
              remoteRepoStatus[String(h.id)] = h;
              // Collect auth URLs
              if (h.auth_urls && Array.isArray(h.auth_urls)) {
                allAuthUrls = allAuthUrls.concat(h.auth_urls);
              }
              // Build log entry
              logLines.push(`Host: ${h.name || h.id}`);
              logLines.push(`  Status: ${h.status}`);
              if (h.message) logLines.push(`  Message: ${h.message}`);
              if (h.branch) logLines.push(`  Branch: ${h.branch}`);
              if (h.commit) logLines.push(`  Commit: ${h.commit}`);
              if (h.auth_urls) logLines.push(`  Auth URLs: ${h.auth_urls.join(', ')}`);
              logLines.push('');
            }
          });
          
          // Store logs for this host
          remoteUpdateLogs[String(hostId)] = logLines.join('\n');
          
          // Open auth URLs if any
          if (allAuthUrls.length > 0) {
            openTailscaleAuthUrls([...new Set(allAuthUrls)]);
          }
          
          renderRemoteHosts();
          
          const hasError = (data.hosts || []).some(h => 
            ['error', 'fetch_failed'].includes(h.status)
          );
          if (hasError) {
            toastHost("warning", "Zakończono z błędami", "Sprawdź logi aktualizacji", hostId);
          } else {
            toastHost("success", "Zakończono", "Repo zaktualizowane", hostId);
          }
        } catch (e) {
          remoteUpdateLogs[String(hostId)] = `ERROR: ${e.message}\n${new Date().toLocaleString()}`;
          renderRemoteHosts();
          toastHost("error", "Błąd", "Nie udało się zaktualizować repo", hostId);
        }
      }

      // Copy update logs for a specific host
      function copyHostUpdateLogs(hostId) {
        const logs = remoteUpdateLogs[String(hostId)];
        if (!logs) {
          showToast("info", "Brak logów", "Najpierw wykonaj aktualizację");
          return;
        }
        navigator.clipboard.writeText(logs).then(() => {
          showToast("success", "Skopiowano", "Logi aktualizacji skopiowane do schowka");
        }).catch(err => {
          console.error('Failed to copy logs:', err);
          showToast("error", "Błąd", "Nie udało się skopiować logów");
        });
      }

      async function saveRemoteHosts() {
        const normalizedHosts = remoteHostsData
          .filter((host) => !host?.isLocal && String(host?.id) !== "localhost")
          .map((host) => {
          const cleanHost = { ...host };
          delete cleanHost.source;
          return cleanHost;
        });

        const payload = {
            OCR_REMOTE_RUN_ENABLED: document.getElementById("settingRemoteRunEnabled").checked,
            OCR_REMOTE_HOSTS_LIST: normalizedHosts
        };

        try {
            const response = await fetch("/api/settings/remote-hosts", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            if (response.ok) {
                 showToast("success", "Zapisano", "Konfiguracja hostów zapisana");
                 loadRemoteHosts(); // Reload to confirm
            } else {
                 const data = await response.json();
                 showToast("error", "Błąd", data.detail || "Nie można zapisać konfiguracji");
            }
        } catch (e) {
             showToast("error", "Błąd", e.message);
        }
    }

      // Modal Logic
      async function openAddHostModal() {
        document.getElementById("editHostIndex").value = "-1"; // New host
        document.getElementById("hostName").value = "";
        document.getElementById("hostRoleWorker").checked = true;
        document.getElementById("hostRoleBrowser").checked = false;
        
        document.getElementById("hostAddress").value = "";
        document.getElementById("hostUser").value = "";
        document.getElementById("hostSshOpts").value = "-p 22";
        document.getElementById("hostOsType").value = "linux";
        document.getElementById("hostRepoDir").value = "";
        document.getElementById("hostPythonPath").value = "";
        document.getElementById("hostNasSource").value = "";
        
        // Browser defaults
        document.getElementById("hostProfileRoot").value = "";
        document.getElementById("hostChromeBin").value = "";
        document.getElementById("hostPortBase").value = "9222";
        document.getElementById("hostPortSpan").value = "100";
        document.getElementById("hostLocalPortBase").value = "18222";
        document.getElementById("hostTunnel").checked = true;

        // Reset deploy section
        document.getElementById("hostAutoDeploy").checked = false;
        document.getElementById("hostDeploySection").style.display = "none";
        document.getElementById("hostDeployLogContainer").style.display = "none";
        clearHostTestResult();
        document.getElementById("hostDeploySudoPass").value = "";
        document.getElementById("hostDeployGithubRepo").value = "https://github.com/tomaasz/ocr-dashboard-v3";
        document.getElementById("hostDeployNasHost").value = "100.80.240.52";
        document.getElementById("hostDeployNasShare").value = "Genealogy";
        document.getElementById("hostDeployNasUser").value = "";
        document.getElementById("hostDeployNasPass").value = "";
        document.getElementById("hostDeployPostgres").checked = false;
        document.getElementById("hostSaveBtn").textContent = "Zapisz";
        document.getElementById("hostSaveBtn").disabled = false;

        const defaults = await loadLocalHostDefaults();
        if (defaults) {
          const linuxPreset = defaults.linux || defaults;
          document.getElementById("hostUser").value = linuxPreset.user || defaults.user || "";
          document.getElementById("hostSshOpts").value = linuxPreset.ssh_opts || defaults.ssh_opts || "-p 22";
          document.getElementById("hostOsType").value = linuxPreset.os_type || defaults.os_type || "linux";
          applyHostPresetForOs(document.getElementById("hostOsType").value, { force: true });
        }

        updateHostTestButtonState();

        document.getElementById("hostConfigModal").classList.add("visible");
      }

      function editHost(index) {
          const host = remoteHostsData[index];
          if (!host) return;

          document.getElementById("editHostIndex").value = index;
          document.getElementById("hostName").value = host.name || "";
          
          document.getElementById("hostRoleWorker").checked = host.roles?.worker || false;
          document.getElementById("hostRoleBrowser").checked = host.roles?.browser || false;

          document.getElementById("hostAddress").value = host.host || "";
          document.getElementById("hostUser").value = host.user || "";
          document.getElementById("hostSshOpts").value = host.ssh || host.ssh_options || "";
          document.getElementById("hostOsType").value = host.osType || "linux";
          document.getElementById("hostRepoDir").value = host.repo || host.ocr_project_path || "";
          document.getElementById("hostPythonPath").value = host.python || "";

          // Browser settings
          document.getElementById("hostProfileRoot").value = host.profileRoot || "";
          document.getElementById("hostChromeBin").value = host.chrome || "";
          document.getElementById("hostPortBase").value = host.portBase || "9222";
          document.getElementById("hostPortSpan").value = host.portSpan || "100";
          document.getElementById("hostLocalPortBase").value = host.localPortBase || "18222";
          document.getElementById("hostTunnel").checked = host.tunnel === true;
          document.getElementById("hostNasSource").value = host.nasSource || "";

          // Hide deploy section for existing hosts
          document.getElementById("hostAutoDeploy").checked = false;
          document.getElementById("hostDeploySection").style.display = "none";
          document.getElementById("hostDeployLogContainer").style.display = "none";
          clearHostTestResult();
          document.getElementById("hostSaveBtn").textContent = "Zapisz";
          document.getElementById("hostSaveBtn").disabled = false;
          updateHostTestButtonState();

          document.getElementById("hostConfigModal").classList.add("visible");
      }

      let deleteHostIndex = null;
      
      function deleteHost(index) {
          deleteHostIndex = index;
          const host = remoteHostsData[index];
          document.getElementById('deleteHostName').textContent = host?.name || host?.host || `Host #${index + 1}`;
          document.getElementById('deleteHostModal').classList.add('visible');
      }
      
      function closeDeleteHostModal() {
          document.getElementById('deleteHostModal').classList.remove('visible');
          deleteHostIndex = null;
      }
      
      async function confirmDeleteHost() {
          if (deleteHostIndex !== null) {
              const deletedHost = remoteHostsData[deleteHostIndex];
              remoteHostsData.splice(deleteHostIndex, 1);
              renderRemoteHosts();
              await saveRemoteHosts();
              toastHost(
                "success",
                "Usunięto",
                "Host został usunięty z konfiguracji",
                deletedHost?.name
                  || deletedHost?.host
                  || `Host #${deleteHostIndex + 1}`,
              );
          }
          closeDeleteHostModal();
      }

      function closeHostConfigModal() {
          document.getElementById("hostConfigModal").classList.remove("visible");
      }

      function clearHostTestResult() {
          const container = document.getElementById("hostTestResultContainer");
          const panel = document.getElementById("hostTestResult");
          if (!container || !panel) return;
          container.style.display = "none";
          panel.textContent = "Brak testu.";
      }

      function _hostCheckLabel(key) {
          const labels = {
              ssh: "SSH",
              repo: "Repo",
              python: "Python",
              profile_root: "Profile Root",
              chrome_bin: "Chrome Binary",
          };
          return labels[key] || key;
      }

      function renderHostTestResult(data, fallbackMessage = "") {
          const container = document.getElementById("hostTestResultContainer");
          const panel = document.getElementById("hostTestResult");
          if (!container || !panel) return;

          container.style.display = "block";

          if (!data || typeof data !== "object") {
              panel.textContent = fallbackMessage || "Brak danych testu.";
              return;
          }

          const checks = data.checks && typeof data.checks === "object" ? data.checks : {};
          const lines = [];
          lines.push(data.success ? "✅ Test hosta: OK" : "❌ Test hosta: NIEPOWODZENIE");

          const keys = Object.keys(checks);
          if (keys.length === 0) {
              if (fallbackMessage) lines.push(fallbackMessage);
          } else {
              keys.forEach((key) => {
                  const entry = checks[key] || {};
                  const ok = entry.ok === true;
                  const marker = ok ? "✅" : "❌";
                  const label = _hostCheckLabel(key);
                  const output = String(entry.output || entry.message || "").trim();
                  lines.push(`${marker} ${label}${output ? ` -> ${output}` : ""}`);
              });
          }

          panel.textContent = lines.join("\n");
      }

      function onHostOsTypeChanged() {
          const osType = document.getElementById("hostOsType")?.value || "linux";
          const index = parseInt(document.getElementById("editHostIndex")?.value || "-1", 10);
          const isNewHost = Number.isNaN(index) || index === -1;
          applyHostPresetForOs(osType, { force: isNewHost });
      }

      function isHostTestReady() {
          const host = document.getElementById("hostAddress")?.value?.trim();
          const user = document.getElementById("hostUser")?.value?.trim();
          const repo = document.getElementById("hostRepoDir")?.value?.trim();
          const python = document.getElementById("hostPythonPath")?.value?.trim();
          return Boolean(host && user && repo && python);
      }

      function updateHostTestButtonState() {
          const btn = document.getElementById("hostTestBtn");
          if (!btn) return;
          btn.disabled = !isHostTestReady();
      }

      async function testHostConfig() {
          if (!isHostTestReady()) {
              showToast("warning", "Uwaga", "Uzupełnij Host, Użytkownik, Repozytorium i Komendę Python");
              return;
          }

          const btn = document.getElementById("hostTestBtn");
          const originalText = btn ? btn.textContent : "Test hosta";
          renderHostTestResult(null, "⏳ Trwa testowanie...");
          if (btn) {
              btn.disabled = true;
              btn.textContent = "Testowanie...";
          }

          const payload = {
              host: document.getElementById("hostAddress")?.value?.trim() || "",
              user: document.getElementById("hostUser")?.value?.trim() || "",
              ssh_opts: document.getElementById("hostSshOpts")?.value?.trim() || "",
              os_type: document.getElementById("hostOsType")?.value || "linux",
              repo: document.getElementById("hostRepoDir")?.value?.trim() || "",
              python: document.getElementById("hostPythonPath")?.value?.trim() || "",
              profile_root: document.getElementById("hostProfileRoot")?.value?.trim() || "",
              chrome_bin: document.getElementById("hostChromeBin")?.value?.trim() || "",
          };

          try {
              const response = await fetch("/api/settings/remote-host/test", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(payload),
              });
              const data = await response.json().catch(() => ({}));
              if (!response.ok) {
                  renderHostTestResult(data, data.detail || "Błąd testu hosta");
                  showToast("error", "Test hosta", data.detail || "Błąd testu hosta");
                  return;
              }

              renderHostTestResult(data);
              if (data.success) {
                  showToast("success", "Test hosta", "Połączenie SSH i ścieżki są poprawne");
              } else {
                  const failed = Object.entries(data.checks || {})
                      .filter(([, value]) => !(value && value.ok))
                      .map(([key]) => key)
                      .join(", ");
                  showToast("error", "Test hosta", failed ? `Niepowodzenie: ${failed}` : "Test nieudany");
              }
          } catch (e) {
              renderHostTestResult(null, e.message || "Błąd testu hosta");
              showToast("error", "Test hosta", e.message || "Błąd testu hosta");
          } finally {
              if (btn) {
                  btn.textContent = originalText;
              }
              updateHostTestButtonState();
          }
      }

      ["hostAddress", "hostUser", "hostRepoDir", "hostPythonPath"].forEach((id) => {
          const el = document.getElementById(id);
          if (el) {
              el.addEventListener("input", updateHostTestButtonState);
              el.addEventListener("change", updateHostTestButtonState);
          }
      });

      const hostOsTypeEl = document.getElementById("hostOsType");
      if (hostOsTypeEl) {
          hostOsTypeEl.addEventListener("change", onHostOsTypeChanged);
      }

      // File/Directory selection functions
      function _getHostContextForBrowser() {
          // Check if host config modal is visible — if so, browse remote host
          const modal = document.getElementById('hostConfigModal');
          if (modal && modal.classList.contains('visible')) {
              const index = parseInt(document.getElementById('editHostIndex').value);
              const hostId = index >= 0 && remoteHostsData[index]
                  ? remoteHostsData[index].id
                  : null;
              const osType = document.getElementById('hostOsType')?.value || 'linux';
              const hostAddress = document.getElementById('hostAddress')?.value?.trim();
              const hostUser = document.getElementById('hostUser')?.value?.trim();
              const hostSshOpts = document.getElementById('hostSshOpts')?.value?.trim() || '';
              if (hostId) {
                  return { hostId, osType };
              } else if (hostAddress && hostUser) {
                  return { hostId: null, osType, hostAddress, hostUser, hostSshOpts };
              }
          }
          return { hostId: null, osType: 'linux' };  // Local browsing
      }

      function selectDirectory(inputId) {
          const ctx = _getHostContextForBrowser();
          if (!ctx) return;  // Aborted (e.g. unsaved new host)
          openFileBrowser(
              inputId,
              'directory',
              ctx.hostId || null,
              ctx.osType || 'linux',
              ctx.hostAddress || null,
              ctx.hostUser || null,
              ctx.hostSshOpts || '',
          );
      }

      function selectFile(inputId) {
          const ctx = _getHostContextForBrowser();
          if (!ctx) return;
          openFileBrowser(
              inputId,
              'file',
              ctx.hostId || null,
              ctx.osType || 'linux',
              ctx.hostAddress || null,
              ctx.hostUser || null,
              ctx.hostSshOpts || '',
          );
      }

      async function saveHostConfig() {
          const autoDeploy = document.getElementById("hostAutoDeploy").checked;
          const index = parseInt(document.getElementById("editHostIndex").value);
          const hostAddress = document.getElementById("hostAddress").value.trim();
          const user = document.getElementById("hostUser").value.trim();
          const sshOpts = document.getElementById("hostSshOpts").value.trim();

          if (!hostAddress || !user) {
              showToast('error', 'Błąd', 'Uzupełnij wymagane pola (Host i Użytkownik)');
              return;
          }

          if (autoDeploy) {
              // Deploy + Save flow
              await deployAndSaveHost(index, hostAddress, user, sshOpts);
          } else {
              // Simple save flow
              const host = buildHostObject(index, hostAddress, user, sshOpts);
              if (index === -1) {
                  remoteHostsData.push(host);
              } else {
                  remoteHostsData[index] = host;
              }
              renderRemoteHosts();
              closeHostConfigModal();
              await saveRemoteHosts();
          }
      }

      function buildHostObject(index, hostAddress, user, sshOpts) {
          return {
              id: index === -1 ? Date.now().toString() : (remoteHostsData[index]?.id || Date.now().toString()),
              name: document.getElementById("hostName").value.trim(),
              enabled: true,
              roles: {
                  worker: document.getElementById("hostRoleWorker").checked,
                  browser: document.getElementById("hostRoleBrowser").checked
              },
              host: hostAddress,
              user: user,
              ssh: sshOpts,
              osType: document.getElementById("hostOsType").value,
              repo: document.getElementById("hostRepoDir").value.trim(),
              python: document.getElementById("hostPythonPath").value.trim(),
              nasSource: document.getElementById("hostNasSource").value.trim(),
              // Browser Specific
              profileRoot: document.getElementById("hostProfileRoot").value.trim(),
              chrome: document.getElementById("hostChromeBin").value.trim(),
              portBase: parseInt(document.getElementById("hostPortBase").value) || 9222,
              portSpan: parseInt(document.getElementById("hostPortSpan").value) || 100,
              localPortBase: parseInt(document.getElementById("hostLocalPortBase").value) || 18222,
              tunnel: document.getElementById("hostTunnel").checked
          };
      }

      async function deployAndSaveHost(index, hostAddress, user, sshOpts) {
          const osType = document.querySelector('input[name="hostDeployOs"]:checked')?.value || 'ubuntu';
          const hostName = document.getElementById("hostName").value.trim();

          const config = {
              sudo_password: document.getElementById('hostDeploySudoPass').value,
              github_repo: document.getElementById('hostDeployGithubRepo').value.trim(),
              nas_host: document.getElementById('hostDeployNasHost').value.trim(),
              nas_share: document.getElementById('hostDeployNasShare').value.trim(),
              nas_username: document.getElementById('hostDeployNasUser').value.trim(),
              nas_password: document.getElementById('hostDeployNasPass').value,
              install_postgres: document.getElementById('hostDeployPostgres').checked ? 'yes' : 'no'
          };

          // Disable save button during deployment
          const saveBtn = document.getElementById('hostSaveBtn');
          saveBtn.disabled = true;
          saveBtn.textContent = '⏳ Deployment w toku...';

          // Show log container in modal
          const logContainer = document.getElementById('hostDeployLogContainer');
          const logElement = document.getElementById('hostDeployLog');
          logContainer.style.display = 'block';
          logElement.innerHTML = `<span style="color: #4CAF50; font-weight: bold;">🚀 Rozpoczynam deployment na ${hostAddress}...</span>\n<span style="color: #888;">OS: ${osType} | User: ${user}</span>\n\n`;
          logElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

          // Build query string for SSE endpoint
          const params = new URLSearchParams({
              os_type: osType,
              host: hostAddress,
              user: user,
              ssh_opts: sshOpts,
              github_repo: config.github_repo || '',
              nas_host: config.nas_host || '',
              nas_share: config.nas_share || '',
              nas_username: config.nas_username || '',
              nas_password: config.nas_password || '',
              sudo_password: config.sudo_password || '',
              install_postgres: config.install_postgres || 'no'
          });

          try {
              const eventSource = new EventSource(`/api/settings/remote-deployment/deploy-stream?${params.toString()}`);
              let hasCompleted = false;

              eventSource.onmessage = function(event) {
                  try {
                      const data = JSON.parse(event.data);
                      switch(data.type) {
                          case 'status':
                              logElement.innerHTML += `\n<span style="color: #2196F3; font-weight: bold;">${escapeHtml(data.message)}</span>\n`;
                              break;
                          case 'log':
                              logElement.innerHTML += `${escapeHtml(data.message)}\n`;
                              break;
                          case 'warning':
                              logElement.innerHTML += `<span style="color: #FF9800;">⚠️ ${escapeHtml(data.message)}</span>\n`;
                              break;
                          case 'error':
                              logElement.innerHTML += `<span style="color: #f44336; font-weight: bold;">❌ ${escapeHtml(data.message)}</span>\n`;
                              toastHost('error', 'Błąd', data.message, hostAddress);
                              saveBtn.disabled = false;
                              saveBtn.textContent = '🚀 Deployuj & Zapisz';
                              eventSource.close();
                              break;
                          case 'complete':
                              hasCompleted = true;
                              if (data.success) {
                                  logElement.innerHTML += `\n<span style="color: #4CAF50; font-weight: bold; font-size: 1.1em;">${escapeHtml(data.message)}</span>\n`;
                                  toastHost('success', 'Sukces', 'Deployment zakończony pomyślnie!', hostAddress);

                                  // Auto-fill paths for the deployed host
                                  const installDir = `/home/${user}/ocr-dashboard-v3`;
                                  if (!document.getElementById("hostRepoDir").value.trim()) {
                                      document.getElementById("hostRepoDir").value = installDir;
                                  }
                                  if (!document.getElementById("hostPythonPath").value.trim()) {
                                      document.getElementById("hostPythonPath").value = `${installDir}/venv/bin/python3`;
                                  }
                                  if (!document.getElementById("hostChromeBin").value.trim()) {
                                      document.getElementById("hostChromeBin").value = osType === 'arch' ? '/usr/bin/chromium' : '/usr/bin/google-chrome';
                                  }
                                  if (!document.getElementById("hostProfileRoot").value.trim()) {
                                      document.getElementById("hostProfileRoot").value = `${installDir}/chrome-profiles`;
                                  }

                                  // Now save the host
                                  const host = buildHostObject(index, hostAddress, user, sshOpts);
                                  // Update with auto-filled values
                                  host.repo = document.getElementById("hostRepoDir").value.trim();
                                  host.python = document.getElementById("hostPythonPath").value.trim();
                                  host.chrome = document.getElementById("hostChromeBin").value.trim();
                                  host.profileRoot = document.getElementById("hostProfileRoot").value.trim();
                                  host.source = config.nas_host ? '/mnt/nas-scans' : '';

                                  const existingIndex = remoteHostsData.findIndex(h => h.host === hostAddress);
                                  if (existingIndex === -1) {
                                      remoteHostsData.push(host);
                                      logElement.innerHTML += `<span style="color: #2196F3;">\n📋 Dodano "${escapeHtml(host.name || hostAddress)}" do listy hostów</span>\n`;
                                  } else {
                                      remoteHostsData[existingIndex] = host;
                                      logElement.innerHTML += `<span style="color: #888;">\nℹ️ Zaktualizowano konfigurację "${escapeHtml(host.name || hostAddress)}"</span>\n`;
                                  }

                                  saveRemoteHosts().then(() => {
                                      renderRemoteHosts();
                                      logElement.innerHTML += `<span style="color: #4CAF50;">✓ Konfiguracja hosta zapisana</span>\n`;
                                      saveBtn.textContent = '✅ Gotowe';
                                      setTimeout(() => {
                                          saveBtn.disabled = false;
                                          saveBtn.textContent = '🚀 Deployuj & Zapisz';
                                      }, 3000);
                                  }).catch(err => {
                                      logElement.innerHTML += `<span style="color: #FF9800;">⚠️ Nie udało się zapisać: ${escapeHtml(err.message)}</span>\n`;
                                      saveBtn.disabled = false;
                                      saveBtn.textContent = '🚀 Deployuj & Zapisz';
                                  });
                              } else {
                                  logElement.innerHTML += `\n<span style="color: #f44336; font-weight: bold;">${escapeHtml(data.message)}</span>\n`;
                                  toastHost('error', 'Błąd', 'Deployment nie powiódł się', hostAddress);
                                  saveBtn.disabled = false;
                                  saveBtn.textContent = '🚀 Deployuj & Zapisz';
                              }
                              eventSource.close();
                              break;
                      }
                      logElement.scrollTop = logElement.scrollHeight;
                  } catch (e) {
                      console.error('Error parsing SSE data:', e, event.data);
                  }
              };

              eventSource.onerror = function(error) {
                  console.error('SSE Error:', error);
                  if (!hasCompleted) {
                      logElement.innerHTML += `\n<span style="color: #f44336;">❌ Połączenie przerwane - sprawdź logi serwera</span>\n`;
                      toastHost('warning', 'Uwaga', 'Połączenie przerwane', hostAddress);
                  }
                  saveBtn.disabled = false;
                  saveBtn.textContent = '🚀 Deployuj & Zapisz';
                  eventSource.close();
              };
          } catch (error) {
              logElement.innerHTML += `\n<span style="color: #f44336;">❌ BŁĄD POŁĄCZENIA: ${escapeHtml(error.message)}</span>\n`;
              toastHost('error', 'Błąd', `Błąd: ${error.message}`, hostAddress);
              saveBtn.disabled = false;
              saveBtn.textContent = '🚀 Deployuj & Zapisz';
          }
      }

      // ============================================
      // Profile Actions (Login, Delete)
      // ============================================

      let loginLogInterval = null;

      async function loginProfile(profileName) {
        showToast(
          "info",
          "Logowanie...",
          `Otwieranie logowania dla ${profileName}`,
        );

        // Open Modal
        document.getElementById("loginLogProfileName").textContent =
          profileName;
        const logContent = document.getElementById("loginLogContent");
        logContent.textContent =
          "Inicjalizacja procesu logowania...\nOczekiwanie na uruchomienie procesu...";
        document.getElementById("loginLogModal").classList.add("visible");

        // Start polling logs immediately
        if (loginLogInterval) clearInterval(loginLogInterval);
        loginLogInterval = setInterval(() => fetchLoginLog(profileName), 1000);

        try {
          const response = await fetch("/api/profiles/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: profileName }),
          });

          if (response.ok) {
            showToast("success", "Uruchomiono", "Proces logowania wystartował");
          } else {
            const data = await response.json();
            showToast(
              "error",
              "Błąd",
              data.detail || "Nie można uruchomić procesu logowania",
            );
            logContent.textContent += `\n\n[BŁĄD API]: ${data.detail}`;
          }
        } catch (e) {
          showToast("error", "Błąd", e.message);
          logContent.textContent += `\n\n[BŁĄD SIECI]: ${e.message}`;
        }
      }

      async function fetchLoginLog(profileName) {
        try {
          const res = await fetch(
            `/api/profiles/login/log?name=${profileName}&tail=200`,
          );
          if (res.ok) {
            const data = await res.json();
            if (data.log) {
              const el = document.getElementById("loginLogContent");
              // Only update/scroll if content changed substantially or first load
              if (el.textContent.length !== data.log.length) {
                el.textContent = data.log;
                el.scrollTop = el.scrollHeight;
              }
            }
          }
        } catch (e) {
          console.warn("Failed to poll login log", e);
        }
      }

      function closeLoginLogModal() {
        document.getElementById("loginLogModal").classList.remove("visible");
        if (loginEventSource) {
          loginEventSource.close();
          loginEventSource = null;
        }
      }

      function copyLoginLogs() {
        const content = document.getElementById("loginLogContent").innerText;
        const btn = document.getElementById("copyLoginLogsBtn");
        const originalContent = btn.innerHTML;
        
        navigator.clipboard.writeText(content).then(() => {
            btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg> Skopiowano!';
            btn.classList.add('btn-success');
            btn.classList.remove('btn-primary');
            
            setTimeout(() => {
                btn.innerHTML = originalContent;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-primary');
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy logs: ', err);
            showToast("error", "Błąd", "Nie udało się skopiować logów");
        });
      }

      let profileToDelete = null;
      let profileToReset = null;

      function deleteProfileConfirm(profileName) {
        profileToDelete = profileName;
        document.getElementById("deleteProfileName").textContent = profileName;
        const confirmBtn = document.getElementById("deleteProfileConfirmBtn");
        const blockedMsg = document.getElementById("deleteProfileBlockedMsg");
        if (profileName === "default") {
          if (blockedMsg) blockedMsg.style.display = "";
          if (confirmBtn) confirmBtn.disabled = true;
        } else {
          if (blockedMsg) blockedMsg.style.display = "none";
          if (confirmBtn) confirmBtn.disabled = false;
        }
        document.getElementById("deleteModal").classList.add("visible");
      }

      function closeDeleteModal() {
        profileToDelete = null;
        const confirmBtn = document.getElementById("deleteProfileConfirmBtn");
        const blockedMsg = document.getElementById("deleteProfileBlockedMsg");
        if (blockedMsg) blockedMsg.style.display = "none";
        if (confirmBtn) confirmBtn.disabled = false;
        document.getElementById("deleteModal").classList.remove("visible");
      }

      async function confirmDeleteProfile() {
        if (!profileToDelete) return;
        if (profileToDelete === "default") {
          showToast("warning", "Brak uprawnień", "Nie można usunąć profilu domyślnego");
          return;
        }

        try {
          const response = await fetch(`/api/profiles/${profileToDelete}`, {
            method: "DELETE",
          });
          if (response.ok) {
            showToast(
              "success",
              "Usunięto",
              `Profil ${profileToDelete} został usunięty`,
            );
            closeDeleteModal();
            location.reload();
          } else {
            const data = await response.json();
            showToast(
              "error",
              "Błąd",
              data.detail || "Nie można usunąć profilu",
            );
          }
        } catch (e) {
          showToast("error", "Błąd", e.message);
        }
      }

      function resetProfileConfirm(profileName) {
        profileToReset = profileName;
        if (!profileToReset) return;
        confirmResetProfile();
      }

      async function confirmResetProfile() {
        if (!profileToReset) return;
        try {
          markManualStop(profileToReset, 120000);
        } catch (e) {}

        try {
          const response = await fetch(
            `/api/profiles/${profileToReset}/reset`,
            {
              method: "POST",
            },
          );
          if (response.ok) {
            clearProfileLastStartTime(profileToReset);
            showToast(
              "success",
              "Zresetowano",
              `Profil ${profileToReset} został zresetowany`,
            );
            profileToReset = null;
            refreshData({ showSpinner: false });
          } else {
            const data = await response.json();
            showToast(
              "error",
              "Błąd",
              data.detail || "Nie można zresetować profilu",
            );
            profileToReset = null;
          }
        } catch (e) {
          showToast("error", "Błąd", e.message);
          profileToReset = null;
        }
      }

      // ============================================
      // Session Expired Banner
      // ============================================

      function hideSessionBanner() {
        document.getElementById("sessionExpiredBanner").classList.add("hidden");
      }

      function showSessionExpired(profiles) {
        if (profiles && profiles.length > 0) {
          document.getElementById("expiredProfilesList").textContent =
            profiles.join(", ");
          document
            .getElementById("sessionExpiredBanner")
            .classList.remove("hidden");
        }
      }


      // ============================================
      // Live Preview
      // ============================================

      let previewAutoRefreshInterval = null;
      let latestPreviews = [];
      let previewViewMode = "grid";
      const PREVIEW_SETTINGS_KEY = "previewSettings";

      function loadPreviewSettings() {
        try {
          const raw = localStorage.getItem(PREVIEW_SETTINGS_KEY);
          return raw ? JSON.parse(raw) : {};
        } catch (e) {
          return {};
        }
      }

      function savePreviewSettings(patch) {
        try {
          const current = loadPreviewSettings();
          localStorage.setItem(
            PREVIEW_SETTINGS_KEY,
            JSON.stringify({ ...current, ...patch }),
          );
        } catch (e) {}
      }

      function renderPreviewGrid() {
        const grid = document.getElementById("livePreviewGrid");
        const emptyState = document.getElementById("previewEmptyState");
        const query =
          document.getElementById("previewSearch")?.value?.trim().toLowerCase() || "";
        const activeOnlyInput = document.getElementById("previewActiveOnly");
        const activeOnly = activeOnlyInput?.checked;
        const activeMinutes = parseInt(
          document.getElementById("previewActiveMinutes")?.value || "0",
        );
        const sortMode = document.getElementById("previewSort")?.value || "newest";
        const now = Date.now();
        const activeOnlyEffective = sortMode === "fresh" ? true : activeOnly;

        let filtered = latestPreviews.filter((p) =>
          (p.profile || "").toLowerCase().includes(query),
        );

        if (activeOnlyEffective && activeMinutes > 0) {
          const activeProfiles = new Set(
            (profilesData || [])
              .filter((p) => ["active", "starting"].includes((p.status || "").toLowerCase()))
              .map((p) => (p.name || "").toLowerCase()),
          );
          filtered = filtered.filter((p) => {
            const ts = (p.updated_at_ts || 0) * 1000;
            if (activeProfiles.has((p.profile || "").toLowerCase())) {
              return true;
            }
            if (!ts) return false;
            return now - ts <= activeMinutes * 60 * 1000;
          });
        }

        filtered.sort((a, b) => {
          if (sortMode === "name") {
            return (a.profile || "").localeCompare(b.profile || "");
          }
          const ta = (a.updated_at_ts || 0);
          const tb = (b.updated_at_ts || 0);
          if (sortMode === "oldest") return ta - tb;
          return tb - ta;
        });

        const countEl = document.getElementById("previewCount");
        if (countEl) {
          countEl.textContent = filtered.length
            ? `Widoczne: ${filtered.length}`
            : "";
        }

        if (!filtered.length) {
          grid.innerHTML = "";
          grid.appendChild(emptyState);
          emptyState.classList.remove("hidden");
          return;
        }

        emptyState.classList.add("hidden");
        grid.classList.toggle("preview-list", previewViewMode === "list");
        // lgtm[js/xss]
        // deepcode ignore DOMXSS: innerHTML construction uses escaped values
        grid.innerHTML = filtered
          .map((p) => {
            const ts = (p.updated_at_ts || 0) * 1000;
            const updated = ts ? new Date(ts).toLocaleString() : (p.updated_at || "-");
            const ageMin = ts ? Math.max(0, Math.round((now - ts) / 60000)) : null;
            const ageLabel = ageMin === null ? "-" : `${ageMin} min temu`;
            if (previewViewMode === "list") {
              return `
                <div class="preview-list-item">
                  <div class="preview-list-media" role="button" tabindex="0" onclick="openImagePreview(this.dataset.url, this.dataset.profile)" onkeypress="if(event.key === 'Enter') openImagePreview(this.dataset.url, this.dataset.profile)" data-url="${escapeHtml(p.image_url)}" data-profile="${escapeHtml(p.profile)}">
                    <img src="${escapeHtml(p.image_url)}?t=${Date.now()}" alt="${escapeHtml(p.profile)}" onerror="this.src='/static/placeholder.png'">
                  </div>
                  <div class="preview-list-meta">
                    <div class="preview-list-title">
                      <span class="preview-profile">${escapeHtml(p.profile)}</span>
                      <span class="badge badge-${p.status === "active" ? "success" : "neutral"}">${escapeHtml(p.status)}</span>
                    </div>
                    <div class="preview-list-stats">
                      <span class="text-secondary">Aktualizacja: ${escapeHtml(updated)}</span>
                      <span class="text-secondary">Świeżość: ${escapeHtml(ageLabel)}</span>
                    </div>
                  </div>
                </div>
              `;
            }
            return `
                  <div class="preview-card">
                      <div class="preview-header">
                          <span class="preview-profile">${escapeHtml(p.profile)}</span>
                          <span class="badge badge-${p.status === "active" ? "success" : "neutral"}">${escapeHtml(p.status)}</span>
                      </div>
                      <div class="preview-image-container" role="button" tabindex="0" onclick="openImagePreview(this.dataset.url, this.dataset.profile)" onkeypress="if(event.key === 'Enter') openImagePreview(this.dataset.url, this.dataset.profile)" data-url="${escapeHtml(p.image_url)}" data-profile="${escapeHtml(p.profile)}">
                          <img src="${escapeHtml(p.image_url)}?t=${Date.now()}" alt="${escapeHtml(p.profile)}" class="preview-image" onerror="this.src='/static/placeholder.png'">
                      </div>
                      <div class="preview-footer">
                          <span class="text-secondary" style="font-size: 11px;">${escapeHtml(updated)} • ${escapeHtml(ageLabel)}</span>
                      </div>
                  </div>
              `;
          })
          .join("");
      }

      async function refreshLivePreviewAll() {
        const btn = document.getElementById("previewRefreshBtn");
        btn.disabled = true;

        try {
          const response = await fetch("/api/live-preview");
          const data = await response.json();

          latestPreviews = data.previews || [];
          renderPreviewGrid();
        } catch (e) {
          console.error("Failed to refresh live preview:", e);
        } finally {
          btn.disabled = false;
        }
      }

      function togglePreviewAutoRefresh() {
        const enabled = document.getElementById("previewAutoRefresh").checked;
        if (enabled) {
          refreshLivePreviewAll();
          previewAutoRefreshInterval = setInterval(
            refreshLivePreviewAll,
            10000,
          );
        } else {
          if (previewAutoRefreshInterval) {
            clearInterval(previewAutoRefreshInterval);
            previewAutoRefreshInterval = null;
          }
        }
      }

      function openImagePreview(url, profile) {
        document.getElementById("imagePreviewImg").src = url;
        document.getElementById("imagePreviewInfo").textContent = profile;
        document.getElementById("imagePreviewModal").classList.add("visible");
      }

      function closeImagePreview() {
        document
          .getElementById("imagePreviewModal")
          .classList.remove("visible");
      }

      // ============================================
      // Cleanup Modal
      // ============================================

      function openCleanupModal() {
        document.getElementById("cleanupModal").classList.add("visible");
        document.getElementById("cleanupStatus").textContent = "";
      }

      function closeCleanupModal() {
        document.getElementById("cleanupModal").classList.remove("visible");
      }



      // ============================================
      // Restart App
      // ============================================

      let currentRestartScope = 'all';

      function toggleRestartDropdown() {
        const menu = document.getElementById('restartDropdownMenu');
        menu.classList.toggle('show');
        
        // Close dropdown when clicking outside
        if (menu.classList.contains('show')) {
          setTimeout(() => {
            document.addEventListener('click', closeRestartDropdownOnClickOutside);
          }, 0);
        }
      }

      function closeRestartDropdownOnClickOutside(e) {
        const dropdown = document.getElementById('restartDropdown');
        if (!dropdown.contains(e.target)) {
          document.getElementById('restartDropdownMenu').classList.remove('show');
          document.removeEventListener('click', closeRestartDropdownOnClickOutside);
        }
      }

      function updateRestartButtonState() {
        const btnLabel = document.getElementById('restartButtonLabel');
        const btnLabels = {
          'all': 'Restart',
          'web': 'Web',
          'workers': 'Workery',
          'cleanup': 'Cleanup',
          'all_clean': 'Full Reset'
        };
        if (btnLabel && btnLabels[currentRestartScope]) {
          btnLabel.textContent = btnLabels[currentRestartScope];
        }
      }

      function setRestartOption(scope) {
        currentRestartScope = scope;
        try { localStorage.setItem('restartScope', scope); } catch(e){}
        updateRestartButtonState();
        document.getElementById('restartDropdownMenu').classList.remove('show');
        
        if (scope === 'cleanup') {
            openCleanupModal();
        } else {
            restartAppConfirm(scope);
        }
      }

      function restartAppConfirm(scope) {
        if (scope) {
          currentRestartScope = scope;
        }
        
        // Handle standalone actions
        if (currentRestartScope === 'cleanup') {
            openCleanupModal();
            updateRestartButtonState();
            return;
        }

        // Update main button label
        updateRestartButtonState();
        document.getElementById('restartDropdownMenu').classList.remove('show');
        
        // Update modal message based on scope
        const modal = document.getElementById('restartModal');
        const scopeLabels = {
          'all': 'całą aplikację (Web + Workery)',
          'web': 'tylko serwer Web',
          'workers': 'tylko Workery OCR',
          'all_clean': 'PEŁNY RESET z czyszczeniem'
        };
        const scopeDescriptions = {
          'all': 'Wszystkie aktywne joby zostaną zatrzymane. Strona zostanie automatycznie odświeżona po restarcie.',
          'web': 'Serwer web zostanie zrestartowany. Workery OCR pozostaną uruchomione.',
          'workers': 'Workery OCR zostaną zatrzymane. Możesz uruchomić je ponownie ręcznie. Auto-restart dotyczy tylko błędów w ramach bieżącej sesji.',
          'all_clean': 'UWAGA: Zostaną usunięte logi, dane jobów oraz pliki tymczasowe. Aplikacja zostanie zrestartowana.'
        };
        
        modal.querySelector('.modal-body p:first-child').textContent = 
          `Czy na pewno chcesz zrestartować ${scopeLabels[currentRestartScope]}?`;
        modal.querySelector('.modal-body p:last-child').textContent = scopeDescriptions[currentRestartScope];
        
        modal.classList.add('visible');
      }

      function closeRestartModal() {
        document.getElementById("restartModal").classList.remove("visible");
      }

      function closeRestartReportModal() {
        document.getElementById("restartReportModal").classList.remove("visible");
      }

      function renderRestartStatusBadge(status) {
        const labels = {
          ok: "OK",
          failed: "Błąd",
          unreachable: "Nieosiągalny",
          scheduled: "Zaplanowany",
        };
        const colors = {
          ok: "#22c55e",
          failed: "#ef4444",
          unreachable: "#f59e0b",
          scheduled: "#3b82f6",
        };
        const label = labels[status] || "Nieznany";
        const color = colors[status] || "#94a3b8";
        return `
          <span style="
            display: inline-block;
            min-width: 110px;
            padding: 4px 8px;
            border-radius: 999px;
            background: ${color}22;
            color: ${color};
            font-weight: 600;
            font-size: 12px;
            text-align: center;
          ">${label}</span>
        `;
      }

      function showRestartReport(payload) {
        const summary = payload?.summary || {};
        const results = Array.isArray(payload?.results) ? payload.results : [];
        const summaryText = `OK: ${summary.ok || 0} | Błąd: ${summary.failed || 0} | Nieosiągalne: ${summary.unreachable || 0} | Zaplanowane: ${summary.scheduled || 0}`;

        const summaryEl = document.getElementById("restartReportSummary");
        if (summaryEl) {
          summaryEl.textContent = summaryText;
        }

        const listEl = document.getElementById("restartReportList");
        if (listEl) {
          listEl.innerHTML = results
            .map((item) => {
              const name = escapeHtml(item?.name || "Host");
              const message = escapeHtml(item?.message || "");
              return `
                <div style="display: flex; gap: 12px; align-items: center; padding: 6px 0;">
                  ${renderRestartStatusBadge(item?.status)}
                  <div>
                    <div style="font-weight: 600;">${name}</div>
                    <div style="font-size: 12px; color: #94a3b8;">${message}</div>
                  </div>
                </div>
              `;
            })
            .join("");
        }

        document.getElementById("restartReportModal").classList.add("visible");
      }

      async function confirmRestartApp() {
        let scope = currentRestartScope;
        closeRestartModal();
        
        // Special case for all_clean
        let performCleanup = false;
        if (scope === 'all_clean') {
            performCleanup = true;
            scope = 'all'; // downgrade to 'all' for the restart endpoint
        }

        // When stopping workers (workers/all/full reset), treat current runs as expected stops.
        // This prevents Auto-restart from fighting an intentional reset.
        try {
          if (scope === "workers" || scope === "all") {
            const runningNow = (profilesData || []).filter((p) =>
              ["active", "starting", "stopping"].includes(p.status),
            );
            runningNow.forEach((p) => markManualStop(p.name, 120000));
          }
          if (performCleanup) {
            clearAllLastStartTimes();
          }
        } catch (e) {
          // Best-effort only; never block restart flow.
        }

        // For workers-only restart, don't show reload overlay
        if (scope === 'workers') {
          showToast('info', 'Restartowanie...', 'Zatrzymywanie workerów OCR');
          try {
            const response = await fetch(`/api/restart?scope=workers`, { method: 'POST' });
            if (response.ok) {
              showToast('success', 'Sukces', 'Workery OCR zostały zatrzymane');
              refreshData();
            } else {
              showToast('error', 'Błąd', 'Nie udało się zatrzymać workerów');
            }
          } catch (e) {
            showToast('error', 'Błąd', e.message);
          }
          return;
        }
        
        // For web or all restart, show loading overlay
        const overlay = document.createElement('div');
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(15, 23, 42, 0.95);
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          z-index: 10000;
          backdrop-filter: blur(8px);
        `;
        
        const scopeText = scope === 'web'
          ? 'serwera Web'
          : (performCleanup ? 'wszystkich hostów (pełny reset)' : 'aplikacji');
        overlay.innerHTML = `
          <div style="text-align: center; color: #e2e8f0;">
            <div style="
              width: 64px;
              height: 64px;
              border: 4px solid #334155;
              border-top-color: #3b82f6;
              border-radius: 50%;
              animation: spin 1s linear infinite;
              margin: 0 auto 24px;
            "></div>
            <h2 style="font-size: 24px; font-weight: 600; margin: 0 0 12px 0;">
              Restartowanie ${scopeText}...
            </h2>
            <p style="font-size: 16px; color: #94a3b8; margin: 0;">
              Proszę czekać, strona odświeży się automatycznie
            </p>
          </div>
          <style>
            @keyframes spin {
              to { transform: rotate(360deg); }
            }
          </style>
        `;
        
        document.body.appendChild(overlay);

        // Maximum wait time: 30 seconds
        const maxWaitTime = performCleanup ? 60000 : 30000;
        const startTime = Date.now();

        // Start polling immediately (don't block on /api/restart)
        const checkAndReload = async () => {
          if (Date.now() - startTime > maxWaitTime) {
            markReloadOverlayPending();
            reloadWithCacheBust();
            return;
          }

          try {
            const health = await fetchWithTimeout('/api/health', { 
              cache: 'no-cache',
              headers: { 'Cache-Control': 'no-cache' }
            }, 3000);
            if (health.ok) {
              markReloadOverlayPending();
              reloadWithCacheBust();
              return;
            }
          } catch {
            // Ignore and retry
          }

          setTimeout(checkAndReload, 1000);
        };

        setTimeout(checkAndReload, 2000);

        // Fire restart request with a short timeout to avoid hanging UI
        try {
          const controller = new AbortController();
          const requestTimeout = performCleanup ? 35000 : 10000;
          const timeoutId = setTimeout(() => controller.abort(), requestTimeout);

          let response;
          if (performCleanup) {
            response = await fetch(`/api/restart/all`, {
              method: "POST",
              signal: controller.signal
            });
          } else {
            const cleanupFlag = "0";
            response = await fetch(`/api/restart?scope=${scope}&cleanup=${cleanupFlag}`, {
              method: "POST",
              signal: controller.signal
            });
          }

          clearTimeout(timeoutId);

          if (!response.ok) {
            const data = await response.json().catch(() => ({}));
            showToast(
              "warning",
              "Restart w toku",
              data.detail || "Nie udało się potwierdzić restartu, czekam na powrót aplikacji",
            );
          } else if (performCleanup) {
            const data = await response.json().catch(() => ({}));
            if (data && Object.keys(data).length > 0) {
              showRestartReport(data);
              showToast("success", "Full Reset", "Uruchomiono reset na wszystkich hostach");
            }
          }
        } catch (e) {
          if (e.name !== "AbortError") {
            showToast(
              "warning",
              "Restart w toku",
              "Brak potwierdzenia restartu, czekam na powrót aplikacji",
            );
          }
        }
      }

      // ============================================
      // Add Profile Modal
      // ============================================

      function openAddProfileModal() {
        document.getElementById("newProfileName").value = "";
        document.getElementById("addProfileModal").classList.add("visible");
      }

      function closeAddProfileModal() {
        document.getElementById("addProfileModal").classList.remove("visible");
      }

      async function confirmAddProfile() {
        const name = document.getElementById("newProfileName").value.trim();
        if (!name) {
          showToast("error", "Błąd", "Podaj nazwę profilu");
          return;
        }

        try {
          const response = await fetch("/api/profiles", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name }),
          });

          if (response.ok) {
            showToast("success", "Dodano", `Profil ${name} został utworzony`);
            closeAddProfileModal();
            location.reload();
          } else {
            const data = await response.json();
            showToast(
              "error",
              "Błąd",
              data.detail || "Nie można dodać profilu",
            );
          }
        } catch (e) {
          showToast("error", "Błąd", e.message);
        }
      }

      // ============================================
      // Non-Pro Banner
      // ============================================

      function hideNonProBanner() {
        document.getElementById("nonProBanner").classList.add("hidden");
      }

      function showNonProBanner(count, profiles) {
        if (count > 0) {
          document.getElementById("nonProCount").textContent = count;
          document.getElementById("nonProProfiles").textContent =
            profiles.join(", ");
          document.getElementById("nonProBanner").classList.remove("hidden");
        }
      }

      // ============================================
      // Sort Profiles
      // ============================================

      function sortJobProfiles(direction) {
        const container = document.getElementById("jobProfilesList");
        const labels = Array.from(container.querySelectorAll("label"));
        labels.sort((a, b) => {
          const nameA = a.querySelector("input").value.toLowerCase();
          const nameB = b.querySelector("input").value.toLowerCase();
          return direction === "asc"
            ? nameA.localeCompare(nameB)
            : nameB.localeCompare(nameA);
        });
        labels.forEach((label) => container.appendChild(label));
      }

      // ============================================
      // Select OK Limit Profiles
      // ============================================

      async function selectOkLimitJobProfiles() {
        try {
          const response = await fetch("/api/limits/status");
          const data = await response.json();
          const okProfiles = new Set();

          // Get profiles with OK status from last check
          if (data.status?.results) {
            data.status.results.forEach((r) => {
              if (r.status === "OK") {
                okProfiles.add(r.profile);
              }
            });
          }

          // Also check last_any for profiles without limit
          if (data.last_any) {
            Object.entries(data.last_any).forEach(([profile, info]) => {
              if (info.status === "OK") {
                okProfiles.add(profile);
              }
            });
          }

          document
            .querySelectorAll('#jobProfilesList input[type="checkbox"]')
            .forEach((cb) => {
              cb.checked = okProfiles.has(cb.value);
            });

          showToast(
            "info",
            "Wybrano",
            `Zaznaczono ${okProfiles.size} profili z OK`,
          );
        } catch (e) {
          showToast("error", "Błąd", "Nie można pobrać statusu limitów");
        }
      }

      // Add to DOMContentLoaded
      document.addEventListener("DOMContentLoaded", function () {
         loadRemoteHosts();
        // Restore restart scope
        try {
            const savedScope = localStorage.getItem('restartScope');
            if (savedScope) {
                currentRestartScope = savedScope;
                // Wait for DOM to assume elements are ready (they are inside this block's execution time)
                updateRestartButtonState();
            }
        } catch(e) {}

        // [Refactor] Merged initialization logic
        loadExecutionModes();
        loadDefaultSourcePath();
        refreshData();
        setInterval(() => refreshData({ showSpinner: false }), 1000);
        initProfilesTableInteractions();
        filterProfiles();
        // Initialize language
        currentLang = localStorage.getItem("ocr-dashboard-lang") || "pl";
        document.documentElement.lang = currentLang;
        applyTranslations();
        updateLanguageButtons();

        loadAutoRestartSetting();
        loadX11Display();
        ensureLimitSelection();
        const previewSettings = loadPreviewSettings();
        const previewSearch = document.getElementById("previewSearch");
        if (previewSearch) {
          if (typeof previewSettings.query === "string") {
            previewSearch.value = previewSettings.query;
          }
          previewSearch.addEventListener("input", () => {
            savePreviewSettings({ query: previewSearch.value || "" });
            renderPreviewGrid();
          });
        }
        const previewActiveOnly = document.getElementById("previewActiveOnly");
        if (previewActiveOnly) {
          if (typeof previewSettings.activeOnly === "boolean") {
            previewActiveOnly.checked = previewSettings.activeOnly;
          }
          previewActiveOnly.addEventListener("change", () => {
            savePreviewSettings({ activeOnly: previewActiveOnly.checked });
            renderPreviewGrid();
          });
        }
        const previewActiveMinutes = document.getElementById("previewActiveMinutes");
        if (previewActiveMinutes) {
          if (previewSettings.activeMinutes) {
            previewActiveMinutes.value = previewSettings.activeMinutes;
          }
          previewActiveMinutes.addEventListener("input", () => {
            savePreviewSettings({ activeMinutes: previewActiveMinutes.value || "10" });
            renderPreviewGrid();
          });
        }
        const previewSort = document.getElementById("previewSort");
        if (previewSort) {
          if (previewSettings.sortMode) {
            previewSort.value = previewSettings.sortMode;
          }
          previewSort.addEventListener("change", () => {
            if (previewSort.value === "fresh") {
              const activeOnlyBox = document.getElementById("previewActiveOnly");
              if (activeOnlyBox) activeOnlyBox.checked = true;
            }
            savePreviewSettings({ sortMode: previewSort.value });
            renderPreviewGrid();
          });
        }
        const previewToggle = document.getElementById("previewViewToggle");
        if (previewToggle) {
          if (previewSettings.viewMode) {
            previewViewMode = previewSettings.viewMode;
            previewToggle
              .querySelectorAll(".segmented-btn")
              .forEach((b) =>
                b.classList.toggle("active", b.dataset.view === previewViewMode),
              );
          }
          previewToggle.addEventListener("click", (e) => {
            const btn = e.target.closest("button[data-view]");
            if (!btn) return;
            previewViewMode = btn.dataset.view;
            previewToggle
              .querySelectorAll(".segmented-btn")
              .forEach((b) => b.classList.toggle("active", b === btn));
            savePreviewSettings({ viewMode: previewViewMode });
            renderPreviewGrid();
          });
        }

        // Load preview when switching to preview tab
        document
          .querySelector('[data-tab="preview"]')
          ?.addEventListener("click", () => {
            setTimeout(refreshLivePreviewAll, 100);
          });
      });

      // Add spin animation for refresh icon
      const style = document.createElement("style");
      style.textContent = `
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
      document.head.appendChild(style);
      function copyFromElement(elementId, btn) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        // Use innerText to get newlines correctly, but fallback to textContent
        const text = element.innerText || element.textContent;
        const originalContent = btn.innerHTML;
        const originalClass = btn.className;
        
        navigator.clipboard.writeText(text).then(() => {
            btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg> Skopiowano!';
            btn.classList.add('btn-success');
            // Remove primary/secondary classes temporarily to show success color clearly if needed
            // But usually adding btn-success is enough if it overrides.
            
            setTimeout(() => {
                btn.innerHTML = originalContent;
                btn.className = originalClass;
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy: ', err);
            showToast("error", "Błąd", "Nie udało się skopiować treści");
        });
      }

      // ============================================
      // Host Deploy Section helpers (integrated in modal)
      // ============================================
      function toggleHostDeploySection() {
          const checked = document.getElementById('hostAutoDeploy').checked;
          document.getElementById('hostDeploySection').style.display = checked ? 'block' : 'none';
          document.getElementById('hostSaveBtn').textContent = checked ? '🚀 Deployuj & Zapisz' : 'Zapisz';
      }

      function copyHostDeployLogs() {
          const log = document.getElementById('hostDeployLog');
          if (!log) return;
          navigator.clipboard.writeText(log.textContent).then(() => {
              showToast('success', 'Sukces', 'Logi skopiowane do schowka');
          }).catch(err => {
              console.error('Failed to copy logs:', err);
              showToast('error', 'Błąd', 'Nie udało się skopiować logów');
          });
      }

      // toastHost is defined earlier in the file (uses resolveHostLabel)

      // Password visibility toggle
      function togglePasswordVisibility(inputId, button) {
          const input = document.getElementById(inputId);
          const svg = button.querySelector('svg');
          
          if (input.type === 'password') {
              input.type = 'text';
              // Change to eye-off icon
              svg.innerHTML = `
                  <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                  <line x1="1" y1="1" x2="23" y2="23"/>
              `;
          } else {
              input.type = 'password';
              // Change back to eye icon
              svg.innerHTML = `
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                  <circle cx="12" cy="12" r="3"/>
              `;
          }
      }

      // Chrome Profile Sync Functions
      async function loadSourceProfiles() {
          const profileSelect = document.getElementById('syncProfileName');
          profileSelect.innerHTML = '<option value="">Ładowanie profili...</option>';
          
          try {
              const response = await fetch('/api/settings/profile-sync/list-profiles');
              const result = await response.json();
              
              if (result.profiles && result.profiles.length > 0) {
                  profileSelect.innerHTML = '';
                  const profiles = [...result.profiles].sort((a, b) => {
                      const nameA = (a?.name || '').toLowerCase();
                      const nameB = (b?.name || '').toLowerCase();
                      return nameA.localeCompare(nameB, 'pl');
                  });
                  profiles.forEach(profile => {
                      const sizeStr = profile.size_mb ? ` (${profile.size_mb.toFixed(1)} MB)` : '';
                      const option = document.createElement('option');
                      option.value = profile.name;
                      option.textContent = `${profile.name}${sizeStr}`;
                      profileSelect.appendChild(option);
                  });
              } else {
                  profileSelect.innerHTML = '<option value="">Brak profili</option>';
              }
          } catch (error) {
              console.error('Error loading profiles:', error);
              profileSelect.innerHTML = '<option value="">Błąd ładowania profili</option>';
          }
      }
      
      async function populateTargetHosts() {
          const targetHostSelect = document.getElementById('syncTargetHost');
          if (!targetHostSelect) return;
          
          // Wait for remoteHostsData to be loaded if empty
          if (remoteHostsData.length === 0) {
              targetHostSelect.innerHTML = '<option value="">Ładowanie hostów...</option>';
              await loadRemoteHosts();
          }
          
          // Filter out localhost and use remoteHostsData directly
          const remoteHosts = remoteHostsData.filter(h => h.host && h.host !== '127.0.0.1' && h.host !== 'localhost');
          
          if (remoteHosts.length > 0) {
              targetHostSelect.innerHTML = '<option value="">Wybierz host...</option>';
              remoteHosts.forEach(host => {
                  const option = document.createElement('option');
                  option.value = host.host;
                  option.textContent = host.name || host.host;
                  option.dataset.user = host.user || 'tomaasz';
                  targetHostSelect.appendChild(option);
              });
              
              // Auto-fill user when host changes
              targetHostSelect.onchange = function() {
                  const selected = this.options[this.selectedIndex];
                  if (selected && selected.dataset.user) {
                      document.getElementById('syncTargetUser').value = selected.dataset.user;
                  }
              };
          } else {
              targetHostSelect.innerHTML = '<option value="">Brak hostów zdalnych</option>';
          }
      }
      
      async function syncChromeProfile(event) {
          event.preventDefault();
          
          const sourceHost = document.getElementById('syncSourceHost').value;
          const profileName = document.getElementById('syncProfileName').value;
          const targetHost = document.getElementById('syncTargetHost').value;
          const targetUser = document.getElementById('syncTargetUser').value.trim();
          
          if (!profileName) {
              showToast('error', 'Błąd', 'Wybierz profil do synchronizacji');
              return;
          }
          if (!targetHost) {
              showToast('error', 'Błąd', 'Wybierz host docelowy');
              return;
          }
          if (!targetUser) {
              showToast('error', 'Błąd', 'Podaj użytkownika SSH');
              return;
          }
          
          const resultDiv = document.getElementById('profileSyncResult');
          const logDiv = document.getElementById('profileSyncLog');
          const btn = document.getElementById('syncProfileBtn');
          
          resultDiv.style.display = 'block';
          logDiv.innerHTML = `<span style="color: #4CAF50;">🔄 Synchronizuję profil ${profileName} na ${targetHost}...</span>\n`;
          btn.disabled = true;
          btn.innerHTML = '<span class="loading-spinner"></span> Synchronizacja...';
          
          try {
              const response = await fetch('/api/settings/profile-sync', {
                  method: 'POST',
                  headers: {'Content-Type': 'application/json'},
                  body: JSON.stringify({
                      source_host: sourceHost,
                      target_host: targetHost,
                      target_user: targetUser,
                      profile_name: profileName
                  })
              });
              
              const result = await response.json();
              
              if (result.success) {
                  logDiv.innerHTML += `<span style="color: #4CAF50;">✅ ${escapeHtml(result.message)}</span>\n`;
                  if (result.details) {
                      logDiv.innerHTML += `<span style="color: #888;">${escapeHtml(result.details)}</span>\n`;
                  }
                  toastHost('success', 'Sukces', 'Profil zsynchronizowany!', targetHost);
              } else {
                  logDiv.innerHTML += `<span style="color: #f44336;">❌ ${escapeHtml(result.detail || result.message || 'Błąd synchronizacji')}</span>\n`;
                  toastHost('error', 'Błąd', result.detail || 'Synchronizacja nie powiodła się', targetHost);
              }
          } catch (error) {
              logDiv.innerHTML += `<span style="color: #f44336;">❌ Błąd połączenia: ${escapeHtml(error.message)}</span>\n`;
              toastHost('error', 'Błąd', `Błąd: ${error.message}`, targetHost);
          } finally {
              btn.disabled = false;
              btn.innerHTML = `
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M17 1l4 4-4 4"/>
                      <path d="M3 11V9a4 4 0 0 1 4-4h14"/>
                      <path d="M7 23l-4-4 4-4"/>
                      <path d="M21 13v2a4 4 0 0 1-4 4H3"/>
                  </svg>
                  Synchronizuj profil
              `;
          }
      }
      
      // Load profile sync data on page load (for Settings tab)
      document.addEventListener('DOMContentLoaded', function() {
          // These will be called when settings tab is shown
          if (window.location.hash === '#settings') {
              loadSourceProfiles();
              populateTargetHosts();
          }
      });
      
      // Also load when switching to settings tab
      const origShowView = window.showView;
      window.showView = function(viewId) {
          origShowView(viewId);
          if (viewId === 'settings') {
              loadSourceProfiles();
              populateTargetHosts();
          }
      };
    </script>
    <!-- File Browser Modal -->
    <div id="fileBrowserModal" class="modal-overlay" style="z-index: 10001;">
      <div class="modal" style="max-width: 800px; height: 80vh; display: flex; flex-direction: column;">
        <div class="modal-header">
          <h2 class="modal-title" id="fileBrowserTitle">Wybierz folder</h2>
          <button class="btn btn-ghost" onclick="closeFileBrowser()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="modal-body" style="flex: 1; overflow: hidden; display: flex; flex-direction: column; padding: 0;">
          <!-- Breadcrumbs and Controls -->
          <div style="padding: var(--spacing-md); border-bottom: 1px solid var(--color-border); background: var(--color-bg-secondary); display: flex; gap: var(--spacing-sm); align-items: center;">
            <button class="btn btn-secondary btn-sm" onclick="navigateBrowserOrder('up')" title="W górę">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 19V5M5 12l7-7 7 7"/>
              </svg>
            </button>
            <div id="fileBrowserBreadcrumbs" style="flex: 1; overflow-x: auto; white-space: nowrap; font-family: monospace; display: flex; align-items: center;">
              <!-- Breadcrumbs will be injected here -->
            </div>
            <button class="btn btn-ghost btn-sm" onclick="refreshFileBrowser()" title="Odśwież">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 4v6h-6"></path>
                    <path d="M1 20v-6h6"></path>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                </svg>
            </button>
          </div>

          <!-- File List -->
          <div id="fileBrowserList" style="flex: 1; overflow-y: auto; padding: var(--spacing-sm);">
            <!-- Items will be injected here -->
          </div>
          
           <!-- Loading Overlay -->
           <div id="fileBrowserLoading" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 10;">
             <div class="loading-spinner"></div>
           </div>
        </div>
        <div class="modal-footer" style="display: flex; justify-content: space-between; align-items: center;">
          <div style="flex: 1; margin-right: var(--spacing-md); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
             <span class="text-secondary" style="font-size: 12px;">Wybrano:</span>
             <span id="fileBrowserSelectedPath" style="font-weight: bold; font-family: monospace;"></span>
          </div>
          <div class="flex gap-sm">
            <button class="btn btn-ghost" onclick="closeFileBrowser()">Anuluj</button>
            <button class="btn btn-primary" onclick="confirmFileSelection()" id="fileBrowserConfirmBtn" disabled>Wybierz</button>
          </div>
        </div>
      </div>
    </div>

    <style>
      .fb-item {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        cursor: pointer;
        border-radius: var(--radius-sm);
        border: 1px solid transparent;
        transition: all 0.2s;
      }
      .fb-item:hover {
        background-color: var(--color-bg-secondary);
      }
      .fb-item.selected {
        background-color: rgba(var(--color-primary-rgb), 0.1);
        border-color: var(--color-primary);
      }
      .fb-icon {
        margin-right: 12px;
        color: var(--color-text-secondary);
        display: flex;
        align-items: center;
      }
      .fb-name {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .fb-meta {
        color: var(--color-text-secondary);
        font-size: 0.8em;
        margin-left: 8px;
      }
      .fb-breadcrumb-item {
        cursor: pointer;
        padding: 2px 6px;
        border-radius: 4px;
        color: var(--color-text-secondary);
      }
      .fb-breadcrumb-item:hover {
        background-color: var(--color-bg-tertiary);
        color: var(--color-text-primary);
      }
      .fb-breadcrumb-separator {
        color: var(--color-text-muted);
        margin: 0 4px;
      }
    </style>

    <script>
      let fbState = {
        currentPath: '/',
        selectedPath: null,
        targetInputId: null,
        mode: 'directory', // 'directory' or 'file'
        items: [],
        hostId: null,   // null = local browsing, string = remote host ID
        osType: 'linux', // 'linux' or 'windows'
        hostAddress: null,
        hostUser: null,
        hostSshOpts: '',
      };

      function openFileBrowser(
          inputId,
          mode = 'directory',
          hostId = null,
          osType = 'linux',
          hostAddress = null,
          hostUser = null,
          hostSshOpts = '',
      ) {
        fbState.targetInputId = inputId;
        fbState.mode = mode;
        fbState.selectedPath = null;
        fbState.hostId = hostId;
        fbState.osType = osType;
        fbState.hostAddress = hostAddress;
        fbState.hostUser = hostUser;
        fbState.hostSshOpts = hostSshOpts || '';
        
        // Try to get initial path from input
        const currentInputVal = document.getElementById(inputId)?.value;
        
        if (osType === 'windows') {
            // Windows paths start with drive letter like C:\
            fbState.currentPath = currentInputVal && /^[A-Za-z]:/.test(currentInputVal)
                ? currentInputVal : 'C:\\';
        } else {
            fbState.currentPath = currentInputVal && currentInputVal.startsWith('/')
                ? currentInputVal : '/';
        }
        
        const isRemoteBrowse = Boolean(hostId || (hostAddress && hostUser));
        const titleSuffix = isRemoteBrowse ? ' (zdalny)' : '';
        document.getElementById('fileBrowserTitle').textContent = 
            (mode === 'directory' ? 'Wybierz folder' : 'Wybierz plik') + titleSuffix;
        document.getElementById('fileBrowserConfirmBtn').textContent = mode === 'directory' ? 'Wybierz ten folder' : 'Wybierz plik';
        document.getElementById('fileBrowserModal').classList.add('visible');
        
        navigateBrowser(fbState.currentPath);
        updateSelectionDisplay();
      }

      function closeFileBrowser() {
        document.getElementById('fileBrowserModal').classList.remove('visible');
      }

      function refreshFileBrowser() {
        navigateBrowser(fbState.currentPath);
      }

      function _isRootPath(path) {
          if (fbState.osType === 'windows') {
              // C:\ is root
              return /^[A-Za-z]:\\?$/.test(path.replace(/\//g, '\\'));
          }
          return path === '/';
      }

      function navigateBrowserOrder(direction) {
          if (direction === 'up' && !_isRootPath(fbState.currentPath)) {
               navigateBrowser(fbState.currentParent || (fbState.osType === 'windows' ? 'C:\\' : '/'));
          }
      }

      async function navigateBrowser(path) {
        const loading = document.getElementById('fileBrowserLoading');
        loading.style.display = 'flex';
        const list = document.getElementById('fileBrowserList');
        
        try {
            const encodedPath = encodeURIComponent(path);
            let url;
            
            if (fbState.hostId || (fbState.hostAddress && fbState.hostUser)) {
                // Remote host browsing
                const query = new URLSearchParams();
                query.set("path", path);
                query.set("os_type", fbState.osType);
                if (fbState.hostId) {
                    query.set("host_id", fbState.hostId);
                } else {
                    query.set("host", fbState.hostAddress);
                    query.set("user", fbState.hostUser);
                    if (fbState.hostSshOpts) {
                        query.set("ssh_opts", fbState.hostSshOpts);
                    }
                }
                url = `/api/browse-directory?${query.toString()}`;
            } else {
                // Local browsing
                url = `/api/browse?path=${encodedPath}`;
            }
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.error || data.detail) {
                showToast('error', 'Błąd', data.error || data.detail);
                const rootPath = fbState.osType === 'windows' ? 'C:\\' : '/';
                if (path !== rootPath) navigateBrowser(rootPath);
                return;
            }

            fbState.currentPath = data.path;
            fbState.currentParent = data.parent; // Store parent for "Up" button
            fbState.items = data.items;
            
            renderBrowser(data);
            
            // If in directory mode, automatically select the current directory (optional, or wait for user to click "Select Current")
            // Actually UX pattern: 
            // - If "Select Folder": User enters details of folder, clicks "Select This Folder". 
            // - OR User clicks a folder in list to enter it.
            // - To select a folder, you usually have to be inside it or select it from list.
            // Let's implement: Selection connects to what is highlighted or current path.
            
            // Auto-select current path in directory mode? 
            if (fbState.mode === 'directory') {
                selectBrowserItem(data.path, 'directory', true); 
            } else {
                 // In file mode, clear selection when navigating directory
                 fbState.selectedPath = null;
                 updateSelectionDisplay();
            }

        } catch (e) {
            console.error(e);
            showToast('error', 'Błąd', 'Nie uda\u0142o si\u0119 pobra\u0107 listy plik\u00f3w');
        } finally {
            loading.style.display = 'none';
        }
      }
      
      function renderBrowser(data) {
          // Render Breadcrumbs
          const breadcrumbs = document.getElementById('fileBrowserBreadcrumbs');
          breadcrumbs.innerHTML = '';
          
          const isWindows = fbState.osType === 'windows';
          const sep = isWindows ? '\\' : '/';
          
          if (isWindows) {
              // Windows: C:\Users\foo -> ["C:", "Users", "foo"]
              const normalized = data.path.replace(/\//g, '\\');
              const parts = normalized.split('\\').filter(p => p);
              
              // Drive root item
              if (parts.length > 0) {
                  const driveSpan = document.createElement('span');
                  driveSpan.className = 'fb-breadcrumb-item';
                  driveSpan.textContent = parts[0] + '\\';
                  driveSpan.onclick = () => navigateBrowser(parts[0] + '\\');
                  breadcrumbs.appendChild(driveSpan);
              }
              
              let currentBuild = parts[0];
              for (let i = 1; i < parts.length; i++) {
                  const separator = document.createElement('span');
                  separator.className = 'fb-breadcrumb-separator';
                  separator.textContent = '\\';
                  breadcrumbs.appendChild(separator);
                  
                  currentBuild += '\\' + parts[i];
                  const pathForThis = currentBuild;
                  
                  const span = document.createElement('span');
                  span.className = 'fb-breadcrumb-item';
                  span.textContent = parts[i];
                  span.onclick = () => navigateBrowser(pathForThis);
                  breadcrumbs.appendChild(span);
              }
          } else {
              // Linux: /home/user -> ["", "home", "user"]
              const parts = data.path.split('/').filter(p => p);
              
              const rootSpan = document.createElement('span');
              rootSpan.className = 'fb-breadcrumb-item';
              rootSpan.textContent = '/';
              rootSpan.onclick = () => navigateBrowser('/');
              breadcrumbs.appendChild(rootSpan);
              
              let currentBuild = '';
              parts.forEach((part, index) => {
                   const separator = document.createElement('span');
                   separator.className = 'fb-breadcrumb-separator';
                   separator.textContent = '/';
                   breadcrumbs.appendChild(separator);
                   
                   currentBuild += '/' + part;
                   const pathForThis = currentBuild;
                   
                   const span = document.createElement('span');
                   span.className = 'fb-breadcrumb-item';
                   span.textContent = part;
                   span.onclick = () => navigateBrowser(pathForThis);
                   breadcrumbs.appendChild(span);
              });
          }
          
          // Render List
          const list = document.getElementById('fileBrowserList');
          list.innerHTML = '';
          
          if (data.items.length === 0) {
              list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--color-text-secondary);">Folder jest pusty</div>';
              return;
          }
          
          // Sort: Directories first, then files
          const sortedItems = [...data.items].sort((a, b) => {
              if (a.is_dir === b.is_dir) return a.name.localeCompare(b.name);
              return a.is_dir ? -1 : 1;
          });
          
          sortedItems.forEach(item => {
              // Filter based on mode? 
              // If mode is 'directory', maybe we still show files but greyed out? Or hide them?
              // Let's show everything but only allow selecting relevant types.
              
              const div = document.createElement('div');
              div.className = 'fb-item';
              div.onclick = () => onBrowserItemClick(item);
              
              const icon = document.createElement('div');
              icon.className = 'fb-icon';
              icon.innerHTML = item.is_dir 
                ? `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-yellow-500"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>`
                : `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>`;
              
              const name = document.createElement('div');
              name.className = 'fb-name';
              name.textContent = item.name;
              
              div.appendChild(icon);
              div.appendChild(name);
              
              // Highlight if this is the selected path (for files)
              if (fbState.selectedPath === item.path) {
                  div.classList.add('selected');
              }
              
              list.appendChild(div);
          });
      }

      function onBrowserItemClick(item) {
          if (item.is_dir) {
              // Single click on directory: Just navigate into it? 
              // Or select it? 
              // Standard behavior: 
              // - Click dir -> Select it (if in dir mode)
              // - Double click dir -> Navigate
              // Let's simplify: Click -> Navigate
              navigateBrowser(item.path);
          } else {
              // Click file
              if (fbState.mode === 'file') {
                  selectBrowserItem(item.path, 'file');
                  
                  // Update UI selection highlight
                  document.querySelectorAll('.fb-item').forEach(el => el.classList.remove('selected'));
                  // We can't easily find the element again without ID, but re-render is overkill.
                  // Just trust logical selection for now.
                  fbState.selectedPath = item.path; // update state
                  updateSelectionDisplay();
                  
                  // Find and highlight
                  // (Skip visual update for now or implement better tracking)
                  // Re-render to show selection
                  // renderBrowser({path: fbState.currentPath, items: fbState.items, parent: fbState.currentParent}); 
                  // Let's do a quick hack to highlight
                  // actually easier to just set state and re-render or iterate
                  // leaving simple for now. 
              }
          }
      }
      
      function selectBrowserItem(path, type, isCurrentDir = false) {
          // If we are in directory mode, and we are "inside" the directory we want to select
          // isCurrentDir=true is used when we navigate to a folder.
          
          if (fbState.mode === 'directory') {
              fbState.selectedPath = path;
          } else if (fbState.mode === 'file' && type === 'file') {
              fbState.selectedPath = path;
          }
           updateSelectionDisplay();
      }

      function updateSelectionDisplay() {
          const display = document.getElementById('fileBrowserSelectedPath');
          display.textContent = fbState.selectedPath || '';
          
          const confirmBtn = document.getElementById('fileBrowserConfirmBtn');
          confirmBtn.disabled = !fbState.selectedPath;
      }
      
      function confirmFileSelection() {
          if (fbState.selectedPath && fbState.targetInputId) {
              const input = document.getElementById(fbState.targetInputId);
              if (input) {
                  input.value = fbState.selectedPath;
                  // Trigger change event if needed
                  input.dispatchEvent(new Event('change'));
                  input.dispatchEvent(new Event('input'));
              }
              closeFileBrowser();
          }
      }
    </script>
  </body>
</html>
